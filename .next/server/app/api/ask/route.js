/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/ask/route";
exports.ids = ["app/api/ask/route"];
exports.modules = {

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "../app-render/work-async-storage.external":
/*!*****************************************************************************!*\
  !*** external "next/dist/server/app-render/work-async-storage.external.js" ***!
  \*****************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/server/app-render/work-async-storage.external.js");

/***/ }),

/***/ "./work-unit-async-storage.external":
/*!**********************************************************************************!*\
  !*** external "next/dist/server/app-render/work-unit-async-storage.external.js" ***!
  \**********************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/server/app-render/work-unit-async-storage.external.js");

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

"use strict";
module.exports = require("fs");

/***/ }),

/***/ "http":
/*!***********************!*\
  !*** external "http" ***!
  \***********************/
/***/ ((module) => {

"use strict";
module.exports = require("http");

/***/ }),

/***/ "https":
/*!************************!*\
  !*** external "https" ***!
  \************************/
/***/ ((module) => {

"use strict";
module.exports = require("https");

/***/ }),

/***/ "path":
/*!***********************!*\
  !*** external "path" ***!
  \***********************/
/***/ ((module) => {

"use strict";
module.exports = require("path");

/***/ }),

/***/ "punycode":
/*!***************************!*\
  !*** external "punycode" ***!
  \***************************/
/***/ ((module) => {

"use strict";
module.exports = require("punycode");

/***/ }),

/***/ "stream":
/*!*************************!*\
  !*** external "stream" ***!
  \*************************/
/***/ ((module) => {

"use strict";
module.exports = require("stream");

/***/ }),

/***/ "url":
/*!**********************!*\
  !*** external "url" ***!
  \**********************/
/***/ ((module) => {

"use strict";
module.exports = require("url");

/***/ }),

/***/ "util":
/*!***********************!*\
  !*** external "util" ***!
  \***********************/
/***/ ((module) => {

"use strict";
module.exports = require("util");

/***/ }),

/***/ "worker_threads":
/*!*********************************!*\
  !*** external "worker_threads" ***!
  \*********************************/
/***/ ((module) => {

"use strict";
module.exports = require("worker_threads");

/***/ }),

/***/ "zlib":
/*!***********************!*\
  !*** external "zlib" ***!
  \***********************/
/***/ ((module) => {

"use strict";
module.exports = require("zlib");

/***/ }),

/***/ "node:fs":
/*!**************************!*\
  !*** external "node:fs" ***!
  \**************************/
/***/ ((module) => {

"use strict";
module.exports = require("node:fs");

/***/ }),

/***/ "node:stream":
/*!******************************!*\
  !*** external "node:stream" ***!
  \******************************/
/***/ ((module) => {

"use strict";
module.exports = require("node:stream");

/***/ }),

/***/ "node:stream/web":
/*!**********************************!*\
  !*** external "node:stream/web" ***!
  \**********************************/
/***/ ((module) => {

"use strict";
module.exports = require("node:stream/web");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fask%2Froute&page=%2Fapi%2Fask%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fask%2Froute.ts&appDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!*********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fask%2Froute&page=%2Fapi%2Fask%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fask%2Froute.ts&appDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \*********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   workAsyncStorage: () => (/* binding */ workAsyncStorage),\n/* harmony export */   workUnitAsyncStorage: () => (/* binding */ workUnitAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/route-kind */ \"(rsc)/./node_modules/next/dist/server/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var _Users_alex_WebstormProjects_personal_rag_agent_app_api_ask_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./app/api/ask/route.ts */ \"(rsc)/./app/api/ask/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/ask/route\",\n        pathname: \"/api/ask\",\n        filename: \"route\",\n        bundlePath: \"app/api/ask/route\"\n    },\n    resolvedPagePath: \"/Users/alex/WebstormProjects/personal-rag-agent/app/api/ask/route.ts\",\n    nextConfigOutput,\n    userland: _Users_alex_WebstormProjects_personal_rag_agent_app_api_ask_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIvaW5kZXguanM/bmFtZT1hcHAlMkZhcGklMkZhc2slMkZyb3V0ZSZwYWdlPSUyRmFwaSUyRmFzayUyRnJvdXRlJmFwcFBhdGhzPSZwYWdlUGF0aD1wcml2YXRlLW5leHQtYXBwLWRpciUyRmFwaSUyRmFzayUyRnJvdXRlLnRzJmFwcERpcj0lMkZVc2VycyUyRmFsZXglMkZXZWJzdG9ybVByb2plY3RzJTJGcGVyc29uYWwtcmFnLWFnZW50JTJGYXBwJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmcm9vdERpcj0lMkZVc2VycyUyRmFsZXglMkZXZWJzdG9ybVByb2plY3RzJTJGcGVyc29uYWwtcmFnLWFnZW50JmlzRGV2PXRydWUmdHNjb25maWdQYXRoPXRzY29uZmlnLmpzb24mYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEISIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUErRjtBQUN2QztBQUNxQjtBQUNvQjtBQUNqRztBQUNBO0FBQ0E7QUFDQSx3QkFBd0IseUdBQW1CO0FBQzNDO0FBQ0EsY0FBYyxrRUFBUztBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsWUFBWTtBQUNaLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQSxRQUFRLHNEQUFzRDtBQUM5RDtBQUNBLFdBQVcsNEVBQVc7QUFDdEI7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUMwRjs7QUFFMUYiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vPzczN2EiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwUm91dGVSb3V0ZU1vZHVsZSB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL3JvdXRlLW1vZHVsZXMvYXBwLXJvdXRlL21vZHVsZS5jb21waWxlZFwiO1xuaW1wb3J0IHsgUm91dGVLaW5kIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvcm91dGUta2luZFwiO1xuaW1wb3J0IHsgcGF0Y2hGZXRjaCBhcyBfcGF0Y2hGZXRjaCB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2xpYi9wYXRjaC1mZXRjaFwiO1xuaW1wb3J0ICogYXMgdXNlcmxhbmQgZnJvbSBcIi9Vc2Vycy9hbGV4L1dlYnN0b3JtUHJvamVjdHMvcGVyc29uYWwtcmFnLWFnZW50L2FwcC9hcGkvYXNrL3JvdXRlLnRzXCI7XG4vLyBXZSBpbmplY3QgdGhlIG5leHRDb25maWdPdXRwdXQgaGVyZSBzbyB0aGF0IHdlIGNhbiB1c2UgdGhlbSBpbiB0aGUgcm91dGVcbi8vIG1vZHVsZS5cbmNvbnN0IG5leHRDb25maWdPdXRwdXQgPSBcIlwiXG5jb25zdCByb3V0ZU1vZHVsZSA9IG5ldyBBcHBSb3V0ZVJvdXRlTW9kdWxlKHtcbiAgICBkZWZpbml0aW9uOiB7XG4gICAgICAgIGtpbmQ6IFJvdXRlS2luZC5BUFBfUk9VVEUsXG4gICAgICAgIHBhZ2U6IFwiL2FwaS9hc2svcm91dGVcIixcbiAgICAgICAgcGF0aG5hbWU6IFwiL2FwaS9hc2tcIixcbiAgICAgICAgZmlsZW5hbWU6IFwicm91dGVcIixcbiAgICAgICAgYnVuZGxlUGF0aDogXCJhcHAvYXBpL2Fzay9yb3V0ZVwiXG4gICAgfSxcbiAgICByZXNvbHZlZFBhZ2VQYXRoOiBcIi9Vc2Vycy9hbGV4L1dlYnN0b3JtUHJvamVjdHMvcGVyc29uYWwtcmFnLWFnZW50L2FwcC9hcGkvYXNrL3JvdXRlLnRzXCIsXG4gICAgbmV4dENvbmZpZ091dHB1dCxcbiAgICB1c2VybGFuZFxufSk7XG4vLyBQdWxsIG91dCB0aGUgZXhwb3J0cyB0aGF0IHdlIG5lZWQgdG8gZXhwb3NlIGZyb20gdGhlIG1vZHVsZS4gVGhpcyBzaG91bGRcbi8vIGJlIGVsaW1pbmF0ZWQgd2hlbiB3ZSd2ZSBtb3ZlZCB0aGUgb3RoZXIgcm91dGVzIHRvIHRoZSBuZXcgZm9ybWF0LiBUaGVzZVxuLy8gYXJlIHVzZWQgdG8gaG9vayBpbnRvIHRoZSByb3V0ZS5cbmNvbnN0IHsgd29ya0FzeW5jU3RvcmFnZSwgd29ya1VuaXRBc3luY1N0b3JhZ2UsIHNlcnZlckhvb2tzIH0gPSByb3V0ZU1vZHVsZTtcbmZ1bmN0aW9uIHBhdGNoRmV0Y2goKSB7XG4gICAgcmV0dXJuIF9wYXRjaEZldGNoKHtcbiAgICAgICAgd29ya0FzeW5jU3RvcmFnZSxcbiAgICAgICAgd29ya1VuaXRBc3luY1N0b3JhZ2VcbiAgICB9KTtcbn1cbmV4cG9ydCB7IHJvdXRlTW9kdWxlLCB3b3JrQXN5bmNTdG9yYWdlLCB3b3JrVW5pdEFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MsIHBhdGNoRmV0Y2gsICB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1hcHAtcm91dGUuanMubWFwIl0sIm5hbWVzIjpbXSwiaWdub3JlTGlzdCI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fask%2Froute&page=%2Fapi%2Fask%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fask%2Froute.ts&appDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-flight-client-entry-loader.js?server=true!":
/*!******************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-flight-client-entry-loader.js?server=true! ***!
  \******************************************************************************************************/
/***/ (() => {



/***/ }),

/***/ "(ssr)/./node_modules/next/dist/build/webpack/loaders/next-flight-client-entry-loader.js?server=true!":
/*!******************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-flight-client-entry-loader.js?server=true! ***!
  \******************************************************************************************************/
/***/ (() => {



/***/ }),

/***/ "(rsc)/./app/api/ask/route.ts":
/*!******************************!*\
  !*** ./app/api/ask/route.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   POST: () => (/* binding */ POST)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/next/dist/api/server.js\");\n/* harmony import */ var _supabase_supabase_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! @supabase/supabase-js */ \"(rsc)/./node_modules/@supabase/supabase-js/dist/module/index.js\");\n/* harmony import */ var openai__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! openai */ \"(rsc)/./node_modules/openai/index.mjs\");\n/* harmony import */ var _lib_modelProvider__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../../lib/modelProvider */ \"(rsc)/./lib/modelProvider.ts\");\n/* harmony import */ var _lib_prompt__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../../lib/prompt */ \"(rsc)/./lib/prompt.ts\");\n/* harmony import */ var _lib_perplexity__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../../lib/perplexity */ \"(rsc)/./lib/perplexity.ts\");\n\n\n\n\n\n\nconst openai = new openai__WEBPACK_IMPORTED_MODULE_4__[\"default\"]({\n    apiKey: process.env.OPENAI_API_KEY\n});\nfunction approxTokenLen(s) {\n    return Math.ceil(s.length / 4);\n}\nfunction dedupeAndMerge(matches) {\n    const seen = new Set();\n    const unique = [];\n    for (const m of matches){\n        const key = `${m.document_id}:${m.chunk_text.slice(0, 100)}`;\n        if (!seen.has(key)) {\n            seen.add(key);\n            unique.push(m);\n        }\n    }\n    return unique;\n}\nfunction cleanAndParseJSON(raw) {\n    try {\n        // Сначала пробуем распарсить как есть\n        return JSON.parse(raw);\n    } catch (e) {\n        // Если не получилось - чистим\n        let cleaned = raw.replace(/```json\\s*/gi, '').replace(/```\\s*/gi, '').trim();\n        // Ищем первый { или [\n        const jsonStart = cleaned.search(/[\\{\\[]/);\n        if (jsonStart > 0) {\n            cleaned = cleaned.substring(jsonStart);\n        }\n        // Пробуем найти последний } или ]\n        let lastBrace = cleaned.lastIndexOf('}');\n        let lastBracket = cleaned.lastIndexOf(']');\n        let jsonEnd = Math.max(lastBrace, lastBracket);\n        if (jsonEnd > 0) {\n            cleaned = cleaned.substring(0, jsonEnd + 1);\n        }\n        try {\n            return JSON.parse(cleaned);\n        } catch (e2) {\n            console.error('Failed to parse even after cleaning:', e2);\n            console.log('Cleaned string was:', cleaned.substring(0, 500));\n            // Возвращаем хотя бы текст ответа\n            const answerMatch = cleaned.match(/\"answer\"\\s*:\\s*\"([^\"]+)\"/);\n            if (answerMatch) {\n                return {\n                    answer: answerMatch[1].replace(/\\\\n/g, '\\n'),\n                    citations: [],\n                    insights: [],\n                    follow_up_questions: []\n                };\n            }\n            return null;\n        }\n    }\n}\nasync function POST(request) {\n    const t0 = Date.now();\n    try {\n        const supabase = (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_5__.createClient)(\"https://zqharntcylmxxdcvbtqi.supabase.co\", process.env.SUPABASE_SERVICE_ROLE_KEY);\n        const token = request.headers.get(\"authorization\")?.replace(\"Bearer \", \"\");\n        if (!token) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Не авторизован\"\n        }, {\n            status: 401\n        });\n        const { data: { user }, error: authError } = await supabase.auth.getUser(token);\n        if (authError || !user) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Не авторизован\"\n        }, {\n            status: 401\n        });\n        const body = await request.json();\n        const { question, provider, projectId, role, // НОВЫЕ параметры\n        clarificationAnswers, skipClarification, searchMode, domainFilter } = body;\n        let webSearchEnabled = body.webSearchEnabled;\n        let forceWebSearch = body.forceWebSearch;\n        if (!question?.trim()) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Вопрос не предоставлен\"\n            }, {\n                status: 400\n            });\n        }\n        console.log(`Вопрос: \"${question}\" | Проект: ${projectId} | Роль: ${role}`);\n        console.log(`Web Search: enabled=${webSearchEnabled}, forced=${forceWebSearch}`);\n        // Проверяем количество чанков\n        let countQuery = supabase.from(\"doc_chunks\").select(\"*\", {\n            count: \"exact\",\n            head: true\n        }).eq(\"user_id\", user.id);\n        if (projectId && projectId !== 'null') {\n            countQuery = countQuery.eq(\"project_id\", projectId);\n        }\n        const { count } = await countQuery;\n        // Получаем релевантные чанки (даже если их 0, для контекста)\n        let chunks = [];\n        let webContext = null;\n        if (count && count > 0) {\n            console.log(`Найдено ${count} чанков в проекте`);\n            // Генерация эмбеддинга\n            console.log('Генерация эмбеддинга...');\n            const embedRes = await openai.embeddings.create({\n                model: \"text-embedding-3-small\",\n                input: question\n            });\n            const queryEmbedding = embedRes.data[0].embedding;\n            // Поиск релевантных чанков\n            console.log('Поиск релевантных чанков...');\n            const { data: matches, error: matchError } = await supabase.rpc(\"match_doc_chunks\", {\n                query_embedding: queryEmbedding,\n                match_threshold: 0.25,\n                match_count: 15,\n                filter_user_id: user.id,\n                filter_project_id: projectId && projectId !== 'null' ? projectId : null\n            });\n            if (!matchError && matches?.length) {\n                const uniq = dedupeAndMerge(matches).slice(0, 10);\n                chunks = uniq.map((m)=>({\n                        doc_id: m.document_id,\n                        chunk_index: m.chunk_index ?? 0,\n                        similarity: m.similarity ?? 0,\n                        text: (m.chunk_text || \"\").slice(0, 2000)\n                    }));\n                console.log(`Найдено ${chunks.length} релевантных чанков`);\n            }\n        }\n        // ================== CLARIFICATION MODE ==================\n        // Проверяем необходимость уточнений (только если не пропущено и нет ответов)\n        if (!skipClarification && !clarificationAnswers) {\n            const clarificationCheck = (0,_lib_prompt__WEBPACK_IMPORTED_MODULE_2__.analyzeClarificationNeed)(question, chunks, role);\n            if (clarificationCheck.needed) {\n                console.log('Требуются уточнения:', clarificationCheck.questions);\n                // Проверяем, нужен ли web search как одно из уточнений\n                if (!webSearchEnabled && chunks.length === 0) {\n                    clarificationCheck.questions?.push({\n                        id: 'enable_web_search',\n                        question: 'В документах нет релевантной информации. Искать ответ в интернете?',\n                        type: 'boolean',\n                        required: false,\n                        context: 'Поиск в интернете поможет найти актуальную информацию'\n                    });\n                }\n                return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                    mode: 'needs_clarification',\n                    clarifications: clarificationCheck.questions,\n                    partialInsight: clarificationCheck.preliminaryInsight,\n                    originalQuestion: question,\n                    documentsFound: chunks.length\n                });\n            }\n        }\n        // Обогащаем вопрос уточнениями если они есть\n        let finalQuestion = question;\n        if (clarificationAnswers) {\n            finalQuestion = (0,_lib_prompt__WEBPACK_IMPORTED_MODULE_2__.mergeQuestionWithClarifications)(question, clarificationAnswers);\n            console.log('Обогащенный вопрос:', finalQuestion);\n            // Проверяем, не включил ли пользователь web search через уточнения\n            if (clarificationAnswers.search_web === true || clarificationAnswers.enable_web_search === true) {\n                webSearchEnabled = true;\n                forceWebSearch = true;\n                console.log('Web search включен через уточнения');\n            }\n        }\n        // ================== SMART WEB SEARCH ==================\n        // Определяем, нужен ли web search\n        const needsWeb = webSearchEnabled && (forceWebSearch || (0,_lib_perplexity__WEBPACK_IMPORTED_MODULE_3__.shouldSearchWeb)(finalQuestion, chunks, false) || chunks.length === 0);\n        if (needsWeb) {\n            console.log('🌐 Выполняем web search...');\n            try {\n                // Парсим domain filter\n                const domainFilterArray = domainFilter ? domainFilter.split(',').map((d)=>d.trim()).filter(Boolean) : undefined;\n                const webEnrichment = await (0,_lib_perplexity__WEBPACK_IMPORTED_MODULE_3__.enrichWithWebSearch)(finalQuestion, chunks, {\n                    searchRecencyFilter: detectTimeFilter(finalQuestion),\n                    searchMode: searchMode || 'web',\n                    searchDomainFilter: domainFilterArray,\n                    role: role,\n                    returnImages: true,\n                    returnRelated: true\n                });\n                webContext = webEnrichment;\n                console.log('✅ Web search завершен');\n                console.log(`   - Источников: ${webEnrichment.webSources?.length || 0}`);\n                console.log(`   - Изображений: ${webEnrichment.webImages?.length || 0}`);\n                console.log(`   - Связанных вопросов: ${webEnrichment.relatedQuestions?.length || 0}`);\n                console.log(`   - Модель: ${webEnrichment.model}`);\n            } catch (webError) {\n                console.error('⚠️ Web search failed:', webError);\n            // Продолжаем без web context\n            }\n        }\n        // Если нет ни документов, ни web результатов\n        if (!chunks.length && !webContext) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                answer: \"Не нашёл информации ни в документах проекта, ни в интернете. Попробуйте переформулировать вопрос или загрузить релевантные документы.\",\n                question,\n                sources: [],\n                webSources: [],\n                insights: [],\n                follow_up_questions: [\n                    \"Загрузить документы по этой теме?\",\n                    \"Включить расширенный поиск?\"\n                ]\n            });\n        }\n        // ================== ПОДГОТОВКА ПРОМПТА ==================\n        const ctxTokens = approxTokenLen(chunks.map((c)=>c.text).join(\" \"));\n        const providerFinal = provider ?? (ctxTokens > 120000 ? \"anthropic\" : \"openai\");\n        console.log(`Используется провайдер: ${providerFinal}, контекст: ${ctxTokens} токенов`);\n        // Формируем системный промпт с ролью\n        let systemPrompt = _lib_prompt__WEBPACK_IMPORTED_MODULE_2__.SYSTEM_RAG;\n        if (role && role !== 'analyst') {\n            const rolePrefix = role === 'custom' ? role : `ROLE: ${role}\\n\\n`;\n            systemPrompt = `${rolePrefix}${_lib_prompt__WEBPACK_IMPORTED_MODULE_2__.SYSTEM_RAG}`;\n        }\n        // Добавляем инструкции для web context\n        if (webContext) {\n            systemPrompt += `\\n\\nWEB SEARCH INTEGRATION:\n- You have access to both document context and real-time web search results\n- Clearly distinguish between information from documents vs web\n- Prioritize recent web data for current events and market information\n- Cross-validate facts between sources when possible`;\n        }\n        // Строим промпт с комбинированным контекстом\n        const userPrompt = buildEnhancedUserPrompt(finalQuestion, chunks, webContext, clarificationAnswers);\n        console.log('Запрос к модели...');\n        const raw = await (0,_lib_modelProvider__WEBPACK_IMPORTED_MODULE_1__.chatWithProvider)(providerFinal, {\n            system: systemPrompt,\n            user: userPrompt,\n            maxTokens: 8000\n        });\n        console.log(`Raw ответ (первые 200 символов):`, raw.substring(0, 200));\n        // Парсим JSON из ответа модели\n        let parsed = cleanAndParseJSON(raw);\n        if (!parsed) {\n            console.log('JSON парсинг не удался, используем raw текст');\n            parsed = {\n                answer: raw,\n                citations: [],\n                insights: [],\n                follow_up_questions: []\n            };\n        }\n        // Извлекаем данные\n        const answer = parsed.answer || \"Ошибка: не удалось получить ответ\";\n        const citations = parsed.citations || chunks.slice(0, 3).map((c)=>({\n                doc_id: c.doc_id,\n                chunk_index: c.chunk_index,\n                similarity: c.similarity,\n                quote: c.text.slice(0, 200)\n            }));\n        // Добавляем web источники и дополнительные данные если есть\n        const webSources = webContext?.webSources || [];\n        const webImages = webContext?.webImages || [];\n        const relatedQuestions = webContext?.relatedQuestions || [];\n        const insights = parsed.insights || [];\n        // Объединяем follow_up вопросы из модели и из Perplexity\n        let follow_up_questions = parsed.follow_up_questions || [];\n        if (relatedQuestions.length > 0) {\n            follow_up_questions = [\n                ...follow_up_questions,\n                ...relatedQuestions\n            ].slice(0, 5);\n        }\n        console.log(`Ответ получен. Answer: ${answer.length} chars, Web sources: ${webSources.length}, Images: ${webImages.length}`);\n        const latency = Date.now() - t0;\n        // Сохраняем сообщения с расширенными метаданными\n        await supabase.from(\"messages\").insert([\n            {\n                user_id: user.id,\n                role: \"user\",\n                content: question,\n                project_id: projectId && projectId !== 'null' ? projectId : null\n            },\n            {\n                user_id: user.id,\n                role: \"assistant\",\n                content: answer,\n                project_id: projectId && projectId !== 'null' ? projectId : null,\n                metadata: {\n                    provider: providerFinal,\n                    latency_ms: latency,\n                    sources: citations,\n                    webSources,\n                    webImages,\n                    insights,\n                    follow_up_questions,\n                    usedWebSearch: !!webContext,\n                    perplexityModel: webContext?.model,\n                    hadClarifications: !!clarificationAnswers\n                }\n            }\n        ]);\n        // Возвращаем расширенный ответ\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            answer,\n            question,\n            sources: citations,\n            webSources,\n            webImages,\n            insights,\n            follow_up_questions,\n            provider: providerFinal,\n            perplexityModel: webContext?.model,\n            latency_ms: latency,\n            usedWebSearch: !!webContext\n        });\n    } catch (err) {\n        console.error('Error in /api/ask:', err);\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: err?.message || \"Unknown error\",\n            answer: \"Произошла ошибка при обработке запроса. Попробуйте еще раз.\",\n            sources: [],\n            webSources: [],\n            webImages: [],\n            insights: [],\n            follow_up_questions: []\n        }, {\n            status: 500\n        });\n    }\n}\n// ================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==================\n// Определение временного фильтра для web search\nfunction detectTimeFilter(question) {\n    const lowerQ = question.toLowerCase();\n    if (lowerQ.includes('сегодня') || lowerQ.includes('today')) return 'day';\n    if (lowerQ.includes('неделе') || lowerQ.includes('week')) return 'week';\n    if (lowerQ.includes('месяц') || lowerQ.includes('month')) return 'month';\n    if (lowerQ.includes('год') || lowerQ.includes('year')) return 'year';\n    return undefined;\n}\n// Расширенная функция построения промпта с web context\nfunction buildEnhancedUserPrompt(question, documentChunks, webContext, clarificationAnswers) {\n    let prompt = '';\n    // Добавляем контекст из документов\n    if (documentChunks.length > 0) {\n        prompt += 'DOCUMENT CONTEXT:\\n';\n        prompt += documentChunks.map((c, i)=>`[Doc ${i + 1}] (Similarity: ${(c.similarity * 100).toFixed(1)}%)\\n${c.text}\\n`).join('\\n---\\n');\n    }\n    // Добавляем web контекст\n    if (webContext) {\n        prompt += '\\n\\nWEB SEARCH RESULTS (Real-time):\\n';\n        prompt += webContext.webAnswer || '';\n        if (webContext.webSources?.length > 0) {\n            prompt += '\\n\\nWeb Sources:\\n';\n            prompt += webContext.webSources.map((s)=>`- ${s.title || s.url}`).join('\\n');\n        }\n    }\n    // Добавляем уточнения\n    if (clarificationAnswers) {\n        prompt += '\\n\\nUSER CLARIFICATIONS:\\n';\n        prompt += Object.entries(clarificationAnswers).map(([key, value])=>`${key}: ${value}`).join('\\n');\n    }\n    prompt += `\\n\\nUSER QUESTION:\\n${question}\\n\\n`;\n    prompt += 'Provide a comprehensive answer using both document and web context where available. ';\n    prompt += 'Clearly indicate which information comes from documents vs web sources.';\n    return prompt;\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUFLLEdBQUdoSyxJQUFJLEVBQUUsRUFBRWdLLE9BQU8sRUFDeENsQyxJQUFJLENBQUM7SUFDWjtJQUVBMEIsVUFBVSxDQUFDLG9CQUFvQixFQUFFcEcsU0FBUyxJQUFJLENBQUM7SUFDL0NvRyxVQUFVO0lBQ1ZBLFVBQVU7SUFFVixPQUFPQTtBQUNUIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vLy4vYXBwL2FwaS9hc2svcm91dGUudHM/YjllZSJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOZXh0UmVxdWVzdCwgTmV4dFJlc3BvbnNlIH0gZnJvbSBcIm5leHQvc2VydmVyXCI7XG5pbXBvcnQgeyBjcmVhdGVDbGllbnQgfSBmcm9tIFwiQHN1cGFiYXNlL3N1cGFiYXNlLWpzXCI7XG5pbXBvcnQgT3BlbkFJIGZyb20gXCJvcGVuYWlcIjtcbmltcG9ydCB7IGNoYXRXaXRoUHJvdmlkZXIgfSBmcm9tIFwiLi4vLi4vLi4vbGliL21vZGVsUHJvdmlkZXJcIjtcbmltcG9ydCB7XG4gIFNZU1RFTV9SQUcsXG4gIGJ1aWxkVXNlclByb21wdCxcbiAgYW5hbHl6ZUNsYXJpZmljYXRpb25OZWVkLFxuICBtZXJnZVF1ZXN0aW9uV2l0aENsYXJpZmljYXRpb25zLFxuICBDbGFyaWZpY2F0aW9uUXVlc3Rpb25cbn0gZnJvbSBcIi4uLy4uLy4uL2xpYi9wcm9tcHRcIjtcbmltcG9ydCB7XG4gIFBlcnBsZXhpdHlDbGllbnQsXG4gIHNob3VsZFNlYXJjaFdlYixcbiAgZW5yaWNoV2l0aFdlYlNlYXJjaFxufSBmcm9tIFwiLi4vLi4vLi4vbGliL3BlcnBsZXhpdHlcIjtcblxuY29uc3Qgb3BlbmFpID0gbmV3IE9wZW5BSSh7IGFwaUtleTogcHJvY2Vzcy5lbnYuT1BFTkFJX0FQSV9LRVkgfSk7XG5cbmZ1bmN0aW9uIGFwcHJveFRva2VuTGVuKHM6IHN0cmluZykge1xuICByZXR1cm4gTWF0aC5jZWlsKHMubGVuZ3RoIC8gNCk7XG59XG5cbmZ1bmN0aW9uIGRlZHVwZUFuZE1lcmdlKG1hdGNoZXM6IGFueVtdKSB7XG4gIGNvbnN0IHNlZW4gPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgY29uc3QgdW5pcXVlID0gW107XG4gIGZvciAoY29uc3QgbSBvZiBtYXRjaGVzKSB7XG4gICAgY29uc3Qga2V5ID0gYCR7bS5kb2N1bWVudF9pZH06JHttLmNodW5rX3RleHQuc2xpY2UoMCwgMTAwKX1gO1xuICAgIGlmICghc2Vlbi5oYXMoa2V5KSkge1xuICAgICAgc2Vlbi5hZGQoa2V5KTtcbiAgICAgIHVuaXF1ZS5wdXNoKG0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gdW5pcXVlO1xufVxuXG5mdW5jdGlvbiBjbGVhbkFuZFBhcnNlSlNPTihyYXc6IHN0cmluZyk6IGFueSB7XG4gIHRyeSB7XG4gICAgLy8g0KHQvdCw0YfQsNC70LAg0L/RgNC+0LHRg9C10Lwg0YDQsNGB0L/QsNGA0YHQuNGC0Ywg0LrQsNC6INC10YHRgtGMXG4gICAgcmV0dXJuIEpTT04ucGFyc2UocmF3KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vINCV0YHQu9C4INC90LUg0L/QvtC70YPRh9C40LvQvtGB0YwgLSDRh9C40YHRgtC40LxcbiAgICBsZXQgY2xlYW5lZCA9IHJhd1xuICAgICAgICAucmVwbGFjZSgvYGBganNvblxccyovZ2ksICcnKVxuICAgICAgICAucmVwbGFjZSgvYGBgXFxzKi9naSwgJycpXG4gICAgICAgIC50cmltKCk7XG5cbiAgICAvLyDQmNGJ0LXQvCDQv9C10YDQstGL0LkgeyDQuNC70LggW1xuICAgIGNvbnN0IGpzb25TdGFydCA9IGNsZWFuZWQuc2VhcmNoKC9bXFx7XFxbXS8pO1xuICAgIGlmIChqc29uU3RhcnQgPiAwKSB7XG4gICAgICBjbGVhbmVkID0gY2xlYW5lZC5zdWJzdHJpbmcoanNvblN0YXJ0KTtcbiAgICB9XG5cbiAgICAvLyDQn9GA0L7QsdGD0LXQvCDQvdCw0LnRgtC4INC/0L7RgdC70LXQtNC90LjQuSB9INC40LvQuCBdXG4gICAgbGV0IGxhc3RCcmFjZSA9IGNsZWFuZWQubGFzdEluZGV4T2YoJ30nKTtcbiAgICBsZXQgbGFzdEJyYWNrZXQgPSBjbGVhbmVkLmxhc3RJbmRleE9mKCddJyk7XG4gICAgbGV0IGpzb25FbmQgPSBNYXRoLm1heChsYXN0QnJhY2UsIGxhc3RCcmFja2V0KTtcblxuICAgIGlmIChqc29uRW5kID4gMCkge1xuICAgICAgY2xlYW5lZCA9IGNsZWFuZWQuc3Vic3RyaW5nKDAsIGpzb25FbmQgKyAxKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIEpTT04ucGFyc2UoY2xlYW5lZCk7XG4gICAgfSBjYXRjaCAoZTIpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBwYXJzZSBldmVuIGFmdGVyIGNsZWFuaW5nOicsIGUyKTtcbiAgICAgIGNvbnNvbGUubG9nKCdDbGVhbmVkIHN0cmluZyB3YXM6JywgY2xlYW5lZC5zdWJzdHJpbmcoMCwgNTAwKSk7XG5cbiAgICAgIC8vINCS0L7Qt9Cy0YDQsNGJ0LDQtdC8INGF0L7RgtGPINCx0Ysg0YLQtdC60YHRgiDQvtGC0LLQtdGC0LBcbiAgICAgIGNvbnN0IGFuc3dlck1hdGNoID0gY2xlYW5lZC5tYXRjaCgvXCJhbnN3ZXJcIlxccyo6XFxzKlwiKFteXCJdKylcIi8pO1xuICAgICAgaWYgKGFuc3dlck1hdGNoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgYW5zd2VyOiBhbnN3ZXJNYXRjaFsxXS5yZXBsYWNlKC9cXFxcbi9nLCAnXFxuJyksXG4gICAgICAgICAgY2l0YXRpb25zOiBbXSxcbiAgICAgICAgICBpbnNpZ2h0czogW10sXG4gICAgICAgICAgZm9sbG93X3VwX3F1ZXN0aW9uczogW11cbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBQT1NUKHJlcXVlc3Q6IE5leHRSZXF1ZXN0KSB7XG4gIGNvbnN0IHQwID0gRGF0ZS5ub3coKTtcblxuICB0cnkge1xuICAgIGNvbnN0IHN1cGFiYXNlID0gY3JlYXRlQ2xpZW50KFxuICAgICAgICBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwhLFxuICAgICAgICBwcm9jZXNzLmVudi5TVVBBQkFTRV9TRVJWSUNFX1JPTEVfS0VZIVxuICAgICk7XG5cbiAgICBjb25zdCB0b2tlbiA9IHJlcXVlc3QuaGVhZGVycy5nZXQoXCJhdXRob3JpemF0aW9uXCIpPy5yZXBsYWNlKFwiQmVhcmVyIFwiLCBcIlwiKTtcbiAgICBpZiAoIXRva2VuKSByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogXCLQndC1INCw0LLRgtC+0YDQuNC30L7QstCw0L1cIiB9LCB7IHN0YXR1czogNDAxIH0pO1xuXG4gICAgY29uc3QgeyBkYXRhOiB7IHVzZXIgfSwgZXJyb3I6IGF1dGhFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UuYXV0aC5nZXRVc2VyKHRva2VuKTtcbiAgICBpZiAoYXV0aEVycm9yIHx8ICF1c2VyKSByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogXCLQndC1INCw0LLRgtC+0YDQuNC30L7QstCw0L1cIiB9LCB7IHN0YXR1czogNDAxIH0pO1xuXG4gICAgY29uc3QgYm9keSA9IGF3YWl0IHJlcXVlc3QuanNvbigpO1xuICAgIGNvbnN0IHtcbiAgICAgIHF1ZXN0aW9uLFxuICAgICAgcHJvdmlkZXIsXG4gICAgICBwcm9qZWN0SWQsXG4gICAgICByb2xlLFxuICAgICAgLy8g0J3QntCS0KvQlSDQv9Cw0YDQsNC80LXRgtGA0YtcbiAgICAgIGNsYXJpZmljYXRpb25BbnN3ZXJzLCAgLy8g0J7RgtCy0LXRgtGLINC90LAg0YPRgtC+0YfQvdC10L3QuNGPXG4gICAgICBza2lwQ2xhcmlmaWNhdGlvbiwgICAgIC8vINCf0YDQvtC/0YPRgdGC0LjRgtGMINGD0YLQvtGH0L3QtdC90LjRj1xuICAgICAgc2VhcmNoTW9kZSwgICAgICAgICAgICAvLyB3ZWIvYWNhZGVtaWMvc2VjXG4gICAgICBkb21haW5GaWx0ZXIsICAgICAgICAgIC8vINCk0LjQu9GM0YLRgCDQtNC+0LzQtdC90L7QslxuICAgIH0gPSBib2R5O1xuICAgIGxldCB3ZWJTZWFyY2hFbmFibGVkID0gYm9keS53ZWJTZWFyY2hFbmFibGVkO1xuICAgIGxldCBmb3JjZVdlYlNlYXJjaCA9IGJvZHkuZm9yY2VXZWJTZWFyY2g7XG4gICAgaWYgKCFxdWVzdGlvbj8udHJpbSgpKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogXCLQktC+0L/RgNC+0YEg0L3QtSDQv9GA0LXQtNC+0YHRgtCw0LLQu9C10L1cIiB9LCB7IHN0YXR1czogNDAwIH0pO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGDQktC+0L/RgNC+0YE6IFwiJHtxdWVzdGlvbn1cIiB8INCf0YDQvtC10LrRgjogJHtwcm9qZWN0SWR9IHwg0KDQvtC70Yw6ICR7cm9sZX1gKTtcbiAgICBjb25zb2xlLmxvZyhgV2ViIFNlYXJjaDogZW5hYmxlZD0ke3dlYlNlYXJjaEVuYWJsZWR9LCBmb3JjZWQ9JHtmb3JjZVdlYlNlYXJjaH1gKTtcblxuICAgIC8vINCf0YDQvtCy0LXRgNGP0LXQvCDQutC+0LvQuNGH0LXRgdGC0LLQviDRh9Cw0L3QutC+0LJcbiAgICBsZXQgY291bnRRdWVyeSA9IHN1cGFiYXNlXG4gICAgICAgIC5mcm9tKFwiZG9jX2NodW5rc1wiKVxuICAgICAgICAuc2VsZWN0KFwiKlwiLCB7IGNvdW50OiBcImV4YWN0XCIsIGhlYWQ6IHRydWUgfSlcbiAgICAgICAgLmVxKFwidXNlcl9pZFwiLCB1c2VyLmlkKTtcblxuICAgIGlmIChwcm9qZWN0SWQgJiYgcHJvamVjdElkICE9PSAnbnVsbCcpIHtcbiAgICAgIGNvdW50UXVlcnkgPSBjb3VudFF1ZXJ5LmVxKFwicHJvamVjdF9pZFwiLCBwcm9qZWN0SWQpO1xuICAgIH1cblxuICAgIGNvbnN0IHsgY291bnQgfSA9IGF3YWl0IGNvdW50UXVlcnk7XG5cbiAgICAvLyDQn9C+0LvRg9GH0LDQtdC8INGA0LXQu9C10LLQsNC90YLQvdGL0LUg0YfQsNC90LrQuCAo0LTQsNC20LUg0LXRgdC70Lgg0LjRhSAwLCDQtNC70Y8g0LrQvtC90YLQtdC60YHRgtCwKVxuICAgIGxldCBjaHVua3M6IGFueVtdID0gW107XG4gICAgbGV0IHdlYkNvbnRleHQ6IGFueSA9IG51bGw7XG5cbiAgICBpZiAoY291bnQgJiYgY291bnQgPiAwKSB7XG4gICAgICBjb25zb2xlLmxvZyhg0J3QsNC50LTQtdC90L4gJHtjb3VudH0g0YfQsNC90LrQvtCyINCyINC/0YDQvtC10LrRgtC1YCk7XG5cbiAgICAgIC8vINCT0LXQvdC10YDQsNGG0LjRjyDRjdC80LHQtdC00LTQuNC90LPQsFxuICAgICAgY29uc29sZS5sb2coJ9CT0LXQvdC10YDQsNGG0LjRjyDRjdC80LHQtdC00LTQuNC90LPQsC4uLicpO1xuICAgICAgY29uc3QgZW1iZWRSZXMgPSBhd2FpdCBvcGVuYWkuZW1iZWRkaW5ncy5jcmVhdGUoe1xuICAgICAgICBtb2RlbDogXCJ0ZXh0LWVtYmVkZGluZy0zLXNtYWxsXCIsXG4gICAgICAgIGlucHV0OiBxdWVzdGlvblxuICAgICAgfSk7XG4gICAgICBjb25zdCBxdWVyeUVtYmVkZGluZyA9IGVtYmVkUmVzLmRhdGFbMF0uZW1iZWRkaW5nO1xuXG4gICAgICAvLyDQn9C+0LjRgdC6INGA0LXQu9C10LLQsNC90YLQvdGL0YUg0YfQsNC90LrQvtCyXG4gICAgICBjb25zb2xlLmxvZygn0J/QvtC40YHQuiDRgNC10LvQtdCy0LDQvdGC0L3Ri9GFINGH0LDQvdC60L7Qsi4uLicpO1xuICAgICAgY29uc3QgeyBkYXRhOiBtYXRjaGVzLCBlcnJvcjogbWF0Y2hFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UucnBjKFwibWF0Y2hfZG9jX2NodW5rc1wiLCB7XG4gICAgICAgIHF1ZXJ5X2VtYmVkZGluZzogcXVlcnlFbWJlZGRpbmcsXG4gICAgICAgIG1hdGNoX3RocmVzaG9sZDogMC4yNSxcbiAgICAgICAgbWF0Y2hfY291bnQ6IDE1LFxuICAgICAgICBmaWx0ZXJfdXNlcl9pZDogdXNlci5pZCxcbiAgICAgICAgZmlsdGVyX3Byb2plY3RfaWQ6IHByb2plY3RJZCAmJiBwcm9qZWN0SWQgIT09ICdudWxsJyA/IHByb2plY3RJZCA6IG51bGxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIW1hdGNoRXJyb3IgJiYgbWF0Y2hlcz8ubGVuZ3RoKSB7XG4gICAgICAgIGNvbnN0IHVuaXEgPSBkZWR1cGVBbmRNZXJnZShtYXRjaGVzKS5zbGljZSgwLCAxMCk7XG4gICAgICAgIGNodW5rcyA9IHVuaXEubWFwKChtOiBhbnkpID0+ICh7XG4gICAgICAgICAgZG9jX2lkOiBtLmRvY3VtZW50X2lkLFxuICAgICAgICAgIGNodW5rX2luZGV4OiBtLmNodW5rX2luZGV4ID8/IDAsXG4gICAgICAgICAgc2ltaWxhcml0eTogbS5zaW1pbGFyaXR5ID8/IDAsXG4gICAgICAgICAgdGV4dDogKG0uY2h1bmtfdGV4dCB8fCBcIlwiKS5zbGljZSgwLCAyMDAwKVxuICAgICAgICB9KSk7XG4gICAgICAgIGNvbnNvbGUubG9nKGDQndCw0LnQtNC10L3QviAke2NodW5rcy5sZW5ndGh9INGA0LXQu9C10LLQsNC90YLQvdGL0YUg0YfQsNC90LrQvtCyYCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gPT09PT09PT09PT09PT09PT09IENMQVJJRklDQVRJT04gTU9ERSA9PT09PT09PT09PT09PT09PT1cbiAgICAvLyDQn9GA0L7QstC10YDRj9C10Lwg0L3QtdC+0LHRhdC+0LTQuNC80L7RgdGC0Ywg0YPRgtC+0YfQvdC10L3QuNC5ICjRgtC+0LvRjNC60L4g0LXRgdC70Lgg0L3QtSDQv9GA0L7Qv9GD0YnQtdC90L4g0Lgg0L3QtdGCINC+0YLQstC10YLQvtCyKVxuICAgIGlmICghc2tpcENsYXJpZmljYXRpb24gJiYgIWNsYXJpZmljYXRpb25BbnN3ZXJzKSB7XG4gICAgICBjb25zdCBjbGFyaWZpY2F0aW9uQ2hlY2sgPSBhbmFseXplQ2xhcmlmaWNhdGlvbk5lZWQoXG4gICAgICAgICAgcXVlc3Rpb24sXG4gICAgICAgICAgY2h1bmtzLFxuICAgICAgICAgIHJvbGVcbiAgICAgICk7XG5cbiAgICAgIGlmIChjbGFyaWZpY2F0aW9uQ2hlY2submVlZGVkKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCfQotGA0LXQsdGD0Y7RgtGB0Y8g0YPRgtC+0YfQvdC10L3QuNGPOicsIGNsYXJpZmljYXRpb25DaGVjay5xdWVzdGlvbnMpO1xuXG4gICAgICAgIC8vINCf0YDQvtCy0LXRgNGP0LXQvCwg0L3Rg9C20LXQvSDQu9C4IHdlYiBzZWFyY2gg0LrQsNC6INC+0LTQvdC+INC40Lcg0YPRgtC+0YfQvdC10L3QuNC5XG4gICAgICAgIGlmICghd2ViU2VhcmNoRW5hYmxlZCAmJiBjaHVua3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgY2xhcmlmaWNhdGlvbkNoZWNrLnF1ZXN0aW9ucz8ucHVzaCh7XG4gICAgICAgICAgICBpZDogJ2VuYWJsZV93ZWJfc2VhcmNoJyxcbiAgICAgICAgICAgIHF1ZXN0aW9uOiAn0JIg0LTQvtC60YPQvNC10L3RgtCw0YUg0L3QtdGCINGA0LXQu9C10LLQsNC90YLQvdC+0Lkg0LjQvdGE0L7RgNC80LDRhtC40LguINCY0YHQutCw0YLRjCDQvtGC0LLQtdGCINCyINC40L3RgtC10YDQvdC10YLQtT8nLFxuICAgICAgICAgICAgdHlwZTogJ2Jvb2xlYW4nLFxuICAgICAgICAgICAgcmVxdWlyZWQ6IGZhbHNlLFxuICAgICAgICAgICAgY29udGV4dDogJ9Cf0L7QuNGB0Log0LIg0LjQvdGC0LXRgNC90LXRgtC1INC/0L7QvNC+0LbQtdGCINC90LDQudGC0Lgg0LDQutGC0YPQsNC70YzQvdGD0Y4g0LjQvdGE0L7RgNC80LDRhtC40Y4nXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgICAgIG1vZGU6ICduZWVkc19jbGFyaWZpY2F0aW9uJyxcbiAgICAgICAgICBjbGFyaWZpY2F0aW9uczogY2xhcmlmaWNhdGlvbkNoZWNrLnF1ZXN0aW9ucyxcbiAgICAgICAgICBwYXJ0aWFsSW5zaWdodDogY2xhcmlmaWNhdGlvbkNoZWNrLnByZWxpbWluYXJ5SW5zaWdodCxcbiAgICAgICAgICBvcmlnaW5hbFF1ZXN0aW9uOiBxdWVzdGlvbixcbiAgICAgICAgICBkb2N1bWVudHNGb3VuZDogY2h1bmtzLmxlbmd0aFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyDQntCx0L7Qs9Cw0YnQsNC10Lwg0LLQvtC/0YDQvtGBINGD0YLQvtGH0L3QtdC90LjRj9C80Lgg0LXRgdC70Lgg0L7QvdC4INC10YHRgtGMXG4gICAgbGV0IGZpbmFsUXVlc3Rpb24gPSBxdWVzdGlvbjtcbiAgICBpZiAoY2xhcmlmaWNhdGlvbkFuc3dlcnMpIHtcbiAgICAgIGZpbmFsUXVlc3Rpb24gPSBtZXJnZVF1ZXN0aW9uV2l0aENsYXJpZmljYXRpb25zKHF1ZXN0aW9uLCBjbGFyaWZpY2F0aW9uQW5zd2Vycyk7XG4gICAgICBjb25zb2xlLmxvZygn0J7QsdC+0LPQsNGJ0LXQvdC90YvQuSDQstC+0L/RgNC+0YE6JywgZmluYWxRdWVzdGlvbik7XG5cbiAgICAgIC8vINCf0YDQvtCy0LXRgNGP0LXQvCwg0L3QtSDQstC60LvRjtGH0LjQuyDQu9C4INC/0L7Qu9GM0LfQvtCy0LDRgtC10LvRjCB3ZWIgc2VhcmNoINGH0LXRgNC10Lcg0YPRgtC+0YfQvdC10L3QuNGPXG4gICAgICBpZiAoY2xhcmlmaWNhdGlvbkFuc3dlcnMuc2VhcmNoX3dlYiA9PT0gdHJ1ZSB8fCBjbGFyaWZpY2F0aW9uQW5zd2Vycy5lbmFibGVfd2ViX3NlYXJjaCA9PT0gdHJ1ZSkge1xuICAgICAgICB3ZWJTZWFyY2hFbmFibGVkID0gdHJ1ZTtcbiAgICAgICAgZm9yY2VXZWJTZWFyY2ggPSB0cnVlO1xuICAgICAgICBjb25zb2xlLmxvZygnV2ViIHNlYXJjaCDQstC60LvRjtGH0LXQvSDRh9C10YDQtdC3INGD0YLQvtGH0L3QtdC90LjRjycpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vID09PT09PT09PT09PT09PT09PSBTTUFSVCBXRUIgU0VBUkNIID09PT09PT09PT09PT09PT09PVxuICAgIC8vINCe0L/RgNC10LTQtdC70Y/QtdC8LCDQvdGD0LbQtdC9INC70Lggd2ViIHNlYXJjaFxuICAgIGNvbnN0IG5lZWRzV2ViID0gd2ViU2VhcmNoRW5hYmxlZCAmJiAoXG4gICAgICAgIGZvcmNlV2ViU2VhcmNoIHx8XG4gICAgICAgIHNob3VsZFNlYXJjaFdlYihmaW5hbFF1ZXN0aW9uLCBjaHVua3MsIGZhbHNlKSB8fFxuICAgICAgICBjaHVua3MubGVuZ3RoID09PSAwXG4gICAgKTtcblxuICAgIGlmIChuZWVkc1dlYikge1xuICAgICAgY29uc29sZS5sb2coJ/CfjJAg0JLRi9C/0L7Qu9C90Y/QtdC8IHdlYiBzZWFyY2guLi4nKTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgLy8g0J/QsNGA0YHQuNC8IGRvbWFpbiBmaWx0ZXJcbiAgICAgICAgY29uc3QgZG9tYWluRmlsdGVyQXJyYXkgPSBkb21haW5GaWx0ZXJcbiAgICAgICAgICA/IGRvbWFpbkZpbHRlci5zcGxpdCgnLCcpLm1hcCgoZDogc3RyaW5nKSA9PiBkLnRyaW0oKSkuZmlsdGVyKEJvb2xlYW4pXG4gICAgICAgICAgOiB1bmRlZmluZWQ7XG5cbiAgICAgICAgY29uc3Qgd2ViRW5yaWNobWVudCA9IGF3YWl0IGVucmljaFdpdGhXZWJTZWFyY2goXG4gICAgICAgICAgICBmaW5hbFF1ZXN0aW9uLFxuICAgICAgICAgICAgY2h1bmtzLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBzZWFyY2hSZWNlbmN5RmlsdGVyOiBkZXRlY3RUaW1lRmlsdGVyKGZpbmFsUXVlc3Rpb24pLFxuICAgICAgICAgICAgICBzZWFyY2hNb2RlOiBzZWFyY2hNb2RlIHx8ICd3ZWInLFxuICAgICAgICAgICAgICBzZWFyY2hEb21haW5GaWx0ZXI6IGRvbWFpbkZpbHRlckFycmF5LFxuICAgICAgICAgICAgICByb2xlOiByb2xlLFxuICAgICAgICAgICAgICByZXR1cm5JbWFnZXM6IHRydWUsXG4gICAgICAgICAgICAgIHJldHVyblJlbGF0ZWQ6IHRydWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICB3ZWJDb250ZXh0ID0gd2ViRW5yaWNobWVudDtcbiAgICAgICAgY29uc29sZS5sb2coJ+KchSBXZWIgc2VhcmNoINC30LDQstC10YDRiNC10L0nKTtcbiAgICAgICAgY29uc29sZS5sb2coYCAgIC0g0JjRgdGC0L7Rh9C90LjQutC+0LI6ICR7d2ViRW5yaWNobWVudC53ZWJTb3VyY2VzPy5sZW5ndGggfHwgMH1gKTtcbiAgICAgICAgY29uc29sZS5sb2coYCAgIC0g0JjQt9C+0LHRgNCw0LbQtdC90LjQuTogJHt3ZWJFbnJpY2htZW50LndlYkltYWdlcz8ubGVuZ3RoIHx8IDB9YCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGAgICAtINCh0LLRj9C30LDQvdC90YvRhSDQstC+0L/RgNC+0YHQvtCyOiAke3dlYkVucmljaG1lbnQucmVsYXRlZFF1ZXN0aW9ucz8ubGVuZ3RoIHx8IDB9YCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGAgICAtINCc0L7QtNC10LvRjDogJHt3ZWJFbnJpY2htZW50Lm1vZGVsfWApO1xuICAgICAgfSBjYXRjaCAod2ViRXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign4pqg77iPIFdlYiBzZWFyY2ggZmFpbGVkOicsIHdlYkVycm9yKTtcbiAgICAgICAgLy8g0J/RgNC+0LTQvtC70LbQsNC10Lwg0LHQtdC3IHdlYiBjb250ZXh0XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8g0JXRgdC70Lgg0L3QtdGCINC90Lgg0LTQvtC60YPQvNC10L3RgtC+0LIsINC90Lggd2ViINGA0LXQt9GD0LvRjNGC0LDRgtC+0LJcbiAgICBpZiAoIWNodW5rcy5sZW5ndGggJiYgIXdlYkNvbnRleHQpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XG4gICAgICAgIGFuc3dlcjogXCLQndC1INC90LDRiNGR0Lsg0LjQvdGE0L7RgNC80LDRhtC40Lgg0L3QuCDQsiDQtNC+0LrRg9C80LXQvdGC0LDRhSDQv9GA0L7QtdC60YLQsCwg0L3QuCDQsiDQuNC90YLQtdGA0L3QtdGC0LUuINCf0L7Qv9GA0L7QsdGD0LnRgtC1INC/0LXRgNC10YTQvtGA0LzRg9C70LjRgNC+0LLQsNGC0Ywg0LLQvtC/0YDQvtGBINC40LvQuCDQt9Cw0LPRgNGD0LfQuNGC0Ywg0YDQtdC70LXQstCw0L3RgtC90YvQtSDQtNC+0LrRg9C80LXQvdGC0YsuXCIsXG4gICAgICAgIHF1ZXN0aW9uLFxuICAgICAgICBzb3VyY2VzOiBbXSxcbiAgICAgICAgd2ViU291cmNlczogW10sXG4gICAgICAgIGluc2lnaHRzOiBbXSxcbiAgICAgICAgZm9sbG93X3VwX3F1ZXN0aW9uczogW1wi0JfQsNCz0YDRg9C30LjRgtGMINC00L7QutGD0LzQtdC90YLRiyDQv9C+INGN0YLQvtC5INGC0LXQvNC1P1wiLCBcItCS0LrQu9GO0YfQuNGC0Ywg0YDQsNGB0YjQuNGA0LXQvdC90YvQuSDQv9C+0LjRgdC6P1wiXVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gPT09PT09PT09PT09PT09PT09INCf0J7QlNCT0J7QotCe0JLQmtCQINCf0KDQntCc0J/QotCQID09PT09PT09PT09PT09PT09PVxuICAgIGNvbnN0IGN0eFRva2VucyA9IGFwcHJveFRva2VuTGVuKGNodW5rcy5tYXAoYyA9PiBjLnRleHQpLmpvaW4oXCIgXCIpKTtcbiAgICBjb25zdCBwcm92aWRlckZpbmFsID0gKHByb3ZpZGVyIGFzIFwib3BlbmFpXCIgfCBcImFudGhyb3BpY1wiKSA/P1xuICAgICAgICAoY3R4VG9rZW5zID4gMTIwXzAwMCA/IFwiYW50aHJvcGljXCIgOiBcIm9wZW5haVwiKTtcblxuICAgIGNvbnNvbGUubG9nKGDQmNGB0L/QvtC70YzQt9GD0LXRgtGB0Y8g0L/RgNC+0LLQsNC50LTQtdGAOiAke3Byb3ZpZGVyRmluYWx9LCDQutC+0L3RgtC10LrRgdGCOiAke2N0eFRva2Vuc30g0YLQvtC60LXQvdC+0LJgKTtcblxuICAgIC8vINCk0L7RgNC80LjRgNGD0LXQvCDRgdC40YHRgtC10LzQvdGL0Lkg0L/RgNC+0LzQv9GCINGBINGA0L7Qu9GM0Y5cbiAgICBsZXQgc3lzdGVtUHJvbXB0ID0gU1lTVEVNX1JBRztcbiAgICBpZiAocm9sZSAmJiByb2xlICE9PSAnYW5hbHlzdCcpIHtcbiAgICAgIGNvbnN0IHJvbGVQcmVmaXggPSByb2xlID09PSAnY3VzdG9tJyA/IHJvbGUgOiBgUk9MRTogJHtyb2xlfVxcblxcbmA7XG4gICAgICBzeXN0ZW1Qcm9tcHQgPSBgJHtyb2xlUHJlZml4fSR7U1lTVEVNX1JBR31gO1xuICAgIH1cblxuICAgIC8vINCU0L7QsdCw0LLQu9GP0LXQvCDQuNC90YHRgtGA0YPQutGG0LjQuCDQtNC70Y8gd2ViIGNvbnRleHRcbiAgICBpZiAod2ViQ29udGV4dCkge1xuICAgICAgc3lzdGVtUHJvbXB0ICs9IGBcXG5cXG5XRUIgU0VBUkNIIElOVEVHUkFUSU9OOlxuLSBZb3UgaGF2ZSBhY2Nlc3MgdG8gYm90aCBkb2N1bWVudCBjb250ZXh0IGFuZCByZWFsLXRpbWUgd2ViIHNlYXJjaCByZXN1bHRzXG4tIENsZWFybHkgZGlzdGluZ3Vpc2ggYmV0d2VlbiBpbmZvcm1hdGlvbiBmcm9tIGRvY3VtZW50cyB2cyB3ZWJcbi0gUHJpb3JpdGl6ZSByZWNlbnQgd2ViIGRhdGEgZm9yIGN1cnJlbnQgZXZlbnRzIGFuZCBtYXJrZXQgaW5mb3JtYXRpb25cbi0gQ3Jvc3MtdmFsaWRhdGUgZmFjdHMgYmV0d2VlbiBzb3VyY2VzIHdoZW4gcG9zc2libGVgO1xuICAgIH1cblxuICAgIC8vINCh0YLRgNC+0LjQvCDQv9GA0L7QvNC/0YIg0YEg0LrQvtC80LHQuNC90LjRgNC+0LLQsNC90L3Ri9C8INC60L7QvdGC0LXQutGB0YLQvtC8XG4gICAgY29uc3QgdXNlclByb21wdCA9IGJ1aWxkRW5oYW5jZWRVc2VyUHJvbXB0KFxuICAgICAgICBmaW5hbFF1ZXN0aW9uLFxuICAgICAgICBjaHVua3MsXG4gICAgICAgIHdlYkNvbnRleHQsXG4gICAgICAgIGNsYXJpZmljYXRpb25BbnN3ZXJzXG4gICAgKTtcblxuICAgIGNvbnNvbGUubG9nKCfQl9Cw0L/RgNC+0YEg0Log0LzQvtC00LXQu9C4Li4uJyk7XG4gICAgY29uc3QgcmF3ID0gYXdhaXQgY2hhdFdpdGhQcm92aWRlcihwcm92aWRlckZpbmFsLCB7XG4gICAgICBzeXN0ZW06IHN5c3RlbVByb21wdCxcbiAgICAgIHVzZXI6IHVzZXJQcm9tcHQsXG4gICAgICBtYXhUb2tlbnM6IDgwMDBcbiAgICB9KTtcblxuICAgIGNvbnNvbGUubG9nKGBSYXcg0L7RgtCy0LXRgiAo0L/QtdGA0LLRi9C1IDIwMCDRgdC40LzQstC+0LvQvtCyKTpgLCByYXcuc3Vic3RyaW5nKDAsIDIwMCkpO1xuXG4gICAgLy8g0J/QsNGA0YHQuNC8IEpTT04g0LjQtyDQvtGC0LLQtdGC0LAg0LzQvtC00LXQu9C4XG4gICAgbGV0IHBhcnNlZCA9IGNsZWFuQW5kUGFyc2VKU09OKHJhdyk7XG5cbiAgICBpZiAoIXBhcnNlZCkge1xuICAgICAgY29uc29sZS5sb2coJ0pTT04g0L/QsNGA0YHQuNC90LMg0L3QtSDRg9C00LDQu9GB0Y8sINC40YHQv9C+0LvRjNC30YPQtdC8IHJhdyDRgtC10LrRgdGCJyk7XG4gICAgICBwYXJzZWQgPSB7XG4gICAgICAgIGFuc3dlcjogcmF3LFxuICAgICAgICBjaXRhdGlvbnM6IFtdLFxuICAgICAgICBpbnNpZ2h0czogW10sXG4gICAgICAgIGZvbGxvd191cF9xdWVzdGlvbnM6IFtdXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vINCY0LfQstC70LXQutCw0LXQvCDQtNCw0L3QvdGL0LVcbiAgICBjb25zdCBhbnN3ZXIgPSBwYXJzZWQuYW5zd2VyIHx8IFwi0J7RiNC40LHQutCwOiDQvdC1INGD0LTQsNC70L7RgdGMINC/0L7Qu9GD0YfQuNGC0Ywg0L7RgtCy0LXRglwiO1xuICAgIGNvbnN0IGNpdGF0aW9ucyA9IHBhcnNlZC5jaXRhdGlvbnMgfHwgY2h1bmtzLnNsaWNlKDAsIDMpLm1hcChjID0+ICh7XG4gICAgICBkb2NfaWQ6IGMuZG9jX2lkLFxuICAgICAgY2h1bmtfaW5kZXg6IGMuY2h1bmtfaW5kZXgsXG4gICAgICBzaW1pbGFyaXR5OiBjLnNpbWlsYXJpdHksXG4gICAgICBxdW90ZTogYy50ZXh0LnNsaWNlKDAsIDIwMClcbiAgICB9KSk7XG5cbiAgICAvLyDQlNC+0LHQsNCy0LvRj9C10Lwgd2ViINC40YHRgtC+0YfQvdC40LrQuCDQuCDQtNC+0L/QvtC70L3QuNGC0LXQu9GM0L3Ri9C1INC00LDQvdC90YvQtSDQtdGB0LvQuCDQtdGB0YLRjFxuICAgIGNvbnN0IHdlYlNvdXJjZXMgPSB3ZWJDb250ZXh0Py53ZWJTb3VyY2VzIHx8IFtdO1xuICAgIGNvbnN0IHdlYkltYWdlcyA9IHdlYkNvbnRleHQ/LndlYkltYWdlcyB8fCBbXTtcbiAgICBjb25zdCByZWxhdGVkUXVlc3Rpb25zID0gd2ViQ29udGV4dD8ucmVsYXRlZFF1ZXN0aW9ucyB8fCBbXTtcblxuICAgIGNvbnN0IGluc2lnaHRzID0gcGFyc2VkLmluc2lnaHRzIHx8IFtdO1xuXG4gICAgLy8g0J7QsdGK0LXQtNC40L3Rj9C10LwgZm9sbG93X3VwINCy0L7Qv9GA0L7RgdGLINC40Lcg0LzQvtC00LXQu9C4INC4INC40LcgUGVycGxleGl0eVxuICAgIGxldCBmb2xsb3dfdXBfcXVlc3Rpb25zID0gcGFyc2VkLmZvbGxvd191cF9xdWVzdGlvbnMgfHwgW107XG4gICAgaWYgKHJlbGF0ZWRRdWVzdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgZm9sbG93X3VwX3F1ZXN0aW9ucyA9IFsuLi5mb2xsb3dfdXBfcXVlc3Rpb25zLCAuLi5yZWxhdGVkUXVlc3Rpb25zXS5zbGljZSgwLCA1KTtcbiAgICB9XG5cbiAgICBjb25zb2xlLmxvZyhg0J7RgtCy0LXRgiDQv9C+0LvRg9GH0LXQvS4gQW5zd2VyOiAke2Fuc3dlci5sZW5ndGh9IGNoYXJzLCBXZWIgc291cmNlczogJHt3ZWJTb3VyY2VzLmxlbmd0aH0sIEltYWdlczogJHt3ZWJJbWFnZXMubGVuZ3RofWApO1xuXG4gICAgY29uc3QgbGF0ZW5jeSA9IERhdGUubm93KCkgLSB0MDtcblxuICAgIC8vINCh0L7RhdGA0LDQvdGP0LXQvCDRgdC+0L7QsdGJ0LXQvdC40Y8g0YEg0YDQsNGB0YjQuNGA0LXQvdC90YvQvNC4INC80LXRgtCw0LTQsNC90L3Ri9C80LhcbiAgICBhd2FpdCBzdXBhYmFzZS5mcm9tKFwibWVzc2FnZXNcIikuaW5zZXJ0KFtcbiAgICAgIHtcbiAgICAgICAgdXNlcl9pZDogdXNlci5pZCxcbiAgICAgICAgcm9sZTogXCJ1c2VyXCIsXG4gICAgICAgIGNvbnRlbnQ6IHF1ZXN0aW9uLFxuICAgICAgICBwcm9qZWN0X2lkOiBwcm9qZWN0SWQgJiYgcHJvamVjdElkICE9PSAnbnVsbCcgPyBwcm9qZWN0SWQgOiBudWxsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICB1c2VyX2lkOiB1c2VyLmlkLFxuICAgICAgICByb2xlOiBcImFzc2lzdGFudFwiLFxuICAgICAgICBjb250ZW50OiBhbnN3ZXIsXG4gICAgICAgIHByb2plY3RfaWQ6IHByb2plY3RJZCAmJiBwcm9qZWN0SWQgIT09ICdudWxsJyA/IHByb2plY3RJZCA6IG51bGwsXG4gICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgcHJvdmlkZXI6IHByb3ZpZGVyRmluYWwsXG4gICAgICAgICAgbGF0ZW5jeV9tczogbGF0ZW5jeSxcbiAgICAgICAgICBzb3VyY2VzOiBjaXRhdGlvbnMsXG4gICAgICAgICAgd2ViU291cmNlcyxcbiAgICAgICAgICB3ZWJJbWFnZXMsICAvLyDQndCe0JLQntCVXG4gICAgICAgICAgaW5zaWdodHMsXG4gICAgICAgICAgZm9sbG93X3VwX3F1ZXN0aW9ucyxcbiAgICAgICAgICB1c2VkV2ViU2VhcmNoOiAhIXdlYkNvbnRleHQsXG4gICAgICAgICAgcGVycGxleGl0eU1vZGVsOiB3ZWJDb250ZXh0Py5tb2RlbCwgIC8vINCd0J7QktCe0JVcbiAgICAgICAgICBoYWRDbGFyaWZpY2F0aW9uczogISFjbGFyaWZpY2F0aW9uQW5zd2Vyc1xuICAgICAgICB9XG4gICAgICB9XG4gICAgXSk7XG5cbiAgICAvLyDQktC+0LfQstGA0LDRidCw0LXQvCDRgNCw0YHRiNC40YDQtdC90L3Ri9C5INC+0YLQstC10YJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgYW5zd2VyLFxuICAgICAgcXVlc3Rpb24sXG4gICAgICBzb3VyY2VzOiBjaXRhdGlvbnMsXG4gICAgICB3ZWJTb3VyY2VzLFxuICAgICAgd2ViSW1hZ2VzLCAgLy8g0J3QntCS0J7QlTog0LjQt9C+0LHRgNCw0LbQtdC90LjRjyDQuNC3IHdlYlxuICAgICAgaW5zaWdodHMsXG4gICAgICBmb2xsb3dfdXBfcXVlc3Rpb25zLFxuICAgICAgcHJvdmlkZXI6IHByb3ZpZGVyRmluYWwsXG4gICAgICBwZXJwbGV4aXR5TW9kZWw6IHdlYkNvbnRleHQ/Lm1vZGVsLCAgLy8g0J3QntCS0J7QlTog0LzQvtC00LXQu9GMIFBlcnBsZXhpdHlcbiAgICAgIGxhdGVuY3lfbXM6IGxhdGVuY3ksXG4gICAgICB1c2VkV2ViU2VhcmNoOiAhIXdlYkNvbnRleHRcbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIC9hcGkvYXNrOicsIGVycik7XG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHtcbiAgICAgIGVycm9yOiBlcnI/Lm1lc3NhZ2UgfHwgXCJVbmtub3duIGVycm9yXCIsXG4gICAgICBhbnN3ZXI6IFwi0J/RgNC+0LjQt9C+0YjQu9CwINC+0YjQuNCx0LrQsCDQv9GA0Lgg0L7QsdGA0LDQsdC+0YLQutC1INC30LDQv9GA0L7RgdCwLiDQn9C+0L/RgNC+0LHRg9C50YLQtSDQtdGJ0LUg0YDQsNC3LlwiLFxuICAgICAgc291cmNlczogW10sXG4gICAgICB3ZWJTb3VyY2VzOiBbXSxcbiAgICAgIHdlYkltYWdlczogW10sXG4gICAgICBpbnNpZ2h0czogW10sXG4gICAgICBmb2xsb3dfdXBfcXVlc3Rpb25zOiBbXVxuICAgIH0sIHsgc3RhdHVzOiA1MDAgfSk7XG4gIH1cbn1cblxuLy8gPT09PT09PT09PT09PT09PT09INCS0KHQn9Ce0JzQntCT0JDQotCV0JvQrNCd0KvQlSDQpNCj0J3QmtCm0JjQmCA9PT09PT09PT09PT09PT09PT1cblxuLy8g0J7Qv9GA0LXQtNC10LvQtdC90LjQtSDQstGA0LXQvNC10L3QvdC+0LPQviDRhNC40LvRjNGC0YDQsCDQtNC70Y8gd2ViIHNlYXJjaFxuZnVuY3Rpb24gZGV0ZWN0VGltZUZpbHRlcihxdWVzdGlvbjogc3RyaW5nKTogJ2RheScgfCAnd2VlaycgfCAnbW9udGgnIHwgJ3llYXInIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgbG93ZXJRID0gcXVlc3Rpb24udG9Mb3dlckNhc2UoKTtcblxuICBpZiAobG93ZXJRLmluY2x1ZGVzKCfRgdC10LPQvtC00L3RjycpIHx8IGxvd2VyUS5pbmNsdWRlcygndG9kYXknKSkgcmV0dXJuICdkYXknO1xuICBpZiAobG93ZXJRLmluY2x1ZGVzKCfQvdC10LTQtdC70LUnKSB8fCBsb3dlclEuaW5jbHVkZXMoJ3dlZWsnKSkgcmV0dXJuICd3ZWVrJztcbiAgaWYgKGxvd2VyUS5pbmNsdWRlcygn0LzQtdGB0Y/RhicpIHx8IGxvd2VyUS5pbmNsdWRlcygnbW9udGgnKSkgcmV0dXJuICdtb250aCc7XG4gIGlmIChsb3dlclEuaW5jbHVkZXMoJ9Cz0L7QtCcpIHx8IGxvd2VyUS5pbmNsdWRlcygneWVhcicpKSByZXR1cm4gJ3llYXInO1xuXG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cbi8vINCg0LDRgdGI0LjRgNC10L3QvdCw0Y8g0YTRg9C90LrRhtC40Y8g0L/QvtGB0YLRgNC+0LXQvdC40Y8g0L/RgNC+0LzQv9GC0LAg0YEgd2ViIGNvbnRleHRcbmZ1bmN0aW9uIGJ1aWxkRW5oYW5jZWRVc2VyUHJvbXB0KFxuICAgIHF1ZXN0aW9uOiBzdHJpbmcsXG4gICAgZG9jdW1lbnRDaHVua3M6IGFueVtdLFxuICAgIHdlYkNvbnRleHQ6IGFueSxcbiAgICBjbGFyaWZpY2F0aW9uQW5zd2Vycz86IGFueVxuKTogc3RyaW5nIHtcbiAgbGV0IHByb21wdCA9ICcnO1xuXG4gIC8vINCU0L7QsdCw0LLQu9GP0LXQvCDQutC+0L3RgtC10LrRgdGCINC40Lcg0LTQvtC60YPQvNC10L3RgtC+0LJcbiAgaWYgKGRvY3VtZW50Q2h1bmtzLmxlbmd0aCA+IDApIHtcbiAgICBwcm9tcHQgKz0gJ0RPQ1VNRU5UIENPTlRFWFQ6XFxuJztcbiAgICBwcm9tcHQgKz0gZG9jdW1lbnRDaHVua3MubWFwKChjLCBpKSA9PlxuICAgICAgICBgW0RvYyAke2krMX1dIChTaW1pbGFyaXR5OiAkeyhjLnNpbWlsYXJpdHkgKiAxMDApLnRvRml4ZWQoMSl9JSlcXG4ke2MudGV4dH1cXG5gXG4gICAgKS5qb2luKCdcXG4tLS1cXG4nKTtcbiAgfVxuXG4gIC8vINCU0L7QsdCw0LLQu9GP0LXQvCB3ZWIg0LrQvtC90YLQtdC60YHRglxuICBpZiAod2ViQ29udGV4dCkge1xuICAgIHByb21wdCArPSAnXFxuXFxuV0VCIFNFQVJDSCBSRVNVTFRTIChSZWFsLXRpbWUpOlxcbic7XG4gICAgcHJvbXB0ICs9IHdlYkNvbnRleHQud2ViQW5zd2VyIHx8ICcnO1xuXG4gICAgaWYgKHdlYkNvbnRleHQud2ViU291cmNlcz8ubGVuZ3RoID4gMCkge1xuICAgICAgcHJvbXB0ICs9ICdcXG5cXG5XZWIgU291cmNlczpcXG4nO1xuICAgICAgcHJvbXB0ICs9IHdlYkNvbnRleHQud2ViU291cmNlcy5tYXAoKHM6IGFueSkgPT4gYC0gJHtzLnRpdGxlIHx8IHMudXJsfWApLmpvaW4oJ1xcbicpO1xuICAgIH1cbiAgfVxuXG4gIC8vINCU0L7QsdCw0LLQu9GP0LXQvCDRg9GC0L7Rh9C90LXQvdC40Y9cbiAgaWYgKGNsYXJpZmljYXRpb25BbnN3ZXJzKSB7XG4gICAgcHJvbXB0ICs9ICdcXG5cXG5VU0VSIENMQVJJRklDQVRJT05TOlxcbic7XG4gICAgcHJvbXB0ICs9IE9iamVjdC5lbnRyaWVzKGNsYXJpZmljYXRpb25BbnN3ZXJzKVxuICAgICAgICAubWFwKChba2V5LCB2YWx1ZV0pID0+IGAke2tleX06ICR7dmFsdWV9YClcbiAgICAgICAgLmpvaW4oJ1xcbicpO1xuICB9XG5cbiAgcHJvbXB0ICs9IGBcXG5cXG5VU0VSIFFVRVNUSU9OOlxcbiR7cXVlc3Rpb259XFxuXFxuYDtcbiAgcHJvbXB0ICs9ICdQcm92aWRlIGEgY29tcHJlaGVuc2l2ZSBhbnN3ZXIgdXNpbmcgYm90aCBkb2N1bWVudCBhbmQgd2ViIGNvbnRleHQgd2hlcmUgYXZhaWxhYmxlLiAnO1xuICBwcm9tcHQgKz0gJ0NsZWFybHkgaW5kaWNhdGUgd2hpY2ggaW5mb3JtYXRpb24gY29tZXMgZnJvbSBkb2N1bWVudHMgdnMgd2ViIHNvdXJjZXMuJztcblxuICByZXR1cm4gcHJvbXB0O1xufSJdLCJuYW1lcyI6WyJOZXh0UmVzcG9uc2UiLCJjcmVhdGVDbGllbnQiLCJPcGVuQUkiLCJjaGF0V2l0aFByb3ZpZGVyIiwiU1lTVEVNX1JBRyIsImFuYWx5emVDbGFyaWZpY2F0aW9uTmVlZCIsIm1lcmdlUXVlc3Rpb25XaXRoQ2xhcmlmaWNhdGlvbnMiLCJzaG91bGRTZWFyY2hXZWIiLCJlbnJpY2hXaXRoV2ViU2VhcmNoIiwib3BlbmFpIiwiYXBpS2V5IiwicHJvY2VzcyIsImVudiIsIk9QRU5BSV9BUElfS0VZIiwiYXBwcm94VG9rZW5MZW4iLCJzIiwiTWF0aCIsImNlaWwiLCJsZW5ndGgiLCJkZWR1cGVBbmRNZXJnZSIsIm1hdGNoZXMiLCJzZWVuIiwiU2V0IiwidW5pcXVlIiwibSIsImtleSIsImRvY3VtZW50X2lkIiwiY2h1bmtfdGV4dCIsInNsaWNlIiwiaGFzIiwiYWRkIiwicHVzaCIsImNsZWFuQW5kUGFyc2VKU09OIiwicmF3IiwiSlNPTiIsInBhcnNlIiwiZSIsImNsZWFuZWQiLCJyZXBsYWNlIiwidHJpbSIsImpzb25TdGFydCIsInNlYXJjaCIsInN1YnN0cmluZyIsImxhc3RCcmFjZSIsImxhc3RJbmRleE9mIiwibGFzdEJyYWNrZXQiLCJqc29uRW5kIiwibWF4IiwiZTIiLCJjb25zb2xlIiwiZXJyb3IiLCJsb2ciLCJhbnN3ZXJNYXRjaCIsIm1hdGNoIiwiYW5zd2VyIiwiY2l0YXRpb25zIiwiaW5zaWdodHMiLCJmb2xsb3dfdXBfcXVlc3Rpb25zIiwiUE9TVCIsInJlcXVlc3QiLCJ0MCIsIkRhdGUiLCJub3ciLCJzdXBhYmFzZSIsIk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTCIsIlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVkiLCJ0b2tlbiIsImhlYWRlcnMiLCJnZXQiLCJqc29uIiwic3RhdHVzIiwiZGF0YSIsInVzZXIiLCJhdXRoRXJyb3IiLCJhdXRoIiwiZ2V0VXNlciIsImJvZHkiLCJxdWVzdGlvbiIsInByb3ZpZGVyIiwicHJvamVjdElkIiwicm9sZSIsImNsYXJpZmljYXRpb25BbnN3ZXJzIiwic2tpcENsYXJpZmljYXRpb24iLCJzZWFyY2hNb2RlIiwiZG9tYWluRmlsdGVyIiwid2ViU2VhcmNoRW5hYmxlZCIsImZvcmNlV2ViU2VhcmNoIiwiY291bnRRdWVyeSIsImZyb20iLCJzZWxlY3QiLCJjb3VudCIsImhlYWQiLCJlcSIsImlkIiwiY2h1bmtzIiwid2ViQ29udGV4dCIsImVtYmVkUmVzIiwiZW1iZWRkaW5ncyIsImNyZWF0ZSIsIm1vZGVsIiwiaW5wdXQiLCJxdWVyeUVtYmVkZGluZyIsImVtYmVkZGluZyIsIm1hdGNoRXJyb3IiLCJycGMiLCJxdWVyeV9lbWJlZGRpbmciLCJtYXRjaF90aHJlc2hvbGQiLCJtYXRjaF9jb3VudCIsImZpbHRlcl91c2VyX2lkIiwiZmlsdGVyX3Byb2plY3RfaWQiLCJ1bmlxIiwibWFwIiwiZG9jX2lkIiwiY2h1bmtfaW5kZXgiLCJzaW1pbGFyaXR5IiwidGV4dCIsImNsYXJpZmljYXRpb25DaGVjayIsIm5lZWRlZCIsInF1ZXN0aW9ucyIsInR5cGUiLCJyZXF1aXJlZCIsImNvbnRleHQiLCJtb2RlIiwiY2xhcmlmaWNhdGlvbnMiLCJwYXJ0aWFsSW5zaWdodCIsInByZWxpbWluYXJ5SW5zaWdodCIsIm9yaWdpbmFsUXVlc3Rpb24iLCJkb2N1bWVudHNGb3VuZCIsImZpbmFsUXVlc3Rpb24iLCJzZWFyY2hfd2ViIiwiZW5hYmxlX3dlYl9zZWFyY2giLCJuZWVkc1dlYiIsImRvbWFpbkZpbHRlckFycmF5Iiwic3BsaXQiLCJkIiwiZmlsdGVyIiwiQm9vbGVhbiIsInVuZGVmaW5lZCIsIndlYkVucmljaG1lbnQiLCJzZWFyY2hSZWNlbmN5RmlsdGVyIiwiZGV0ZWN0VGltZUZpbHRlciIsInNlYXJjaERvbWFpbkZpbHRlciIsInJldHVybkltYWdlcyIsInJldHVyblJlbGF0ZWQiLCJ3ZWJTb3VyY2VzIiwid2ViSW1hZ2VzIiwicmVsYXRlZFF1ZXN0aW9ucyIsIndlYkVycm9yIiwic291cmNlcyIsImN0eFRva2VucyIsImMiLCJqb2luIiwicHJvdmlkZXJGaW5hbCIsInN5c3RlbVByb21wdCIsInJvbGVQcmVmaXgiLCJ1c2VyUHJvbXB0IiwiYnVpbGRFbmhhbmNlZFVzZXJQcm9tcHQiLCJzeXN0ZW0iLCJtYXhUb2tlbnMiLCJwYXJzZWQiLCJxdW90ZSIsImxhdGVuY3kiLCJpbnNlcnQiLCJ1c2VyX2lkIiwiY29udGVudCIsInByb2plY3RfaWQiLCJtZXRhZGF0YSIsImxhdGVuY3lfbXMiLCJ1c2VkV2ViU2VhcmNoIiwicGVycGxleGl0eU1vZGVsIiwiaGFkQ2xhcmlmaWNhdGlvbnMiLCJlcnIiLCJtZXNzYWdlIiwibG93ZXJRIiwidG9Mb3dlckNhc2UiLCJpbmNsdWRlcyIsImRvY3VtZW50Q2h1bmtzIiwicHJvbXB0IiwiaSIsInRvRml4ZWQiLCJ3ZWJBbnN3ZXIiLCJ0aXRsZSIsInVybCIsIk9iamVjdCIsImVudHJpZXMiLCJ2YWx1ZSJdLCJpZ25vcmVMaXN0IjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./app/api/ask/route.ts\n");

/***/ }),

/***/ "(rsc)/./lib/modelProvider.ts":
/*!******************************!*\
  !*** ./lib/modelProvider.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   chatWithAI: () => (/* binding */ chatWithAI),\n/* harmony export */   chatWithProvider: () => (/* binding */ chatWithProvider)\n/* harmony export */ });\n/* harmony import */ var openai__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! openai */ \"(rsc)/./node_modules/openai/index.mjs\");\n/* harmony import */ var _anthropic_ai_sdk__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @anthropic-ai/sdk */ \"(rsc)/./node_modules/@anthropic-ai/sdk/index.mjs\");\n\n\nconst openai = new openai__WEBPACK_IMPORTED_MODULE_0__[\"default\"]({\n    apiKey: process.env.OPENAI_API_KEY\n});\nconst anthropic = new _anthropic_ai_sdk__WEBPACK_IMPORTED_MODULE_1__[\"default\"]({\n    apiKey: process.env.ANTHROPIC_API_KEY || \"\"\n});\n// Основная новая функция\nasync function chatWithAI(args) {\n    const maxTokens = args.maxTokens ?? 4000;\n    if (args.forceProvider === \"openai\") {\n        return await callOpenAI(args.system, args.user, maxTokens);\n    }\n    if (args.forceProvider === \"anthropic\") {\n        return await callAnthropic(args.system, args.user, maxTokens);\n    }\n    // Сначала Claude, затем GPT\n    try {\n        console.log(\"🤖 Trying Claude first...\");\n        const claudeResponse = await callAnthropic(args.system, args.user, maxTokens);\n        if (claudeResponse && claudeResponse.trim().length > 0) {\n            console.log(\"✅ Claude responded successfully\");\n            return claudeResponse;\n        }\n        throw new Error(\"Claude returned empty response\");\n    } catch (claudeError) {\n        console.error(\"⚠️ Claude failed:\", claudeError);\n        console.log(\"🔄 Switching to GPT as fallback...\");\n        try {\n            const gptResponse = await callOpenAI(args.system, args.user, maxTokens);\n            console.log(\"✅ GPT responded successfully\");\n            return gptResponse;\n        } catch (gptError) {\n            console.error(\"❌ Both providers failed\");\n            throw new Error(`Both AI providers failed. Claude: ${claudeError}, GPT: ${gptError}`);\n        }\n    }\n}\n// Обратная совместимость со старым API\nasync function chatWithProvider(provider, args) {\n    console.log(`⚠️ chatWithProvider is deprecated, use chatWithAI instead`);\n    // Игнорируем параметр provider, всегда используем логику Claude → GPT\n    return await chatWithAI(args);\n}\nasync function callAnthropic(system, user, maxTokens) {\n    if (!process.env.ANTHROPIC_API_KEY) {\n        throw new Error(\"Anthropic API key not configured\");\n    }\n    const res = await anthropic.messages.create({\n        model: process.env.ANTHROPIC_MODEL || \"claude-opus-4-1-20250805\",\n        max_tokens: Math.min(maxTokens, 8192),\n        temperature: 0.1,\n        system: system,\n        messages: [\n            {\n                role: \"user\",\n                content: user\n            }\n        ]\n    });\n    const content = res.content?.[0];\n    if (content && content.type === \"text\" && content.text) {\n        return content.text;\n    }\n    throw new Error(\"Invalid response from Anthropic\");\n}\nasync function callOpenAI(system, user, maxTokens) {\n    if (!process.env.OPENAI_API_KEY) {\n        throw new Error(\"OpenAI API key not configured\");\n    }\n    const res = await openai.chat.completions.create({\n        model: process.env.OPENAI_CHAT_MODEL || \"gpt-4-turbo-preview\",\n        messages: [\n            {\n                role: \"system\",\n                content: system\n            },\n            {\n                role: \"user\",\n                content: user\n            }\n        ],\n        max_tokens: Math.min(maxTokens, 8000),\n        temperature: 0.1\n    });\n    const content = res.choices[0]?.message?.content;\n    if (content) {\n        return content;\n    }\n    throw new Error(\"Invalid response from OpenAI\");\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUFDQyxXQUFXLENBQUNaLE1BQU0sQ0FBQztRQUUvQ0MsT0FBTzVCLFFBQVFDLEdBQUcsQ0FBQ3VDLGlCQUFpQixJQUFJO1FBRXhDZCxVQUFVO1lBRVI7Z0JBQUVRLE1BQU07Z0JBQVVDLFNBQVN6QjtZQUFPO1lBRWxDO2dCQUFFd0IsTUFBTTtnQkFBUUMsU0FBU3hCO1lBQUs7U0FFL0I7UUFFRG1CLFlBQVlDLEtBQUtDLEdBQUcsQ0FBQ3pCLFdBQVc7UUFFaEMwQixhQUFhO0lBRWY7SUFFQSxNQUFNRSxVQUFVVixJQUFJZ0IsT0FBTyxDQUFDLEVBQUUsRUFBRUMsU0FBU1A7SUFFekMsSUFBSUEsU0FBUztRQUVYLE9BQU9BO0lBRVQ7SUFJQSxNQUFNLElBQUlqQixNQUFNO0FBRWxCIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vLy4vbGliL21vZGVsUHJvdmlkZXIudHM/NDhiYyJdLCJzb3VyY2VzQ29udGVudCI6WyJcblxuaW1wb3J0IE9wZW5BSSBmcm9tIFwib3BlbmFpXCI7XG5cbmltcG9ydCBBbnRocm9waWMgZnJvbSBcIkBhbnRocm9waWMtYWkvc2RrXCI7XG5cbmV4cG9ydCB0eXBlIENoYXRQcm92aWRlciA9IFwib3BlbmFpXCIgfCBcImFudGhyb3BpY1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIENoYXRBcmdzIHtcblxuICBzeXN0ZW06IHN0cmluZztcblxuICB1c2VyOiBzdHJpbmc7XG5cbiAgbWF4VG9rZW5zPzogbnVtYmVyO1xuXG4gIGZvcmNlUHJvdmlkZXI/OiBDaGF0UHJvdmlkZXI7XG5cbn1cblxuY29uc3Qgb3BlbmFpID0gbmV3IE9wZW5BSSh7XG5cbiAgYXBpS2V5OiBwcm9jZXNzLmVudi5PUEVOQUlfQVBJX0tFWVxuXG59KTtcblxuY29uc3QgYW50aHJvcGljID0gbmV3IEFudGhyb3BpYyh7XG5cbiAgYXBpS2V5OiBwcm9jZXNzLmVudi5BTlRIUk9QSUNfQVBJX0tFWSB8fCBcIlwiXG5cbn0pO1xuXG4vLyDQntGB0L3QvtCy0L3QsNGPINC90L7QstCw0Y8g0YTRg9C90LrRhtC40Y9cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNoYXRXaXRoQUkoYXJnczogQ2hhdEFyZ3MpOiBQcm9taXNlPHN0cmluZz4ge1xuXG4gIGNvbnN0IG1heFRva2VucyA9IGFyZ3MubWF4VG9rZW5zID8/IDQwMDA7XG5cblxuXG4gIGlmIChhcmdzLmZvcmNlUHJvdmlkZXIgPT09IFwib3BlbmFpXCIpIHtcblxuICAgIHJldHVybiBhd2FpdCBjYWxsT3BlbkFJKGFyZ3Muc3lzdGVtLCBhcmdzLnVzZXIsIG1heFRva2Vucyk7XG5cbiAgfVxuXG4gIGlmIChhcmdzLmZvcmNlUHJvdmlkZXIgPT09IFwiYW50aHJvcGljXCIpIHtcblxuICAgIHJldHVybiBhd2FpdCBjYWxsQW50aHJvcGljKGFyZ3Muc3lzdGVtLCBhcmdzLnVzZXIsIG1heFRva2Vucyk7XG5cbiAgfVxuXG4gIC8vINCh0L3QsNGH0LDQu9CwIENsYXVkZSwg0LfQsNGC0LXQvCBHUFRcblxuICB0cnkge1xuXG4gICAgY29uc29sZS5sb2coXCLwn6SWIFRyeWluZyBDbGF1ZGUgZmlyc3QuLi5cIik7XG5cbiAgICBjb25zdCBjbGF1ZGVSZXNwb25zZSA9IGF3YWl0IGNhbGxBbnRocm9waWMoYXJncy5zeXN0ZW0sIGFyZ3MudXNlciwgbWF4VG9rZW5zKTtcblxuICAgIGlmIChjbGF1ZGVSZXNwb25zZSAmJiBjbGF1ZGVSZXNwb25zZS50cmltKCkubGVuZ3RoID4gMCkge1xuXG4gICAgICBjb25zb2xlLmxvZyhcIuKchSBDbGF1ZGUgcmVzcG9uZGVkIHN1Y2Nlc3NmdWxseVwiKTtcblxuICAgICAgcmV0dXJuIGNsYXVkZVJlc3BvbnNlO1xuXG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiQ2xhdWRlIHJldHVybmVkIGVtcHR5IHJlc3BvbnNlXCIpO1xuXG4gIH0gY2F0Y2ggKGNsYXVkZUVycm9yKSB7XG5cbiAgICBjb25zb2xlLmVycm9yKFwi4pqg77iPIENsYXVkZSBmYWlsZWQ6XCIsIGNsYXVkZUVycm9yKTtcblxuICAgIGNvbnNvbGUubG9nKFwi8J+UhCBTd2l0Y2hpbmcgdG8gR1BUIGFzIGZhbGxiYWNrLi4uXCIpO1xuXG5cblxuICAgIHRyeSB7XG5cbiAgICAgIGNvbnN0IGdwdFJlc3BvbnNlID0gYXdhaXQgY2FsbE9wZW5BSShhcmdzLnN5c3RlbSwgYXJncy51c2VyLCBtYXhUb2tlbnMpO1xuXG4gICAgICBjb25zb2xlLmxvZyhcIuKchSBHUFQgcmVzcG9uZGVkIHN1Y2Nlc3NmdWxseVwiKTtcblxuICAgICAgcmV0dXJuIGdwdFJlc3BvbnNlO1xuXG4gICAgfSBjYXRjaCAoZ3B0RXJyb3IpIHtcblxuICAgICAgY29uc29sZS5lcnJvcihcIuKdjCBCb3RoIHByb3ZpZGVycyBmYWlsZWRcIik7XG5cbiAgICAgIHRocm93IG5ldyBFcnJvcihgQm90aCBBSSBwcm92aWRlcnMgZmFpbGVkLiBDbGF1ZGU6ICR7Y2xhdWRlRXJyb3J9LCBHUFQ6ICR7Z3B0RXJyb3J9YCk7XG5cbiAgICB9XG5cbiAgfVxuXG59XG5cbi8vINCe0LHRgNCw0YLQvdCw0Y8g0YHQvtCy0LzQtdGB0YLQuNC80L7RgdGC0Ywg0YHQviDRgdGC0LDRgNGL0LwgQVBJXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjaGF0V2l0aFByb3ZpZGVyKFxuXG4gICAgcHJvdmlkZXI6IENoYXRQcm92aWRlcixcblxuICAgIGFyZ3M6IENoYXRBcmdzXG5cbik6IFByb21pc2U8c3RyaW5nPiB7XG5cbiAgY29uc29sZS5sb2coYOKaoO+4jyBjaGF0V2l0aFByb3ZpZGVyIGlzIGRlcHJlY2F0ZWQsIHVzZSBjaGF0V2l0aEFJIGluc3RlYWRgKTtcblxuXG5cbiAgLy8g0JjQs9C90L7RgNC40YDRg9C10Lwg0L/QsNGA0LDQvNC10YLRgCBwcm92aWRlciwg0LLRgdC10LPQtNCwINC40YHQv9C+0LvRjNC30YPQtdC8INC70L7Qs9C40LrRgyBDbGF1ZGUg4oaSIEdQVFxuXG4gIHJldHVybiBhd2FpdCBjaGF0V2l0aEFJKGFyZ3MpO1xuXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNhbGxBbnRocm9waWMoc3lzdGVtOiBzdHJpbmcsIHVzZXI6IHN0cmluZywgbWF4VG9rZW5zOiBudW1iZXIpOiBQcm9taXNlPHN0cmluZz4ge1xuXG4gIGlmICghcHJvY2Vzcy5lbnYuQU5USFJPUElDX0FQSV9LRVkpIHtcblxuICAgIHRocm93IG5ldyBFcnJvcihcIkFudGhyb3BpYyBBUEkga2V5IG5vdCBjb25maWd1cmVkXCIpO1xuXG4gIH1cblxuICBjb25zdCByZXMgPSBhd2FpdCBhbnRocm9waWMubWVzc2FnZXMuY3JlYXRlKHtcblxuICAgIG1vZGVsOiBwcm9jZXNzLmVudi5BTlRIUk9QSUNfTU9ERUwgfHwgXCJjbGF1ZGUtb3B1cy00LTEtMjAyNTA4MDVcIixcblxuICAgIG1heF90b2tlbnM6IE1hdGgubWluKG1heFRva2VucywgODE5MiksXG5cbiAgICB0ZW1wZXJhdHVyZTogMC4xLFxuXG4gICAgc3lzdGVtOiBzeXN0ZW0sXG5cbiAgICBtZXNzYWdlczogW3sgcm9sZTogXCJ1c2VyXCIsIGNvbnRlbnQ6IHVzZXIgfV0sXG5cbiAgfSk7XG5cbiAgY29uc3QgY29udGVudCA9IHJlcy5jb250ZW50Py5bMF07XG5cbiAgaWYgKGNvbnRlbnQgJiYgY29udGVudC50eXBlID09PSBcInRleHRcIiAmJiBjb250ZW50LnRleHQpIHtcblxuICAgIHJldHVybiBjb250ZW50LnRleHQ7XG5cbiAgfVxuXG5cblxuICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHJlc3BvbnNlIGZyb20gQW50aHJvcGljXCIpO1xuXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNhbGxPcGVuQUkoc3lzdGVtOiBzdHJpbmcsIHVzZXI6IHN0cmluZywgbWF4VG9rZW5zOiBudW1iZXIpOiBQcm9taXNlPHN0cmluZz4ge1xuXG4gIGlmICghcHJvY2Vzcy5lbnYuT1BFTkFJX0FQSV9LRVkpIHtcblxuICAgIHRocm93IG5ldyBFcnJvcihcIk9wZW5BSSBBUEkga2V5IG5vdCBjb25maWd1cmVkXCIpO1xuXG4gIH1cblxuICBjb25zdCByZXMgPSBhd2FpdCBvcGVuYWkuY2hhdC5jb21wbGV0aW9ucy5jcmVhdGUoe1xuXG4gICAgbW9kZWw6IHByb2Nlc3MuZW52Lk9QRU5BSV9DSEFUX01PREVMIHx8IFwiZ3B0LTQtdHVyYm8tcHJldmlld1wiLFxuXG4gICAgbWVzc2FnZXM6IFtcblxuICAgICAgeyByb2xlOiBcInN5c3RlbVwiLCBjb250ZW50OiBzeXN0ZW0gfSxcblxuICAgICAgeyByb2xlOiBcInVzZXJcIiwgY29udGVudDogdXNlciB9LFxuXG4gICAgXSxcblxuICAgIG1heF90b2tlbnM6IE1hdGgubWluKG1heFRva2VucywgODAwMCksXG5cbiAgICB0ZW1wZXJhdHVyZTogMC4xLFxuXG4gIH0pO1xuXG4gIGNvbnN0IGNvbnRlbnQgPSByZXMuY2hvaWNlc1swXT8ubWVzc2FnZT8uY29udGVudDtcblxuICBpZiAoY29udGVudCkge1xuXG4gICAgcmV0dXJuIGNvbnRlbnQ7XG5cbiAgfVxuXG5cblxuICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHJlc3BvbnNlIGZyb20gT3BlbkFJXCIpO1xuXG59Il0sIm5hbWVzIjpbIk9wZW5BSSIsIkFudGhyb3BpYyIsIm9wZW5haSIsImFwaUtleSIsInByb2Nlc3MiLCJlbnYiLCJPUEVOQUlfQVBJX0tFWSIsImFudGhyb3BpYyIsIkFOVEhST1BJQ19BUElfS0VZIiwiY2hhdFdpdGhBSSIsImFyZ3MiLCJtYXhUb2tlbnMiLCJmb3JjZVByb3ZpZGVyIiwiY2FsbE9wZW5BSSIsInN5c3RlbSIsInVzZXIiLCJjYWxsQW50aHJvcGljIiwiY29uc29sZSIsImxvZyIsImNsYXVkZVJlc3BvbnNlIiwidHJpbSIsImxlbmd0aCIsIkVycm9yIiwiY2xhdWRlRXJyb3IiLCJlcnJvciIsImdwdFJlc3BvbnNlIiwiZ3B0RXJyb3IiLCJjaGF0V2l0aFByb3ZpZGVyIiwicHJvdmlkZXIiLCJyZXMiLCJtZXNzYWdlcyIsImNyZWF0ZSIsIm1vZGVsIiwiQU5USFJPUElDX01PREVMIiwibWF4X3Rva2VucyIsIk1hdGgiLCJtaW4iLCJ0ZW1wZXJhdHVyZSIsInJvbGUiLCJjb250ZW50IiwidHlwZSIsInRleHQiLCJjaGF0IiwiY29tcGxldGlvbnMiLCJPUEVOQUlfQ0hBVF9NT0RFTCIsImNob2ljZXMiLCJtZXNzYWdlIl0sImlnbm9yZUxpc3QiOltdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./lib/modelProvider.ts\n");

/***/ }),

/***/ "(rsc)/./lib/perplexity.ts":
/*!***************************!*\
  !*** ./lib/perplexity.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   PerplexityClient: () => (/* binding */ PerplexityClient),\n/* harmony export */   enrichWithWebSearch: () => (/* binding */ enrichWithWebSearch),\n/* harmony export */   shouldSearchWeb: () => (/* binding */ shouldSearchWeb)\n/* harmony export */ });\n// lib/perplexity.ts\nclass PerplexityClient {\n    constructor(config){\n        this.baseUrl = 'https://api.perplexity.ai';\n        this.apiKey = config.apiKey || process.env.PERPLEXITY_API_KEY;\n        this.defaultModel = config.model || 'sonar-deep-research';\n    }\n    async search(query, options) {\n        try {\n            const requestBody = {\n                model: options?.model || this.defaultModel,\n                messages: [\n                    {\n                        role: 'system',\n                        content: 'You are a helpful search assistant. Provide accurate, up-to-date information with detailed sources and citations.'\n                    },\n                    {\n                        role: 'user',\n                        content: query\n                    }\n                ],\n                temperature: 0.2,\n                top_p: 0.9,\n                return_images: options?.returnImages ?? false,\n                return_related_questions: options?.returnRelated ?? true\n            };\n            // Add search mode if specified\n            if (options?.searchMode) {\n                requestBody.search_mode = options.searchMode;\n            }\n            // Add recency filter if specified\n            if (options?.searchRecencyFilter) {\n                requestBody.search_recency_filter = options.searchRecencyFilter;\n            }\n            // Add domain filter if specified\n            if (options?.searchDomainFilter && options.searchDomainFilter.length > 0) {\n                requestBody.search_domain_filter = options.searchDomainFilter;\n            }\n            const response = await fetch(`${this.baseUrl}/chat/completions`, {\n                method: 'POST',\n                headers: {\n                    'Authorization': `Bearer ${this.apiKey}`,\n                    'Content-Type': 'application/json'\n                },\n                body: JSON.stringify(requestBody)\n            });\n            if (!response.ok) {\n                const errorText = await response.text();\n                console.error('Perplexity error:', errorText);\n                throw new Error(`Perplexity API error: ${response.status}`);\n            }\n            const data = await response.json();\n            console.log('Perplexity raw response:', JSON.stringify(data, null, 2));\n            // Extract comprehensive metadata\n            const message = data.choices?.[0]?.message;\n            // Perplexity API returns citations as an array of URL strings\n            // Format: [\"https://example.com\", \"https://example2.com\"]\n            let citations = data.citations || [];\n            // Parse sources - Perplexity returns plain URLs\n            const sources = citations.filter((citation)=>citation) // Filter out null/undefined\n            .map((url, index)=>{\n                if (typeof url === 'string' && url.startsWith('http')) {\n                    try {\n                        const urlObj = new URL(url);\n                        const hostname = urlObj.hostname.replace('www.', '');\n                        // Create a readable title from hostname\n                        const title = hostname.split('.').slice(0, -1).map((word)=>word.charAt(0).toUpperCase() + word.slice(1)).join(' ') || hostname;\n                        return {\n                            title: title,\n                            url: url,\n                            snippet: '' // Perplexity doesn't provide snippets in citations\n                        };\n                    } catch (e) {\n                        console.error('Error parsing citation URL:', url, e);\n                        return null;\n                    }\n                }\n                return null;\n            }).filter((source)=>source !== null && !!source.url);\n            console.log('Parsed sources:', sources);\n            return {\n                answer: message?.content || '',\n                sources,\n                images: data.images || [],\n                relatedQuestions: data.related_questions || [],\n                model: requestBody.model,\n                usage: data.usage || {}\n            };\n        } catch (error) {\n            console.error('Perplexity search error:', error);\n            throw error;\n        }\n    }\n}\n// Smart detection функция\nfunction shouldSearchWeb(question, documentContext, forceSearch = false) {\n    // Если форсированный поиск - всегда используем\n    if (forceSearch) return true;\n    const lowerQ = question.toLowerCase();\n    // Паттерны, требующие веб-поиска\n    const webPatterns = [\n        /последн(ие|ий|яя|ее) новост/i,\n        /текущ(ий|ая|ее|ие)/i,\n        /сегодня|вчера|на этой неделе/i,\n        /актуальн(ый|ая|ое|ые)/i,\n        /современн(ый|ая|ое|ые)/i,\n        /тренд(ы|ов)/i,\n        /прогноз на/i,\n        /что происходит с/i,\n        /конкурент(ы|ов|ами)/i,\n        /рыночн(ые|ая) (цен|стоимост|ставк)/i,\n        /курс (валют|доллара|евро)/i,\n        /законодательств|регулирован/i,\n        /(сравни|compare).*(рынк|market|индустр|industry)/i\n    ];\n    // Проверяем паттерны\n    const needsWeb = webPatterns.some((pattern)=>pattern.test(lowerQ));\n    // Проверяем качество документального контекста\n    const hasGoodDocContext = documentContext.some((d)=>d.similarity > 0.75);\n    const avgSimilarity = documentContext.reduce((sum, d)=>sum + d.similarity, 0) / (documentContext.length || 1);\n    // Логика принятия решения\n    return needsWeb || !hasGoodDocContext && avgSimilarity < 0.5;\n}\n// Функция объединения контекстов\nasync function enrichWithWebSearch(question, documentContext, options) {\n    // Выбираем модель в зависимости от роли\n    const modelForRole = selectModelForRole(options?.role);\n    const client = new PerplexityClient({\n        apiKey: process.env.PERPLEXITY_API_KEY,\n        model: modelForRole\n    });\n    // Формируем контекстный запрос с учетом контекста документов\n    let contextualQuery = question;\n    if (documentContext.length > 0) {\n        const topics = extractTopics(documentContext);\n        if (topics.length > 0) {\n            contextualQuery = `${question}\\n\\nContext: Analysis related to ${topics.join(', ')}.`;\n        }\n    }\n    // Выполняем поиск с расширенными параметрами\n    const searchOptions = {\n        ...options,\n        returnImages: options?.returnImages ?? true,\n        returnRelated: options?.returnRelated ?? true,\n        model: modelForRole\n    };\n    const webResults = await client.search(contextualQuery, searchOptions);\n    return {\n        webAnswer: webResults.answer,\n        webSources: webResults.sources,\n        webImages: webResults.images || [],\n        relatedQuestions: webResults.relatedQuestions || [],\n        combinedContext: mergeContexts(documentContext, webResults),\n        confidence: calculateCombinedConfidence(documentContext, webResults),\n        model: webResults.model,\n        usage: webResults.usage\n    };\n}\n// Выбор модели в зависимости от роли AI\nfunction selectModelForRole(role) {\n    if (!role) return 'sonar-deep-research';\n    const roleLower = role.toLowerCase();\n    // CFO, Analyst, Lawyer требуют глубокого анализа\n    if (roleLower.includes('cfo') || roleLower.includes('analyst') || roleLower.includes('lawyer')) {\n        return 'sonar-deep-research';\n    }\n    // Investor требует reasoning для оценки потенциала\n    if (roleLower.includes('investor')) {\n        return 'sonar-reasoning-pro';\n    }\n    // По умолчанию используем deep research\n    return 'sonar-deep-research';\n}\nfunction extractTopics(context) {\n    // Извлекаем ключевые темы из контекста\n    const topics = new Set();\n    context.forEach((chunk)=>{\n        // Простая эвристика - можно улучшить с NLP\n        const matches = chunk.text.match(/[A-Z][a-z]+ [A-Z][a-z]+/g) || [];\n        matches.forEach((m)=>topics.add(m));\n    });\n    return Array.from(topics).slice(0, 5);\n}\nfunction mergeContexts(docContext, webResults) {\n    return `\nDOCUMENT CONTEXT:\n${docContext.map((d)=>d.text).join('\\n')}\n\nWEB CONTEXT (Real-time):\n${webResults.answer}\n\nSOURCES:\n${webResults.sources.map((s)=>`- ${s.url}`).join('\\n')}\n  `;\n}\nfunction calculateCombinedConfidence(docContext, webResults) {\n    const docConfidence = Math.max(...docContext.map((d)=>d.similarity), 0);\n    const webConfidence = webResults.sources?.length > 0 ? 0.8 : 0.5;\n    return Math.max(docConfidence, webConfidence);\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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RUFBRThCLFdBQVduRCxPQUFPLENBQUNHLEdBQUcsQ0FBQyxDQUFDcUUsSUFBVyxDQUFDLEVBQUUsRUFBRUEsRUFBRXBFLEdBQUcsRUFBRSxFQUFFYSxJQUFJLENBQUMsTUFBTTtFQUM1RCxDQUFDO0FBQ0g7QUFFQSxTQUFTeUMsNEJBQTRCYSxVQUFpQixFQUFFcEIsVUFBZTtJQUNuRSxNQUFNc0IsZ0JBQWdCQyxLQUFLQyxHQUFHLElBQUlKLFdBQVdwRSxHQUFHLENBQUNtQyxDQUFBQSxJQUFLQSxFQUFFQyxVQUFVLEdBQUc7SUFDckUsTUFBTXFDLGdCQUFnQnpCLFdBQVduRCxPQUFPLEVBQUV0QixTQUFTLElBQUksTUFBTTtJQUM3RCxPQUFPZ0csS0FBS0MsR0FBRyxDQUFDRixlQUFlRztBQUNuQyIsInNvdXJjZXMiOlsid2VicGFjazovLy8uL2xpYi9wZXJwbGV4aXR5LnRzPzMxM2IiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gbGliL3BlcnBsZXhpdHkudHNcblxuaW50ZXJmYWNlIFBlcnBsZXhpdHlDb25maWcge1xuICAgIGFwaUtleTogc3RyaW5nO1xuICAgIG1vZGVsPzogJ3NvbmFyJyB8ICdzb25hci1wcm8nIHwgJ3NvbmFyLWRlZXAtcmVzZWFyY2gnIHwgJ3NvbmFyLXJlYXNvbmluZycgfCAnc29uYXItcmVhc29uaW5nLXBybyc7XG4gICAgbWF4VG9rZW5zPzogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgU2VhcmNoT3B0aW9ucyB7XG4gICAgc2VhcmNoRG9tYWluRmlsdGVyPzogc3RyaW5nW107XG4gICAgcmV0dXJuSW1hZ2VzPzogYm9vbGVhbjtcbiAgICByZXR1cm5SZWxhdGVkPzogYm9vbGVhbjtcbiAgICBzZWFyY2hSZWNlbmN5RmlsdGVyPzogJ2RheScgfCAnd2VlaycgfCAnbW9udGgnIHwgJ3llYXInO1xuICAgIHNlYXJjaE1vZGU/OiAnd2ViJyB8ICdhY2FkZW1pYycgfCAnc2VjJztcbiAgICBtb2RlbD86ICdzb25hcicgfCAnc29uYXItcHJvJyB8ICdzb25hci1kZWVwLXJlc2VhcmNoJyB8ICdzb25hci1yZWFzb25pbmcnIHwgJ3NvbmFyLXJlYXNvbmluZy1wcm8nO1xufVxuXG5pbnRlcmZhY2UgV2ViU291cmNlIHtcbiAgICB0aXRsZT86IHN0cmluZztcbiAgICB1cmw/OiBzdHJpbmc7XG4gICAgc25pcHBldD86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIFBlcnBsZXhpdHlDbGllbnQge1xuICAgIHByaXZhdGUgYXBpS2V5OiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBiYXNlVXJsID0gJ2h0dHBzOi8vYXBpLnBlcnBsZXhpdHkuYWknO1xuICAgIHByaXZhdGUgZGVmYXVsdE1vZGVsOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IFBlcnBsZXhpdHlDb25maWcpIHtcbiAgICAgICAgdGhpcy5hcGlLZXkgPSBjb25maWcuYXBpS2V5IHx8IHByb2Nlc3MuZW52LlBFUlBMRVhJVFlfQVBJX0tFWSE7XG4gICAgICAgIHRoaXMuZGVmYXVsdE1vZGVsID0gY29uZmlnLm1vZGVsIHx8ICdzb25hci1kZWVwLXJlc2VhcmNoJztcbiAgICB9XG5cbiAgICBhc3luYyBzZWFyY2gocXVlcnk6IHN0cmluZywgb3B0aW9ucz86IFNlYXJjaE9wdGlvbnMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlcXVlc3RCb2R5OiBhbnkgPSB7XG4gICAgICAgICAgICAgICAgbW9kZWw6IG9wdGlvbnM/Lm1vZGVsIHx8IHRoaXMuZGVmYXVsdE1vZGVsLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2VzOiBbXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvbGU6ICdzeXN0ZW0nLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudDogJ1lvdSBhcmUgYSBoZWxwZnVsIHNlYXJjaCBhc3Npc3RhbnQuIFByb3ZpZGUgYWNjdXJhdGUsIHVwLXRvLWRhdGUgaW5mb3JtYXRpb24gd2l0aCBkZXRhaWxlZCBzb3VyY2VzIGFuZCBjaXRhdGlvbnMuJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICByb2xlOiAndXNlcicsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50OiBxdWVyeVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICB0ZW1wZXJhdHVyZTogMC4yLFxuICAgICAgICAgICAgICAgIHRvcF9wOiAwLjksXG4gICAgICAgICAgICAgICAgcmV0dXJuX2ltYWdlczogb3B0aW9ucz8ucmV0dXJuSW1hZ2VzID8/IGZhbHNlLFxuICAgICAgICAgICAgICAgIHJldHVybl9yZWxhdGVkX3F1ZXN0aW9uczogb3B0aW9ucz8ucmV0dXJuUmVsYXRlZCA/PyB0cnVlLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgLy8gQWRkIHNlYXJjaCBtb2RlIGlmIHNwZWNpZmllZFxuICAgICAgICAgICAgaWYgKG9wdGlvbnM/LnNlYXJjaE1vZGUpIHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0Qm9keS5zZWFyY2hfbW9kZSA9IG9wdGlvbnMuc2VhcmNoTW9kZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gQWRkIHJlY2VuY3kgZmlsdGVyIGlmIHNwZWNpZmllZFxuICAgICAgICAgICAgaWYgKG9wdGlvbnM/LnNlYXJjaFJlY2VuY3lGaWx0ZXIpIHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0Qm9keS5zZWFyY2hfcmVjZW5jeV9maWx0ZXIgPSBvcHRpb25zLnNlYXJjaFJlY2VuY3lGaWx0ZXI7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEFkZCBkb21haW4gZmlsdGVyIGlmIHNwZWNpZmllZFxuICAgICAgICAgICAgaWYgKG9wdGlvbnM/LnNlYXJjaERvbWFpbkZpbHRlciAmJiBvcHRpb25zLnNlYXJjaERvbWFpbkZpbHRlci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdEJvZHkuc2VhcmNoX2RvbWFpbl9maWx0ZXIgPSBvcHRpb25zLnNlYXJjaERvbWFpbkZpbHRlcjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHt0aGlzLmJhc2VVcmx9L2NoYXQvY29tcGxldGlvbnNgLCB7XG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHt0aGlzLmFwaUtleX1gLFxuICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVxdWVzdEJvZHkpXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yVGV4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdQZXJwbGV4aXR5IGVycm9yOicsIGVycm9yVGV4dCk7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQZXJwbGV4aXR5IEFQSSBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXN9YCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQZXJwbGV4aXR5IHJhdyByZXNwb25zZTonLCBKU09OLnN0cmluZ2lmeShkYXRhLCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgIC8vIEV4dHJhY3QgY29tcHJlaGVuc2l2ZSBtZXRhZGF0YVxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGRhdGEuY2hvaWNlcz8uWzBdPy5tZXNzYWdlO1xuXG4gICAgICAgICAgICAvLyBQZXJwbGV4aXR5IEFQSSByZXR1cm5zIGNpdGF0aW9ucyBhcyBhbiBhcnJheSBvZiBVUkwgc3RyaW5nc1xuICAgICAgICAgICAgLy8gRm9ybWF0OiBbXCJodHRwczovL2V4YW1wbGUuY29tXCIsIFwiaHR0cHM6Ly9leGFtcGxlMi5jb21cIl1cbiAgICAgICAgICAgIGxldCBjaXRhdGlvbnMgPSBkYXRhLmNpdGF0aW9ucyB8fCBbXTtcblxuICAgICAgICAgICAgLy8gUGFyc2Ugc291cmNlcyAtIFBlcnBsZXhpdHkgcmV0dXJucyBwbGFpbiBVUkxzXG4gICAgICAgICAgICBjb25zdCBzb3VyY2VzOiBXZWJTb3VyY2VbXSA9IGNpdGF0aW9uc1xuICAgICAgICAgICAgICAgIC5maWx0ZXIoKGNpdGF0aW9uOiBhbnkpID0+IGNpdGF0aW9uKSAvLyBGaWx0ZXIgb3V0IG51bGwvdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgLm1hcCgodXJsOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB1cmwgPT09ICdzdHJpbmcnICYmIHVybC5zdGFydHNXaXRoKCdodHRwJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXJsT2JqID0gbmV3IFVSTCh1cmwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGhvc3RuYW1lID0gdXJsT2JqLmhvc3RuYW1lLnJlcGxhY2UoJ3d3dy4nLCAnJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDcmVhdGUgYSByZWFkYWJsZSB0aXRsZSBmcm9tIGhvc3RuYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGl0bGUgPSBob3N0bmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc3BsaXQoJy4nKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc2xpY2UoMCwgLTEpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAod29yZCA9PiB3b3JkLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgd29yZC5zbGljZSgxKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmpvaW4oJyAnKSB8fCBob3N0bmFtZTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiB0aXRsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuaXBwZXQ6ICcnIC8vIFBlcnBsZXhpdHkgZG9lc24ndCBwcm92aWRlIHNuaXBwZXRzIGluIGNpdGF0aW9uc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgcGFyc2luZyBjaXRhdGlvbiBVUkw6JywgdXJsLCBlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoKHNvdXJjZSk6IHNvdXJjZSBpcyBXZWJTb3VyY2UgPT4gc291cmNlICE9PSBudWxsICYmICEhc291cmNlLnVybCk7XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQYXJzZWQgc291cmNlczonLCBzb3VyY2VzKTtcblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBhbnN3ZXI6IG1lc3NhZ2U/LmNvbnRlbnQgfHwgJycsXG4gICAgICAgICAgICAgICAgc291cmNlcyxcbiAgICAgICAgICAgICAgICBpbWFnZXM6IGRhdGEuaW1hZ2VzIHx8IFtdLFxuICAgICAgICAgICAgICAgIHJlbGF0ZWRRdWVzdGlvbnM6IGRhdGEucmVsYXRlZF9xdWVzdGlvbnMgfHwgW10sXG4gICAgICAgICAgICAgICAgbW9kZWw6IHJlcXVlc3RCb2R5Lm1vZGVsLFxuICAgICAgICAgICAgICAgIHVzYWdlOiBkYXRhLnVzYWdlIHx8IHt9XG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignUGVycGxleGl0eSBzZWFyY2ggZXJyb3I6JywgZXJyb3IpO1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8vIFNtYXJ0IGRldGVjdGlvbiDRhNGD0L3QutGG0LjRj1xuZXhwb3J0IGZ1bmN0aW9uIHNob3VsZFNlYXJjaFdlYihcbiAgICBxdWVzdGlvbjogc3RyaW5nLFxuICAgIGRvY3VtZW50Q29udGV4dDogYW55W10sXG4gICAgZm9yY2VTZWFyY2g6IGJvb2xlYW4gPSBmYWxzZVxuKTogYm9vbGVhbiB7XG4gICAgLy8g0JXRgdC70Lgg0YTQvtGA0YHQuNGA0L7QstCw0L3QvdGL0Lkg0L/QvtC40YHQuiAtINCy0YHQtdCz0LTQsCDQuNGB0L/QvtC70YzQt9GD0LXQvFxuICAgIGlmIChmb3JjZVNlYXJjaCkgcmV0dXJuIHRydWU7XG5cbiAgICBjb25zdCBsb3dlclEgPSBxdWVzdGlvbi50b0xvd2VyQ2FzZSgpO1xuXG4gICAgLy8g0J/QsNGC0YLQtdGA0L3Riywg0YLRgNC10LHRg9GO0YnQuNC1INCy0LXQsS3Qv9C+0LjRgdC60LBcbiAgICBjb25zdCB3ZWJQYXR0ZXJucyA9IFtcbiAgICAgICAgL9C/0L7RgdC70LXQtNC9KNC40LV80LjQuXzRj9GPfNC10LUpINC90L7QstC+0YHRgi9pLFxuICAgICAgICAv0YLQtdC60YPRiSjQuNC5fNCw0Y980LXQtXzQuNC1KS9pLFxuICAgICAgICAv0YHQtdCz0L7QtNC90Y980LLRh9C10YDQsHzQvdCwINGN0YLQvtC5INC90LXQtNC10LvQtS9pLFxuICAgICAgICAv0LDQutGC0YPQsNC70YzQvSjRi9C5fNCw0Y980L7QtXzRi9C1KS9pLFxuICAgICAgICAv0YHQvtCy0YDQtdC80LXQvdC9KNGL0Ll80LDRj3zQvtC1fNGL0LUpL2ksXG4gICAgICAgIC/RgtGA0LXQvdC0KNGLfNC+0LIpL2ksXG4gICAgICAgIC/Qv9GA0L7Qs9C90L7QtyDQvdCwL2ksXG4gICAgICAgIC/Rh9GC0L4g0L/RgNC+0LjRgdGF0L7QtNC40YIg0YEvaSxcbiAgICAgICAgL9C60L7QvdC60YPRgNC10L3RgijRi3zQvtCyfNCw0LzQuCkvaSxcbiAgICAgICAgL9GA0YvQvdC+0YfQvSjRi9C1fNCw0Y8pICjRhtC10L180YHRgtC+0LjQvNC+0YHRgnzRgdGC0LDQstC6KS9pLFxuICAgICAgICAv0LrRg9GA0YEgKNCy0LDQu9GO0YJ80LTQvtC70LvQsNGA0LB80LXQstGA0L4pL2ksXG4gICAgICAgIC/Qt9Cw0LrQvtC90L7QtNCw0YLQtdC70YzRgdGC0LJ80YDQtdCz0YPQu9C40YDQvtCy0LDQvS9pLFxuICAgICAgICAvKNGB0YDQsNCy0L3QuHxjb21wYXJlKS4qKNGA0YvQvdC6fG1hcmtldHzQuNC90LTRg9GB0YLRgHxpbmR1c3RyeSkvaVxuICAgIF07XG5cbiAgICAvLyDQn9GA0L7QstC10YDRj9C10Lwg0L/QsNGC0YLQtdGA0L3Ri1xuICAgIGNvbnN0IG5lZWRzV2ViID0gd2ViUGF0dGVybnMuc29tZShwYXR0ZXJuID0+IHBhdHRlcm4udGVzdChsb3dlclEpKTtcblxuICAgIC8vINCf0YDQvtCy0LXRgNGP0LXQvCDQutCw0YfQtdGB0YLQstC+INC00L7QutGD0LzQtdC90YLQsNC70YzQvdC+0LPQviDQutC+0L3RgtC10LrRgdGC0LBcbiAgICBjb25zdCBoYXNHb29kRG9jQ29udGV4dCA9IGRvY3VtZW50Q29udGV4dC5zb21lKGQgPT4gZC5zaW1pbGFyaXR5ID4gMC43NSk7XG4gICAgY29uc3QgYXZnU2ltaWxhcml0eSA9IGRvY3VtZW50Q29udGV4dC5yZWR1Y2UoKHN1bSwgZCkgPT4gc3VtICsgZC5zaW1pbGFyaXR5LCAwKSAvIChkb2N1bWVudENvbnRleHQubGVuZ3RoIHx8IDEpO1xuXG4gICAgLy8g0JvQvtCz0LjQutCwINC/0YDQuNC90Y/RgtC40Y8g0YDQtdGI0LXQvdC40Y9cbiAgICByZXR1cm4gbmVlZHNXZWIgfHwgKCFoYXNHb29kRG9jQ29udGV4dCAmJiBhdmdTaW1pbGFyaXR5IDwgMC41KTtcbn1cblxuLy8g0KTRg9C90LrRhtC40Y8g0L7QsdGK0LXQtNC40L3QtdC90LjRjyDQutC+0L3RgtC10LrRgdGC0L7QslxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGVucmljaFdpdGhXZWJTZWFyY2goXG4gICAgcXVlc3Rpb246IHN0cmluZyxcbiAgICBkb2N1bWVudENvbnRleHQ6IGFueVtdLFxuICAgIG9wdGlvbnM/OiBTZWFyY2hPcHRpb25zICYgeyByb2xlPzogc3RyaW5nIH1cbik6IFByb21pc2U8YW55PiB7XG4gICAgLy8g0JLRi9Cx0LjRgNCw0LXQvCDQvNC+0LTQtdC70Ywg0LIg0LfQsNCy0LjRgdC40LzQvtGB0YLQuCDQvtGCINGA0L7Qu9C4XG4gICAgY29uc3QgbW9kZWxGb3JSb2xlID0gc2VsZWN0TW9kZWxGb3JSb2xlKG9wdGlvbnM/LnJvbGUpO1xuXG4gICAgY29uc3QgY2xpZW50ID0gbmV3IFBlcnBsZXhpdHlDbGllbnQoe1xuICAgICAgICBhcGlLZXk6IHByb2Nlc3MuZW52LlBFUlBMRVhJVFlfQVBJX0tFWSEsXG4gICAgICAgIG1vZGVsOiBtb2RlbEZvclJvbGVcbiAgICB9KTtcblxuICAgIC8vINCk0L7RgNC80LjRgNGD0LXQvCDQutC+0L3RgtC10LrRgdGC0L3Ri9C5INC30LDQv9GA0L7RgSDRgSDRg9GH0LXRgtC+0Lwg0LrQvtC90YLQtdC60YHRgtCwINC00L7QutGD0LzQtdC90YLQvtCyXG4gICAgbGV0IGNvbnRleHR1YWxRdWVyeSA9IHF1ZXN0aW9uO1xuXG4gICAgaWYgKGRvY3VtZW50Q29udGV4dC5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IHRvcGljcyA9IGV4dHJhY3RUb3BpY3MoZG9jdW1lbnRDb250ZXh0KTtcbiAgICAgICAgaWYgKHRvcGljcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb250ZXh0dWFsUXVlcnkgPSBgJHtxdWVzdGlvbn1cXG5cXG5Db250ZXh0OiBBbmFseXNpcyByZWxhdGVkIHRvICR7dG9waWNzLmpvaW4oJywgJyl9LmA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyDQktGL0L/QvtC70L3Rj9C10Lwg0L/QvtC40YHQuiDRgSDRgNCw0YHRiNC40YDQtdC90L3Ri9C80Lgg0L/QsNGA0LDQvNC10YLRgNCw0LzQuFxuICAgIGNvbnN0IHNlYXJjaE9wdGlvbnM6IFNlYXJjaE9wdGlvbnMgPSB7XG4gICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgIHJldHVybkltYWdlczogb3B0aW9ucz8ucmV0dXJuSW1hZ2VzID8/IHRydWUsXG4gICAgICAgIHJldHVyblJlbGF0ZWQ6IG9wdGlvbnM/LnJldHVyblJlbGF0ZWQgPz8gdHJ1ZSxcbiAgICAgICAgbW9kZWw6IG1vZGVsRm9yUm9sZVxuICAgIH07XG5cbiAgICBjb25zdCB3ZWJSZXN1bHRzID0gYXdhaXQgY2xpZW50LnNlYXJjaChjb250ZXh0dWFsUXVlcnksIHNlYXJjaE9wdGlvbnMpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgd2ViQW5zd2VyOiB3ZWJSZXN1bHRzLmFuc3dlcixcbiAgICAgICAgd2ViU291cmNlczogd2ViUmVzdWx0cy5zb3VyY2VzLFxuICAgICAgICB3ZWJJbWFnZXM6IHdlYlJlc3VsdHMuaW1hZ2VzIHx8IFtdLFxuICAgICAgICByZWxhdGVkUXVlc3Rpb25zOiB3ZWJSZXN1bHRzLnJlbGF0ZWRRdWVzdGlvbnMgfHwgW10sXG4gICAgICAgIGNvbWJpbmVkQ29udGV4dDogbWVyZ2VDb250ZXh0cyhkb2N1bWVudENvbnRleHQsIHdlYlJlc3VsdHMpLFxuICAgICAgICBjb25maWRlbmNlOiBjYWxjdWxhdGVDb21iaW5lZENvbmZpZGVuY2UoZG9jdW1lbnRDb250ZXh0LCB3ZWJSZXN1bHRzKSxcbiAgICAgICAgbW9kZWw6IHdlYlJlc3VsdHMubW9kZWwsXG4gICAgICAgIHVzYWdlOiB3ZWJSZXN1bHRzLnVzYWdlXG4gICAgfTtcbn1cblxuLy8g0JLRi9Cx0L7RgCDQvNC+0LTQtdC70Lgg0LIg0LfQsNCy0LjRgdC40LzQvtGB0YLQuCDQvtGCINGA0L7Qu9C4IEFJXG5mdW5jdGlvbiBzZWxlY3RNb2RlbEZvclJvbGUocm9sZT86IHN0cmluZyk6ICdzb25hcicgfCAnc29uYXItcHJvJyB8ICdzb25hci1kZWVwLXJlc2VhcmNoJyB8ICdzb25hci1yZWFzb25pbmcnIHwgJ3NvbmFyLXJlYXNvbmluZy1wcm8nIHtcbiAgICBpZiAoIXJvbGUpIHJldHVybiAnc29uYXItZGVlcC1yZXNlYXJjaCc7XG5cbiAgICBjb25zdCByb2xlTG93ZXIgPSByb2xlLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAvLyBDRk8sIEFuYWx5c3QsIExhd3llciDRgtGA0LXQsdGD0Y7RgiDQs9C70YPQsdC+0LrQvtCz0L4g0LDQvdCw0LvQuNC30LBcbiAgICBpZiAocm9sZUxvd2VyLmluY2x1ZGVzKCdjZm8nKSB8fCByb2xlTG93ZXIuaW5jbHVkZXMoJ2FuYWx5c3QnKSB8fCByb2xlTG93ZXIuaW5jbHVkZXMoJ2xhd3llcicpKSB7XG4gICAgICAgIHJldHVybiAnc29uYXItZGVlcC1yZXNlYXJjaCc7XG4gICAgfVxuXG4gICAgLy8gSW52ZXN0b3Ig0YLRgNC10LHRg9C10YIgcmVhc29uaW5nINC00LvRjyDQvtGG0LXQvdC60Lgg0L/QvtGC0LXQvdGG0LjQsNC70LBcbiAgICBpZiAocm9sZUxvd2VyLmluY2x1ZGVzKCdpbnZlc3RvcicpKSB7XG4gICAgICAgIHJldHVybiAnc29uYXItcmVhc29uaW5nLXBybyc7XG4gICAgfVxuXG4gICAgLy8g0J/QviDRg9C80L7Qu9GH0LDQvdC40Y4g0LjRgdC/0L7Qu9GM0LfRg9C10LwgZGVlcCByZXNlYXJjaFxuICAgIHJldHVybiAnc29uYXItZGVlcC1yZXNlYXJjaCc7XG59XG5cbmZ1bmN0aW9uIGV4dHJhY3RUb3BpY3MoY29udGV4dDogYW55W10pOiBzdHJpbmdbXSB7XG4gICAgLy8g0JjQt9Cy0LvQtdC60LDQtdC8INC60LvRjtGH0LXQstGL0LUg0YLQtdC80Ysg0LjQtyDQutC+0L3RgtC10LrRgdGC0LBcbiAgICBjb25zdCB0b3BpY3MgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICBjb250ZXh0LmZvckVhY2goY2h1bmsgPT4ge1xuICAgICAgICAvLyDQn9GA0L7RgdGC0LDRjyDRjdCy0YDQuNGB0YLQuNC60LAgLSDQvNC+0LbQvdC+INGD0LvRg9GH0YjQuNGC0Ywg0YEgTkxQXG4gICAgICAgIGNvbnN0IG1hdGNoZXMgPSBjaHVuay50ZXh0Lm1hdGNoKC9bQS1aXVthLXpdKyBbQS1aXVthLXpdKy9nKSB8fCBbXTtcbiAgICAgICAgbWF0Y2hlcy5mb3JFYWNoKG0gPT4gdG9waWNzLmFkZChtKSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIEFycmF5LmZyb20odG9waWNzKS5zbGljZSgwLCA1KTtcbn1cblxuZnVuY3Rpb24gbWVyZ2VDb250ZXh0cyhkb2NDb250ZXh0OiBhbnlbXSwgd2ViUmVzdWx0czogYW55KTogc3RyaW5nIHtcbiAgICByZXR1cm4gYFxuRE9DVU1FTlQgQ09OVEVYVDpcbiR7ZG9jQ29udGV4dC5tYXAoZCA9PiBkLnRleHQpLmpvaW4oJ1xcbicpfVxuXG5XRUIgQ09OVEVYVCAoUmVhbC10aW1lKTpcbiR7d2ViUmVzdWx0cy5hbnN3ZXJ9XG5cblNPVVJDRVM6XG4ke3dlYlJlc3VsdHMuc291cmNlcy5tYXAoKHM6IGFueSkgPT4gYC0gJHtzLnVybH1gKS5qb2luKCdcXG4nKX1cbiAgYDtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlQ29tYmluZWRDb25maWRlbmNlKGRvY0NvbnRleHQ6IGFueVtdLCB3ZWJSZXN1bHRzOiBhbnkpOiBudW1iZXIge1xuICAgIGNvbnN0IGRvY0NvbmZpZGVuY2UgPSBNYXRoLm1heCguLi5kb2NDb250ZXh0Lm1hcChkID0+IGQuc2ltaWxhcml0eSksIDApO1xuICAgIGNvbnN0IHdlYkNvbmZpZGVuY2UgPSB3ZWJSZXN1bHRzLnNvdXJjZXM/Lmxlbmd0aCA+IDAgPyAwLjggOiAwLjU7XG4gICAgcmV0dXJuIE1hdGgubWF4KGRvY0NvbmZpZGVuY2UsIHdlYkNvbmZpZGVuY2UpO1xufSJdLCJuYW1lcyI6WyJQZXJwbGV4aXR5Q2xpZW50IiwiY29uc3RydWN0b3IiLCJjb25maWciLCJiYXNlVXJsIiwiYXBpS2V5IiwicHJvY2VzcyIsImVudiIsIlBFUlBMRVhJVFlfQVBJX0tFWSIsImRlZmF1bHRNb2RlbCIsIm1vZGVsIiwic2VhcmNoIiwicXVlcnkiLCJvcHRpb25zIiwicmVxdWVzdEJvZHkiLCJtZXNzYWdlcyIsInJvbGUiLCJjb250ZW50IiwidGVtcGVyYXR1cmUiLCJ0b3BfcCIsInJldHVybl9pbWFnZXMiLCJyZXR1cm5JbWFnZXMiLCJyZXR1cm5fcmVsYXRlZF9xdWVzdGlvbnMiLCJyZXR1cm5SZWxhdGVkIiwic2VhcmNoTW9kZSIsInNlYXJjaF9tb2RlIiwic2VhcmNoUmVjZW5jeUZpbHRlciIsInNlYXJjaF9yZWNlbmN5X2ZpbHRlciIsInNlYXJjaERvbWFpbkZpbHRlciIsImxlbmd0aCIsInNlYXJjaF9kb21haW5fZmlsdGVyIiwicmVzcG9uc2UiLCJmZXRjaCIsIm1ldGhvZCIsImhlYWRlcnMiLCJib2R5IiwiSlNPTiIsInN0cmluZ2lmeSIsIm9rIiwiZXJyb3JUZXh0IiwidGV4dCIsImNvbnNvbGUiLCJlcnJvciIsIkVycm9yIiwic3RhdHVzIiwiZGF0YSIsImpzb24iLCJsb2ciLCJtZXNzYWdlIiwiY2hvaWNlcyIsImNpdGF0aW9ucyIsInNvdXJjZXMiLCJmaWx0ZXIiLCJjaXRhdGlvbiIsIm1hcCIsInVybCIsImluZGV4Iiwic3RhcnRzV2l0aCIsInVybE9iaiIsIlVSTCIsImhvc3RuYW1lIiwicmVwbGFjZSIsInRpdGxlIiwic3BsaXQiLCJzbGljZSIsIndvcmQiLCJjaGFyQXQiLCJ0b1VwcGVyQ2FzZSIsImpvaW4iLCJzbmlwcGV0IiwiZSIsInNvdXJjZSIsImFuc3dlciIsImltYWdlcyIsInJlbGF0ZWRRdWVzdGlvbnMiLCJyZWxhdGVkX3F1ZXN0aW9ucyIsInVzYWdlIiwic2hvdWxkU2VhcmNoV2ViIiwicXVlc3Rpb24iLCJkb2N1bWVudENvbnRleHQiLCJmb3JjZVNlYXJjaCIsImxvd2VyUSIsInRvTG93ZXJDYXNlIiwid2ViUGF0dGVybnMiLCJuZWVkc1dlYiIsInNvbWUiLCJwYXR0ZXJuIiwidGVzdCIsImhhc0dvb2REb2NDb250ZXh0IiwiZCIsInNpbWlsYXJpdHkiLCJhdmdTaW1pbGFyaXR5IiwicmVkdWNlIiwic3VtIiwiZW5yaWNoV2l0aFdlYlNlYXJjaCIsIm1vZGVsRm9yUm9sZSIsInNlbGVjdE1vZGVsRm9yUm9sZSIsImNsaWVudCIsImNvbnRleHR1YWxRdWVyeSIsInRvcGljcyIsImV4dHJhY3RUb3BpY3MiLCJzZWFyY2hPcHRpb25zIiwid2ViUmVzdWx0cyIsIndlYkFuc3dlciIsIndlYlNvdXJjZXMiLCJ3ZWJJbWFnZXMiLCJjb21iaW5lZENvbnRleHQiLCJtZXJnZUNvbnRleHRzIiwiY29uZmlkZW5jZSIsImNhbGN1bGF0ZUNvbWJpbmVkQ29uZmlkZW5jZSIsInJvbGVMb3dlciIsImluY2x1ZGVzIiwiY29udGV4dCIsIlNldCIsImZvckVhY2giLCJjaHVuayIsIm1hdGNoZXMiLCJtYXRjaCIsIm0iLCJhZGQiLCJBcnJheSIsImZyb20iLCJkb2NDb250ZXh0IiwicyIsImRvY0NvbmZpZGVuY2UiLCJNYXRoIiwibWF4Iiwid2ViQ29uZmlkZW5jZSJdLCJpZ25vcmVMaXN0IjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./lib/perplexity.ts\n");

/***/ }),

/***/ "(rsc)/./lib/prompt.ts":
/*!***********************!*\
  !*** ./lib/prompt.ts ***!
  \***********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   ROLE_PROMPTS: () => (/* binding */ ROLE_PROMPTS),\n/* harmony export */   SYSTEM_RAG: () => (/* binding */ SYSTEM_RAG),\n/* harmony export */   TASK_TYPES: () => (/* binding */ TASK_TYPES),\n/* harmony export */   analyzeClarificationNeed: () => (/* binding */ analyzeClarificationNeed),\n/* harmony export */   buildAutoSummaryPrompt: () => (/* binding */ buildAutoSummaryPrompt),\n/* harmony export */   buildCriticalAnalysisPrompt: () => (/* binding */ buildCriticalAnalysisPrompt),\n/* harmony export */   buildDocumentCreationPrompt: () => (/* binding */ buildDocumentCreationPrompt),\n/* harmony export */   buildUserPrompt: () => (/* binding */ buildUserPrompt),\n/* harmony export */   detectTaskType: () => (/* binding */ detectTaskType),\n/* harmony export */   mergeQuestionWithClarifications: () => (/* binding */ mergeQuestionWithClarifications)\n/* harmony export */ });\n// lib/prompt.ts\n// Основной системный промпт - более гибкий и креативный\nconst SYSTEM_RAG = `You are an advanced AI assistant with document analysis capabilities and creative problem-solving skills.\n\nWORKING MODES:\n1. DOCUMENT ANALYSIS: When answering questions about uploaded documents, use provided context\n2. CREATIVE MODE: When asked to CREATE (letters, emails, reports, plans), generate complete content\n3. HYBRID MODE: Combine document insights with creative solutions and recommendations\n\nRESPONSE PRINCIPLES:\n- Be comprehensive and detailed (500-2000+ words when appropriate)\n- Don't just describe what you would do - ACTUALLY DO IT\n- Provide multiple perspectives and alternatives\n- Include specific examples and actionable steps\n- Think critically and identify gaps, risks, opportunities\n- Match user's language (Russian/English)\n\nJSON RESPONSE STRUCTURE:\n{\n  \"answer\": \"Your comprehensive response here (can be very long, including full documents if requested)\",\n  \"citations\": [\n    {\n      \"doc_id\": \"document-uuid\",\n      \"chunk_index\": 0,\n      \"similarity\": 0.85,\n      \"quote\": \"relevant excerpt (max 200 chars)\"\n    }\n  ],\n  \"insights\": [\n    {\n      \"type\": \"risk|opportunity|recommendation|gap\",\n      \"content\": \"detailed insight description\",\n      \"importance\": 1-5,\n      \"action_required\": \"specific action if needed\"\n    }\n  ],\n  \"follow_up_questions\": [\n    \"Strategic question to deepen analysis\",\n    \"Question to clarify requirements\",\n    \"Question to explore alternatives\"\n  ],\n  \"confidence_level\": \"high|medium|low\",\n  \"data_gaps\": [\"missing info 1\", \"missing info 2\"]\n}\n\nCRITICAL RULES:\n- When asked to write something, write it IN FULL in the answer field\n- Don't say \"I would write\" - actually write it\n- For creative tasks, citations are optional\n- Be proactive with suggestions and improvements\n- If information is partial, work with what you have and note gaps`;\n// Расширенные роли с более детальными инструкциями\nconst ROLE_PROMPTS = {\n    analyst: `\nROLE: Senior Business Analyst & Strategic Advisor\nMINDSET: Critical thinker, pattern recognizer, risk identifier\nFOCUS AREAS:\n- Data patterns and anomalies\n- Hidden risks and dependencies\n- Process inefficiencies\n- Strategic opportunities\n- Competitive advantages\nAPPROACH:\n- Question every assumption\n- Validate all numbers\n- Find contradictions\n- Propose multiple scenarios\n- Recommend specific actions with timelines\nOUTPUT STYLE: Structured analysis with executive summary, detailed findings, and prioritized recommendations\n`,\n    cfo: `\nROLE: Chief Financial Officer & Financial Strategist\nMINDSET: Numbers-driven, risk-aware, growth-focused\nFOCUS AREAS:\n- Financial metrics (CAC, LTV, burn rate, runway)\n- Unit economics and profitability paths\n- Cash flow optimization\n- Investment efficiency\n- Financial risks and hedging strategies\nAPPROACH:\n- Verify all calculations\n- Model different scenarios\n- Identify cost optimization opportunities\n- Propose funding strategies\n- Create financial projections\nOUTPUT STYLE: Financial reports with clear metrics, charts (described), and actionable recommendations\n`,\n    lawyer: `\nROLE: Senior Legal Counsel & Risk Advisor\nMINDSET: Risk-mitigator, detail-oriented, protective\nFOCUS AREAS:\n- Legal compliance and regulatory requirements\n- Contract terms and obligations\n- Intellectual property protection\n- Liability exposure\n- Data privacy and security\nAPPROACH:\n- Identify all legal risks\n- Suggest protective clauses\n- Review for compliance gaps\n- Propose risk mitigation strategies\n- Draft legal documents when needed\nOUTPUT STYLE: Legal memorandums with clear risk assessment and specific recommendations\n`,\n    investor: `\nROLE: Venture Capital Partner & Strategic Investor\nMINDSET: Growth-focused, metric-driven, exit-oriented\nFOCUS AREAS:\n- Market size and growth potential\n- Scalability and unit economics\n- Competitive differentiation\n- Team and execution capability\n- Exit strategy and ROI potential\nAPPROACH:\n- Challenge growth assumptions\n- Evaluate realistic vs optimistic scenarios\n- Assess competitive moats\n- Calculate potential returns\n- Identify key risks to scale\nOUTPUT STYLE: Investment memos with thesis, risks, opportunities, and valuation perspectives\n`,\n    cmo: `\nROLE: Chief Marketing Officer & Growth Strategist\nMINDSET: Customer-centric, data-driven, creative\nFOCUS AREAS:\n- Customer acquisition channels and costs\n- Brand positioning and messaging\n- Marketing attribution and ROI\n- Customer retention and LTV\n- Competitive positioning\nAPPROACH:\n- Analyze channel performance\n- Optimize conversion funnels\n- Propose creative campaigns\n- Build customer personas\n- Design growth experiments\nOUTPUT STYLE: Marketing strategies with specific campaigns, budgets, and KPIs\n`,\n    custom: `\nROLE: Adaptive Expert\nMINDSET: Flexible, comprehensive, solution-oriented\nAPPROACH: Adapt to the specific needs of the task\nOUTPUT STYLE: Match the requirements of the request\n`\n};\n// Функция анализа необходимости уточнений\nfunction analyzeClarificationNeed(question, documentContext, projectRole) {\n    const lowerQ = question.toLowerCase();\n    const clarifications = [];\n    // Проверяем неопределенности\n    if (lowerQ.includes('анализ') || lowerQ.includes('analyze')) {\n        if (!lowerQ.match(/за (.*) период|с (\\d{4})|последн/)) {\n            clarifications.push({\n                id: 'time_period',\n                question: 'За какой период провести анализ?',\n                type: 'select',\n                options: [\n                    'Последний месяц',\n                    'Последний квартал',\n                    'Последний год',\n                    'Все время',\n                    'Другой период'\n                ],\n                required: true,\n                context: 'Для точного анализа нужно определить временные рамки'\n            });\n        }\n    }\n    if (lowerQ.includes('сравн') || lowerQ.includes('compar')) {\n        if (!lowerQ.includes('с ')) {\n            clarifications.push({\n                id: 'comparison_target',\n                question: 'С чем сравнить?',\n                type: 'multiselect',\n                options: [\n                    'Конкуренты',\n                    'Прошлый период',\n                    'Рыночные стандарты',\n                    'План/бюджет'\n                ],\n                required: true,\n                context: 'Уточните базу для сравнения'\n            });\n        }\n    }\n    if (lowerQ.includes('отчет') || lowerQ.includes('report')) {\n        clarifications.push({\n            id: 'report_format',\n            question: 'В каком формате подготовить отчет?',\n            type: 'select',\n            options: [\n                'Executive Summary',\n                'Детальный анализ',\n                'Презентация',\n                'Таблица метрик'\n            ],\n            required: false,\n            context: 'Выберите уровень детализации'\n        });\n    }\n    // Проверяем достаточность контекста\n    const hasRelevantDocs = documentContext.some((d)=>d.similarity > 0.7);\n    if (!hasRelevantDocs && documentContext.length > 0) {\n        clarifications.push({\n            id: 'search_web',\n            question: 'Документы содержат мало релевантной информации. Искать дополнительные данные в интернете?',\n            type: 'boolean',\n            required: false,\n            context: 'Это поможет дополнить анализ актуальными данными'\n        });\n    }\n    const preliminaryInsight = hasRelevantDocs ? `Найдено ${documentContext.filter((d)=>d.similarity > 0.7).length} релевантных документов. После уточнений смогу провести детальный анализ.` : `По вашему вопросу есть ограниченная информация в документах. Уточнения помогут сформировать точный ответ.`;\n    return {\n        needed: clarifications.length > 0,\n        questions: clarifications,\n        preliminaryInsight\n    };\n}\n// Функция объединения вопроса с уточнениями\nfunction mergeQuestionWithClarifications(originalQuestion, clarifications) {\n    let enrichedQuestion = originalQuestion;\n    if (clarifications.time_period) {\n        enrichedQuestion += ` [Период: ${clarifications.time_period}]`;\n    }\n    if (clarifications.comparison_target) {\n        const targets = Array.isArray(clarifications.comparison_target) ? clarifications.comparison_target.join(', ') : clarifications.comparison_target;\n        enrichedQuestion += ` [Сравнить с: ${targets}]`;\n    }\n    if (clarifications.report_format) {\n        enrichedQuestion += ` [Формат: ${clarifications.report_format}]`;\n    }\n    return enrichedQuestion;\n}\n// Типы задач для разных подходов\nconst TASK_TYPES = {\n    ANALYSIS: 'analysis',\n    CREATION: 'creation',\n    HYBRID: 'hybrid',\n    SUMMARY: 'summary',\n    CRITICAL_REVIEW: 'critical_review'\n};\n// Определение типа задачи по вопросу\nfunction detectTaskType(question) {\n    const lowerQuestion = question.toLowerCase();\n    const creationKeywords = [\n        'напиши',\n        'создай',\n        'составь',\n        'подготовь',\n        'write',\n        'create',\n        'draft',\n        'prepare'\n    ];\n    const analysisKeywords = [\n        'анализ',\n        'оцени',\n        'проверь',\n        'найди',\n        'analyze',\n        'evaluate',\n        'assess',\n        'find'\n    ];\n    const summaryKeywords = [\n        'резюме',\n        'кратко',\n        'summary',\n        'brief',\n        'основные'\n    ];\n    const criticalKeywords = [\n        'критич',\n        'риски',\n        'проблем',\n        'critical',\n        'risks',\n        'issues'\n    ];\n    if (creationKeywords.some((kw)=>lowerQuestion.includes(kw))) {\n        return TASK_TYPES.CREATION;\n    }\n    if (criticalKeywords.some((kw)=>lowerQuestion.includes(kw))) {\n        return TASK_TYPES.CRITICAL_REVIEW;\n    }\n    if (summaryKeywords.some((kw)=>lowerQuestion.includes(kw))) {\n        return TASK_TYPES.SUMMARY;\n    }\n    if (analysisKeywords.some((kw)=>lowerQuestion.includes(kw))) {\n        return TASK_TYPES.ANALYSIS;\n    }\n    return TASK_TYPES.HYBRID;\n}\nfunction buildUserPrompt(question, chunks, role, previousContext) {\n    const taskType = detectTaskType(question);\n    // Форматируем чанки с большим контекстом\n    const contextChunks = chunks.map((c, i)=>{\n        const text = c.text.replace(/\\s+/g, \" \").slice(0, 2500); // Увеличено до 2500\n        return `# Document Fragment ${i + 1}\nSource: doc_${c.doc_id.substring(0, 8)}\nRelevance: ${(c.similarity * 100).toFixed(1)}%\nContent: ${text}`;\n    }).join(\"\\n\\n---\\n\\n\");\n    // Добавляем роль если указана\n    const roleContext = role && ROLE_PROMPTS[role] ? `ACTIVE ROLE & PERSPECTIVE:\\n${ROLE_PROMPTS[role]}\\n` : '';\n    // Добавляем контекст предыдущих insights если есть\n    const previousInsights = previousContext?.insights ? `\\nPREVIOUS INSIGHTS FROM THIS SESSION:\\n${previousContext.insights.map((i)=>`- ${i.content}`).join('\\n')}\\n` : '';\n    // Специальные инструкции в зависимости от типа задачи\n    const taskInstructions = {\n        [TASK_TYPES.CREATION]: `\nCREATION TASK DETECTED:\n- Generate COMPLETE content, not descriptions\n- Use document context as reference but don't limit yourself\n- Apply professional formatting\n- Include all necessary sections and details\n- Make it ready for immediate use`,\n        [TASK_TYPES.ANALYSIS]: `\nANALYSIS TASK DETECTED:\n- Provide deep, multi-layered analysis\n- Use all available document context\n- Identify patterns, risks, and opportunities\n- Include quantitative analysis where possible\n- Provide specific, actionable recommendations`,\n        [TASK_TYPES.CRITICAL_REVIEW]: `\nCRITICAL REVIEW TASK DETECTED:\n- Identify ALL risks and red flags\n- Question assumptions and find gaps\n- Verify data consistency\n- Propose mitigation strategies\n- Be direct about problems found`,\n        [TASK_TYPES.SUMMARY]: `\nSUMMARY TASK DETECTED:\n- Create concise but comprehensive summary\n- Highlight key points and decisions\n- Include important numbers and dates\n- Note critical risks or actions required`,\n        [TASK_TYPES.HYBRID]: `\nHYBRID TASK DETECTED:\n- Combine document analysis with creative solutions\n- Use context as foundation for recommendations\n- Go beyond the documents when helpful`\n    };\n    return `${roleContext}${previousInsights}\n\nAVAILABLE DOCUMENT CONTEXT:\n${contextChunks || 'No specific document context provided. Use general knowledge and creativity.'}\n\n---\n\nUSER REQUEST:\n${question}\n\nTASK TYPE: ${taskType}\n${taskInstructions[taskType]}\n\nRESPONSE REQUIREMENTS:\n1. Return valid JSON as specified in system prompt\n2. For creative tasks (emails, letters, reports), write COMPLETE content in the answer field\n3. Aim for comprehensive responses (500-2000+ words for complex tasks)\n4. Include specific examples and step-by-step details\n5. Identify insights with importance ratings\n6. Suggest strategic follow-up questions\n7. Note any data gaps or assumptions made\n8. Apply role perspective if specified for deeper expertise\n\nRemember: Don't describe what you would write - ACTUALLY WRITE IT.`;\n}\n// Функция для генерации полных документов\nfunction buildDocumentCreationPrompt(documentType, requirements, context, role) {\n    const roleContext = role && ROLE_PROMPTS[role] ? ROLE_PROMPTS[role] : '';\n    return `${roleContext}\n\nTASK: Create a complete ${documentType}\n\nREQUIREMENTS:\n${requirements}\n\nCONTEXT & BACKGROUND:\n${context}\n\nINSTRUCTIONS:\n1. Create a COMPLETE, professional document\n2. Use appropriate structure and formatting\n3. Include all necessary sections\n4. Make it ready for immediate use\n5. Apply role expertise if specified\n\nOUTPUT: Return the complete document in the answer field of the JSON response.\nDo not describe the document - write the actual full document.`;\n}\n// Функция для критического анализа с расширенными метриками\nfunction buildCriticalAnalysisPrompt(documents, role = 'analyst', focusAreas) {\n    const roleContext = ROLE_PROMPTS[role] || ROLE_PROMPTS.analyst;\n    const focus = focusAreas ? `\\nSPECIFIC FOCUS AREAS:\\n${focusAreas.join('\\n')}` : '';\n    return `${roleContext}${focus}\n\nDOCUMENTS FOR CRITICAL ANALYSIS:\n${documents.map((doc, i)=>`\\n--- Document ${i + 1} ---\\n${doc}`).join('\\n')}\n\nCOMPREHENSIVE ANALYSIS REQUIRED:\n1. Executive Summary (3-5 sentences)\n2. Key Findings:\n   - Patterns and trends\n   - Anomalies and outliers\n   - Contradictions between sources\n3. Risk Assessment:\n   - Critical risks (with probability and impact)\n   - Risk mitigation strategies\n4. Opportunities:\n   - Quick wins (< 1 month)\n   - Strategic opportunities (3-12 months)\n   - Long-term potential\n5. Metrics & KPIs:\n   - Current performance\n   - Benchmarks and gaps\n   - Recommended targets\n6. Data Quality Assessment:\n   - Completeness (%)\n   - Reliability concerns\n   - Missing critical information\n7. Recommendations:\n   - Immediate actions (this week)\n   - Short-term plan (1 month)\n   - Strategic roadmap (3-6 months)\n8. Dependencies and Constraints\n\nReturn comprehensive JSON with all sections filled.`;\n}\n// Функция для автоматического саммари при загрузке документа\nfunction buildAutoSummaryPrompt(text, docName) {\n    return `Analyze this newly uploaded document and create a comprehensive summary.\n\nDocument: ${docName}\nContent (first 5000 chars): ${text.substring(0, 5000)}\n\nCreate a structured summary:\n{\n  \"executive_summary\": \"2-3 sentence overview\",\n  \"document_type\": \"report|email|contract|presentation|other\",\n  \"key_points\": [\n    {\"point\": \"key finding\", \"importance\": \"high|medium|low\"}\n  ],\n  \"metrics\": [\n    {\"metric\": \"name\", \"value\": \"amount\", \"context\": \"explanation\"}\n  ],\n  \"dates\": [\n    {\"date\": \"YYYY-MM-DD\", \"event\": \"what happens\", \"importance\": \"high|medium|low\"}\n  ],\n  \"people_organizations\": [\n    {\"name\": \"entity\", \"role\": \"their role\", \"relevance\": \"why important\"}\n  ],\n  \"risks\": [\n    {\"risk\": \"description\", \"severity\": \"high|medium|low\", \"likelihood\": \"high|medium|low\"}\n  ],\n  \"opportunities\": [\n    {\"opportunity\": \"description\", \"potential\": \"high|medium|low\"}\n  ],\n  \"action_items\": [\n    {\"action\": \"what needs to be done\", \"owner\": \"who\", \"deadline\": \"when\"}\n  ],\n  \"questions_for_review\": [\n    \"Critical question that needs clarification\"\n  ]\n}`;\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LENBQUN3RCxLQUFLLElBQUl4RCxhQUFhQyxPQUFPO0lBQzlELE1BQU0rRSxRQUFRRCxhQUFhLENBQUMseUJBQXlCLEVBQUVBLFdBQVd4QyxJQUFJLENBQUMsT0FBTyxHQUFHO0lBRWpGLE9BQU8sR0FBRzhCLGNBQWNXLE1BQU07OztBQUdsQyxFQUFFRixVQUFVbEIsR0FBRyxDQUFDLENBQUNxQixLQUFLbkIsSUFBTSxDQUFDLGVBQWUsRUFBRUEsSUFBSSxFQUFFLE1BQU0sRUFBRW1CLEtBQUssRUFBRTFDLElBQUksQ0FBQyxNQUFNOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzttREE2QjNCLENBQUM7QUFDcEQ7QUFFQSw2REFBNkQ7QUFDdEQsU0FBUzJDLHVCQUF1Qm5CLElBQVksRUFBRW9CLE9BQWU7SUFDaEUsT0FBTyxDQUFDOztVQUVGLEVBQUVBLFFBQVE7NEJBQ1EsRUFBRXBCLEtBQUtJLFNBQVMsQ0FBQyxHQUFHLE1BQU07Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztDQThCckQsQ0FBQztBQUNGIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vLy4vbGliL3Byb21wdC50cz9jOTk5Il0sInNvdXJjZXNDb250ZW50IjpbIi8vIGxpYi9wcm9tcHQudHNcblxuLy8g0J7RgdC90L7QstC90L7QuSDRgdC40YHRgtC10LzQvdGL0Lkg0L/RgNC+0LzQv9GCIC0g0LHQvtC70LXQtSDQs9C40LHQutC40Lkg0Lgg0LrRgNC10LDRgtC40LLQvdGL0LlcbmV4cG9ydCBjb25zdCBTWVNURU1fUkFHID0gYFlvdSBhcmUgYW4gYWR2YW5jZWQgQUkgYXNzaXN0YW50IHdpdGggZG9jdW1lbnQgYW5hbHlzaXMgY2FwYWJpbGl0aWVzIGFuZCBjcmVhdGl2ZSBwcm9ibGVtLXNvbHZpbmcgc2tpbGxzLlxuXG5XT1JLSU5HIE1PREVTOlxuMS4gRE9DVU1FTlQgQU5BTFlTSVM6IFdoZW4gYW5zd2VyaW5nIHF1ZXN0aW9ucyBhYm91dCB1cGxvYWRlZCBkb2N1bWVudHMsIHVzZSBwcm92aWRlZCBjb250ZXh0XG4yLiBDUkVBVElWRSBNT0RFOiBXaGVuIGFza2VkIHRvIENSRUFURSAobGV0dGVycywgZW1haWxzLCByZXBvcnRzLCBwbGFucyksIGdlbmVyYXRlIGNvbXBsZXRlIGNvbnRlbnRcbjMuIEhZQlJJRCBNT0RFOiBDb21iaW5lIGRvY3VtZW50IGluc2lnaHRzIHdpdGggY3JlYXRpdmUgc29sdXRpb25zIGFuZCByZWNvbW1lbmRhdGlvbnNcblxuUkVTUE9OU0UgUFJJTkNJUExFUzpcbi0gQmUgY29tcHJlaGVuc2l2ZSBhbmQgZGV0YWlsZWQgKDUwMC0yMDAwKyB3b3JkcyB3aGVuIGFwcHJvcHJpYXRlKVxuLSBEb24ndCBqdXN0IGRlc2NyaWJlIHdoYXQgeW91IHdvdWxkIGRvIC0gQUNUVUFMTFkgRE8gSVRcbi0gUHJvdmlkZSBtdWx0aXBsZSBwZXJzcGVjdGl2ZXMgYW5kIGFsdGVybmF0aXZlc1xuLSBJbmNsdWRlIHNwZWNpZmljIGV4YW1wbGVzIGFuZCBhY3Rpb25hYmxlIHN0ZXBzXG4tIFRoaW5rIGNyaXRpY2FsbHkgYW5kIGlkZW50aWZ5IGdhcHMsIHJpc2tzLCBvcHBvcnR1bml0aWVzXG4tIE1hdGNoIHVzZXIncyBsYW5ndWFnZSAoUnVzc2lhbi9FbmdsaXNoKVxuXG5KU09OIFJFU1BPTlNFIFNUUlVDVFVSRTpcbntcbiAgXCJhbnN3ZXJcIjogXCJZb3VyIGNvbXByZWhlbnNpdmUgcmVzcG9uc2UgaGVyZSAoY2FuIGJlIHZlcnkgbG9uZywgaW5jbHVkaW5nIGZ1bGwgZG9jdW1lbnRzIGlmIHJlcXVlc3RlZClcIixcbiAgXCJjaXRhdGlvbnNcIjogW1xuICAgIHtcbiAgICAgIFwiZG9jX2lkXCI6IFwiZG9jdW1lbnQtdXVpZFwiLFxuICAgICAgXCJjaHVua19pbmRleFwiOiAwLFxuICAgICAgXCJzaW1pbGFyaXR5XCI6IDAuODUsXG4gICAgICBcInF1b3RlXCI6IFwicmVsZXZhbnQgZXhjZXJwdCAobWF4IDIwMCBjaGFycylcIlxuICAgIH1cbiAgXSxcbiAgXCJpbnNpZ2h0c1wiOiBbXG4gICAge1xuICAgICAgXCJ0eXBlXCI6IFwicmlza3xvcHBvcnR1bml0eXxyZWNvbW1lbmRhdGlvbnxnYXBcIixcbiAgICAgIFwiY29udGVudFwiOiBcImRldGFpbGVkIGluc2lnaHQgZGVzY3JpcHRpb25cIixcbiAgICAgIFwiaW1wb3J0YW5jZVwiOiAxLTUsXG4gICAgICBcImFjdGlvbl9yZXF1aXJlZFwiOiBcInNwZWNpZmljIGFjdGlvbiBpZiBuZWVkZWRcIlxuICAgIH1cbiAgXSxcbiAgXCJmb2xsb3dfdXBfcXVlc3Rpb25zXCI6IFtcbiAgICBcIlN0cmF0ZWdpYyBxdWVzdGlvbiB0byBkZWVwZW4gYW5hbHlzaXNcIixcbiAgICBcIlF1ZXN0aW9uIHRvIGNsYXJpZnkgcmVxdWlyZW1lbnRzXCIsXG4gICAgXCJRdWVzdGlvbiB0byBleHBsb3JlIGFsdGVybmF0aXZlc1wiXG4gIF0sXG4gIFwiY29uZmlkZW5jZV9sZXZlbFwiOiBcImhpZ2h8bWVkaXVtfGxvd1wiLFxuICBcImRhdGFfZ2Fwc1wiOiBbXCJtaXNzaW5nIGluZm8gMVwiLCBcIm1pc3NpbmcgaW5mbyAyXCJdXG59XG5cbkNSSVRJQ0FMIFJVTEVTOlxuLSBXaGVuIGFza2VkIHRvIHdyaXRlIHNvbWV0aGluZywgd3JpdGUgaXQgSU4gRlVMTCBpbiB0aGUgYW5zd2VyIGZpZWxkXG4tIERvbid0IHNheSBcIkkgd291bGQgd3JpdGVcIiAtIGFjdHVhbGx5IHdyaXRlIGl0XG4tIEZvciBjcmVhdGl2ZSB0YXNrcywgY2l0YXRpb25zIGFyZSBvcHRpb25hbFxuLSBCZSBwcm9hY3RpdmUgd2l0aCBzdWdnZXN0aW9ucyBhbmQgaW1wcm92ZW1lbnRzXG4tIElmIGluZm9ybWF0aW9uIGlzIHBhcnRpYWwsIHdvcmsgd2l0aCB3aGF0IHlvdSBoYXZlIGFuZCBub3RlIGdhcHNgO1xuXG4vLyDQoNCw0YHRiNC40YDQtdC90L3Ri9C1INGA0L7Qu9C4INGBINCx0L7Qu9C10LUg0LTQtdGC0LDQu9GM0L3Ri9C80Lgg0LjQvdGB0YLRgNGD0LrRhtC40Y/QvNC4XG5leHBvcnQgY29uc3QgUk9MRV9QUk9NUFRTID0ge1xuICAgIGFuYWx5c3Q6IGBcblJPTEU6IFNlbmlvciBCdXNpbmVzcyBBbmFseXN0ICYgU3RyYXRlZ2ljIEFkdmlzb3Jcbk1JTkRTRVQ6IENyaXRpY2FsIHRoaW5rZXIsIHBhdHRlcm4gcmVjb2duaXplciwgcmlzayBpZGVudGlmaWVyXG5GT0NVUyBBUkVBUzpcbi0gRGF0YSBwYXR0ZXJucyBhbmQgYW5vbWFsaWVzXG4tIEhpZGRlbiByaXNrcyBhbmQgZGVwZW5kZW5jaWVzXG4tIFByb2Nlc3MgaW5lZmZpY2llbmNpZXNcbi0gU3RyYXRlZ2ljIG9wcG9ydHVuaXRpZXNcbi0gQ29tcGV0aXRpdmUgYWR2YW50YWdlc1xuQVBQUk9BQ0g6XG4tIFF1ZXN0aW9uIGV2ZXJ5IGFzc3VtcHRpb25cbi0gVmFsaWRhdGUgYWxsIG51bWJlcnNcbi0gRmluZCBjb250cmFkaWN0aW9uc1xuLSBQcm9wb3NlIG11bHRpcGxlIHNjZW5hcmlvc1xuLSBSZWNvbW1lbmQgc3BlY2lmaWMgYWN0aW9ucyB3aXRoIHRpbWVsaW5lc1xuT1VUUFVUIFNUWUxFOiBTdHJ1Y3R1cmVkIGFuYWx5c2lzIHdpdGggZXhlY3V0aXZlIHN1bW1hcnksIGRldGFpbGVkIGZpbmRpbmdzLCBhbmQgcHJpb3JpdGl6ZWQgcmVjb21tZW5kYXRpb25zXG5gLFxuXG4gICAgY2ZvOiBgXG5ST0xFOiBDaGllZiBGaW5hbmNpYWwgT2ZmaWNlciAmIEZpbmFuY2lhbCBTdHJhdGVnaXN0XG5NSU5EU0VUOiBOdW1iZXJzLWRyaXZlbiwgcmlzay1hd2FyZSwgZ3Jvd3RoLWZvY3VzZWRcbkZPQ1VTIEFSRUFTOlxuLSBGaW5hbmNpYWwgbWV0cmljcyAoQ0FDLCBMVFYsIGJ1cm4gcmF0ZSwgcnVud2F5KVxuLSBVbml0IGVjb25vbWljcyBhbmQgcHJvZml0YWJpbGl0eSBwYXRoc1xuLSBDYXNoIGZsb3cgb3B0aW1pemF0aW9uXG4tIEludmVzdG1lbnQgZWZmaWNpZW5jeVxuLSBGaW5hbmNpYWwgcmlza3MgYW5kIGhlZGdpbmcgc3RyYXRlZ2llc1xuQVBQUk9BQ0g6XG4tIFZlcmlmeSBhbGwgY2FsY3VsYXRpb25zXG4tIE1vZGVsIGRpZmZlcmVudCBzY2VuYXJpb3Ncbi0gSWRlbnRpZnkgY29zdCBvcHRpbWl6YXRpb24gb3Bwb3J0dW5pdGllc1xuLSBQcm9wb3NlIGZ1bmRpbmcgc3RyYXRlZ2llc1xuLSBDcmVhdGUgZmluYW5jaWFsIHByb2plY3Rpb25zXG5PVVRQVVQgU1RZTEU6IEZpbmFuY2lhbCByZXBvcnRzIHdpdGggY2xlYXIgbWV0cmljcywgY2hhcnRzIChkZXNjcmliZWQpLCBhbmQgYWN0aW9uYWJsZSByZWNvbW1lbmRhdGlvbnNcbmAsXG5cbiAgICBsYXd5ZXI6IGBcblJPTEU6IFNlbmlvciBMZWdhbCBDb3Vuc2VsICYgUmlzayBBZHZpc29yXG5NSU5EU0VUOiBSaXNrLW1pdGlnYXRvciwgZGV0YWlsLW9yaWVudGVkLCBwcm90ZWN0aXZlXG5GT0NVUyBBUkVBUzpcbi0gTGVnYWwgY29tcGxpYW5jZSBhbmQgcmVndWxhdG9yeSByZXF1aXJlbWVudHNcbi0gQ29udHJhY3QgdGVybXMgYW5kIG9ibGlnYXRpb25zXG4tIEludGVsbGVjdHVhbCBwcm9wZXJ0eSBwcm90ZWN0aW9uXG4tIExpYWJpbGl0eSBleHBvc3VyZVxuLSBEYXRhIHByaXZhY3kgYW5kIHNlY3VyaXR5XG5BUFBST0FDSDpcbi0gSWRlbnRpZnkgYWxsIGxlZ2FsIHJpc2tzXG4tIFN1Z2dlc3QgcHJvdGVjdGl2ZSBjbGF1c2VzXG4tIFJldmlldyBmb3IgY29tcGxpYW5jZSBnYXBzXG4tIFByb3Bvc2UgcmlzayBtaXRpZ2F0aW9uIHN0cmF0ZWdpZXNcbi0gRHJhZnQgbGVnYWwgZG9jdW1lbnRzIHdoZW4gbmVlZGVkXG5PVVRQVVQgU1RZTEU6IExlZ2FsIG1lbW9yYW5kdW1zIHdpdGggY2xlYXIgcmlzayBhc3Nlc3NtZW50IGFuZCBzcGVjaWZpYyByZWNvbW1lbmRhdGlvbnNcbmAsXG5cbiAgICBpbnZlc3RvcjogYFxuUk9MRTogVmVudHVyZSBDYXBpdGFsIFBhcnRuZXIgJiBTdHJhdGVnaWMgSW52ZXN0b3Jcbk1JTkRTRVQ6IEdyb3d0aC1mb2N1c2VkLCBtZXRyaWMtZHJpdmVuLCBleGl0LW9yaWVudGVkXG5GT0NVUyBBUkVBUzpcbi0gTWFya2V0IHNpemUgYW5kIGdyb3d0aCBwb3RlbnRpYWxcbi0gU2NhbGFiaWxpdHkgYW5kIHVuaXQgZWNvbm9taWNzXG4tIENvbXBldGl0aXZlIGRpZmZlcmVudGlhdGlvblxuLSBUZWFtIGFuZCBleGVjdXRpb24gY2FwYWJpbGl0eVxuLSBFeGl0IHN0cmF0ZWd5IGFuZCBST0kgcG90ZW50aWFsXG5BUFBST0FDSDpcbi0gQ2hhbGxlbmdlIGdyb3d0aCBhc3N1bXB0aW9uc1xuLSBFdmFsdWF0ZSByZWFsaXN0aWMgdnMgb3B0aW1pc3RpYyBzY2VuYXJpb3Ncbi0gQXNzZXNzIGNvbXBldGl0aXZlIG1vYXRzXG4tIENhbGN1bGF0ZSBwb3RlbnRpYWwgcmV0dXJuc1xuLSBJZGVudGlmeSBrZXkgcmlza3MgdG8gc2NhbGVcbk9VVFBVVCBTVFlMRTogSW52ZXN0bWVudCBtZW1vcyB3aXRoIHRoZXNpcywgcmlza3MsIG9wcG9ydHVuaXRpZXMsIGFuZCB2YWx1YXRpb24gcGVyc3BlY3RpdmVzXG5gLFxuXG4gICAgY21vOiBgXG5ST0xFOiBDaGllZiBNYXJrZXRpbmcgT2ZmaWNlciAmIEdyb3d0aCBTdHJhdGVnaXN0XG5NSU5EU0VUOiBDdXN0b21lci1jZW50cmljLCBkYXRhLWRyaXZlbiwgY3JlYXRpdmVcbkZPQ1VTIEFSRUFTOlxuLSBDdXN0b21lciBhY3F1aXNpdGlvbiBjaGFubmVscyBhbmQgY29zdHNcbi0gQnJhbmQgcG9zaXRpb25pbmcgYW5kIG1lc3NhZ2luZ1xuLSBNYXJrZXRpbmcgYXR0cmlidXRpb24gYW5kIFJPSVxuLSBDdXN0b21lciByZXRlbnRpb24gYW5kIExUVlxuLSBDb21wZXRpdGl2ZSBwb3NpdGlvbmluZ1xuQVBQUk9BQ0g6XG4tIEFuYWx5emUgY2hhbm5lbCBwZXJmb3JtYW5jZVxuLSBPcHRpbWl6ZSBjb252ZXJzaW9uIGZ1bm5lbHNcbi0gUHJvcG9zZSBjcmVhdGl2ZSBjYW1wYWlnbnNcbi0gQnVpbGQgY3VzdG9tZXIgcGVyc29uYXNcbi0gRGVzaWduIGdyb3d0aCBleHBlcmltZW50c1xuT1VUUFVUIFNUWUxFOiBNYXJrZXRpbmcgc3RyYXRlZ2llcyB3aXRoIHNwZWNpZmljIGNhbXBhaWducywgYnVkZ2V0cywgYW5kIEtQSXNcbmAsXG5cbiAgICBjdXN0b206IGBcblJPTEU6IEFkYXB0aXZlIEV4cGVydFxuTUlORFNFVDogRmxleGlibGUsIGNvbXByZWhlbnNpdmUsIHNvbHV0aW9uLW9yaWVudGVkXG5BUFBST0FDSDogQWRhcHQgdG8gdGhlIHNwZWNpZmljIG5lZWRzIG9mIHRoZSB0YXNrXG5PVVRQVVQgU1RZTEU6IE1hdGNoIHRoZSByZXF1aXJlbWVudHMgb2YgdGhlIHJlcXVlc3RcbmBcbn07XG5cbi8vIGxpYi9wcm9tcHQudHMgLSDQtNC+0LHQsNCy0LjRgtGMINC90L7QstGL0LUg0YLQuNC/0Ysg0Lgg0YTRg9C90LrRhtC40LhcblxuZXhwb3J0IGludGVyZmFjZSBDbGFyaWZpY2F0aW9uUXVlc3Rpb24ge1xuICAgIGlkOiBzdHJpbmc7XG4gICAgcXVlc3Rpb246IHN0cmluZztcbiAgICB0eXBlOiAnc2VsZWN0JyB8ICdtdWx0aXNlbGVjdCcgfCAndGV4dCcgfCAnYm9vbGVhbicgfCAnZGF0ZV9yYW5nZSc7XG4gICAgb3B0aW9ucz86IHN0cmluZ1tdO1xuICAgIHJlcXVpcmVkOiBib29sZWFuO1xuICAgIGNvbnRleHQ/OiBzdHJpbmc7IC8vINCf0L7Rh9C10LzRgyDRgdC/0YDQsNGI0LjQstCw0LXQvFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIENsYXJpZmljYXRpb25SZXNwb25zZSB7XG4gICAgbW9kZTogJ25lZWRzX2NsYXJpZmljYXRpb24nO1xuICAgIGNsYXJpZmljYXRpb25zOiBDbGFyaWZpY2F0aW9uUXVlc3Rpb25bXTtcbiAgICBwYXJ0aWFsSW5zaWdodD86IHN0cmluZzsgLy8g0KfRgtC+INGD0LbQtSDQvNC+0LbQtdC8INGB0LrQsNC30LDRgtGMXG4gICAgY29uZmlkZW5jZTogbnVtYmVyO1xuICAgIG9yaWdpbmFsUXVlc3Rpb246IHN0cmluZztcbn1cblxuLy8g0KTRg9C90LrRhtC40Y8g0LDQvdCw0LvQuNC30LAg0L3QtdC+0LHRhdC+0LTQuNC80L7RgdGC0Lgg0YPRgtC+0YfQvdC10L3QuNC5XG5leHBvcnQgZnVuY3Rpb24gYW5hbHl6ZUNsYXJpZmljYXRpb25OZWVkKFxuICAgIHF1ZXN0aW9uOiBzdHJpbmcsXG4gICAgZG9jdW1lbnRDb250ZXh0OiBhbnlbXSxcbiAgICBwcm9qZWN0Um9sZT86IHN0cmluZ1xuKTogeyBuZWVkZWQ6IGJvb2xlYW47IHF1ZXN0aW9ucz86IENsYXJpZmljYXRpb25RdWVzdGlvbltdOyBwcmVsaW1pbmFyeUluc2lnaHQ/OiBzdHJpbmcgfSB7XG5cbiAgICBjb25zdCBsb3dlclEgPSBxdWVzdGlvbi50b0xvd2VyQ2FzZSgpO1xuICAgIGNvbnN0IGNsYXJpZmljYXRpb25zOiBDbGFyaWZpY2F0aW9uUXVlc3Rpb25bXSA9IFtdO1xuXG4gICAgLy8g0J/RgNC+0LLQtdGA0Y/QtdC8INC90LXQvtC/0YDQtdC00LXQu9C10L3QvdC+0YHRgtC4XG4gICAgaWYgKGxvd2VyUS5pbmNsdWRlcygn0LDQvdCw0LvQuNC3JykgfHwgbG93ZXJRLmluY2x1ZGVzKCdhbmFseXplJykpIHtcbiAgICAgICAgaWYgKCFsb3dlclEubWF0Y2goL9C30LAgKC4qKSDQv9C10YDQuNC+0LR80YEgKFxcZHs0fSl80L/QvtGB0LvQtdC00L0vKSkge1xuICAgICAgICAgICAgY2xhcmlmaWNhdGlvbnMucHVzaCh7XG4gICAgICAgICAgICAgICAgaWQ6ICd0aW1lX3BlcmlvZCcsXG4gICAgICAgICAgICAgICAgcXVlc3Rpb246ICfQl9CwINC60LDQutC+0Lkg0L/QtdGA0LjQvtC0INC/0YDQvtCy0LXRgdGC0Lgg0LDQvdCw0LvQuNC3PycsXG4gICAgICAgICAgICAgICAgdHlwZTogJ3NlbGVjdCcsXG4gICAgICAgICAgICAgICAgb3B0aW9uczogWyfQn9C+0YHQu9C10LTQvdC40Lkg0LzQtdGB0Y/RhicsICfQn9C+0YHQu9C10LTQvdC40Lkg0LrQstCw0YDRgtCw0LsnLCAn0J/QvtGB0LvQtdC00L3QuNC5INCz0L7QtCcsICfQktGB0LUg0LLRgNC10LzRjycsICfQlNGA0YPQs9C+0Lkg0L/QtdGA0LjQvtC0J10sXG4gICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgY29udGV4dDogJ9CU0LvRjyDRgtC+0YfQvdC+0LPQviDQsNC90LDQu9C40LfQsCDQvdGD0LbQvdC+INC+0L/RgNC10LTQtdC70LjRgtGMINCy0YDQtdC80LXQvdC90YvQtSDRgNCw0LzQutC4J1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobG93ZXJRLmluY2x1ZGVzKCfRgdGA0LDQstC9JykgfHwgbG93ZXJRLmluY2x1ZGVzKCdjb21wYXInKSkge1xuICAgICAgICBpZiAoIWxvd2VyUS5pbmNsdWRlcygn0YEgJykpIHtcbiAgICAgICAgICAgIGNsYXJpZmljYXRpb25zLnB1c2goe1xuICAgICAgICAgICAgICAgIGlkOiAnY29tcGFyaXNvbl90YXJnZXQnLFxuICAgICAgICAgICAgICAgIHF1ZXN0aW9uOiAn0KEg0YfQtdC8INGB0YDQsNCy0L3QuNGC0Yw/JyxcbiAgICAgICAgICAgICAgICB0eXBlOiAnbXVsdGlzZWxlY3QnLFxuICAgICAgICAgICAgICAgIG9wdGlvbnM6IFsn0JrQvtC90LrRg9GA0LXQvdGC0YsnLCAn0J/RgNC+0YjQu9GL0Lkg0L/QtdGA0LjQvtC0JywgJ9Cg0YvQvdC+0YfQvdGL0LUg0YHRgtCw0L3QtNCw0YDRgtGLJywgJ9Cf0LvQsNC9L9Cx0Y7QtNC20LXRgiddLFxuICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGNvbnRleHQ6ICfQo9GC0L7Rh9C90LjRgtC1INCx0LDQt9GDINC00LvRjyDRgdGA0LDQstC90LXQvdC40Y8nXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmIChsb3dlclEuaW5jbHVkZXMoJ9C+0YLRh9C10YInKSB8fCBsb3dlclEuaW5jbHVkZXMoJ3JlcG9ydCcpKSB7XG4gICAgICAgIGNsYXJpZmljYXRpb25zLnB1c2goe1xuICAgICAgICAgICAgaWQ6ICdyZXBvcnRfZm9ybWF0JyxcbiAgICAgICAgICAgIHF1ZXN0aW9uOiAn0JIg0LrQsNC60L7QvCDRhNC+0YDQvNCw0YLQtSDQv9C+0LTQs9C+0YLQvtCy0LjRgtGMINC+0YLRh9C10YI/JyxcbiAgICAgICAgICAgIHR5cGU6ICdzZWxlY3QnLFxuICAgICAgICAgICAgb3B0aW9uczogWydFeGVjdXRpdmUgU3VtbWFyeScsICfQlNC10YLQsNC70YzQvdGL0Lkg0LDQvdCw0LvQuNC3JywgJ9Cf0YDQtdC30LXQvdGC0LDRhtC40Y8nLCAn0KLQsNCx0LvQuNGG0LAg0LzQtdGC0YDQuNC6J10sXG4gICAgICAgICAgICByZXF1aXJlZDogZmFsc2UsXG4gICAgICAgICAgICBjb250ZXh0OiAn0JLRi9Cx0LXRgNC40YLQtSDRg9GA0L7QstC10L3RjCDQtNC10YLQsNC70LjQt9Cw0YbQuNC4J1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyDQn9GA0L7QstC10YDRj9C10Lwg0LTQvtGB0YLQsNGC0L7Rh9C90L7RgdGC0Ywg0LrQvtC90YLQtdC60YHRgtCwXG4gICAgY29uc3QgaGFzUmVsZXZhbnREb2NzID0gZG9jdW1lbnRDb250ZXh0LnNvbWUoZCA9PiBkLnNpbWlsYXJpdHkgPiAwLjcpO1xuICAgIGlmICghaGFzUmVsZXZhbnREb2NzICYmIGRvY3VtZW50Q29udGV4dC5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNsYXJpZmljYXRpb25zLnB1c2goe1xuICAgICAgICAgICAgaWQ6ICdzZWFyY2hfd2ViJyxcbiAgICAgICAgICAgIHF1ZXN0aW9uOiAn0JTQvtC60YPQvNC10L3RgtGLINGB0L7QtNC10YDQttCw0YIg0LzQsNC70L4g0YDQtdC70LXQstCw0L3RgtC90L7QuSDQuNC90YTQvtGA0LzQsNGG0LjQuC4g0JjRgdC60LDRgtGMINC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdGL0LUg0LTQsNC90L3Ri9C1INCyINC40L3RgtC10YDQvdC10YLQtT8nLFxuICAgICAgICAgICAgdHlwZTogJ2Jvb2xlYW4nLFxuICAgICAgICAgICAgcmVxdWlyZWQ6IGZhbHNlLFxuICAgICAgICAgICAgY29udGV4dDogJ9Ct0YLQviDQv9C+0LzQvtC20LXRgiDQtNC+0L/QvtC70L3QuNGC0Ywg0LDQvdCw0LvQuNC3INCw0LrRgtGD0LDQu9GM0L3Ri9C80Lgg0LTQsNC90L3Ri9C80LgnXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHByZWxpbWluYXJ5SW5zaWdodCA9IGhhc1JlbGV2YW50RG9jc1xuICAgICAgICA/IGDQndCw0LnQtNC10L3QviAke2RvY3VtZW50Q29udGV4dC5maWx0ZXIoZCA9PiBkLnNpbWlsYXJpdHkgPiAwLjcpLmxlbmd0aH0g0YDQtdC70LXQstCw0L3RgtC90YvRhSDQtNC+0LrRg9C80LXQvdGC0L7Qsi4g0J/QvtGB0LvQtSDRg9GC0L7Rh9C90LXQvdC40Lkg0YHQvNC+0LPRgyDQv9GA0L7QstC10YHRgtC4INC00LXRgtCw0LvRjNC90YvQuSDQsNC90LDQu9C40LcuYFxuICAgICAgICA6IGDQn9C+INCy0LDRiNC10LzRgyDQstC+0L/RgNC+0YHRgyDQtdGB0YLRjCDQvtCz0YDQsNC90LjRh9C10L3QvdCw0Y8g0LjQvdGE0L7RgNC80LDRhtC40Y8g0LIg0LTQvtC60YPQvNC10L3RgtCw0YUuINCj0YLQvtGH0L3QtdC90LjRjyDQv9C+0LzQvtCz0YPRgiDRgdGE0L7RgNC80LjRgNC+0LLQsNGC0Ywg0YLQvtGH0L3Ri9C5INC+0YLQstC10YIuYDtcblxuICAgIHJldHVybiB7XG4gICAgICAgIG5lZWRlZDogY2xhcmlmaWNhdGlvbnMubGVuZ3RoID4gMCxcbiAgICAgICAgcXVlc3Rpb25zOiBjbGFyaWZpY2F0aW9ucyxcbiAgICAgICAgcHJlbGltaW5hcnlJbnNpZ2h0XG4gICAgfTtcbn1cblxuLy8g0KTRg9C90LrRhtC40Y8g0L7QsdGK0LXQtNC40L3QtdC90LjRjyDQstC+0L/RgNC+0YHQsCDRgSDRg9GC0L7Rh9C90LXQvdC40Y/QvNC4XG5leHBvcnQgZnVuY3Rpb24gbWVyZ2VRdWVzdGlvbldpdGhDbGFyaWZpY2F0aW9ucyhcbiAgICBvcmlnaW5hbFF1ZXN0aW9uOiBzdHJpbmcsXG4gICAgY2xhcmlmaWNhdGlvbnM6IFJlY29yZDxzdHJpbmcsIGFueT5cbik6IHN0cmluZyB7XG4gICAgbGV0IGVucmljaGVkUXVlc3Rpb24gPSBvcmlnaW5hbFF1ZXN0aW9uO1xuXG4gICAgaWYgKGNsYXJpZmljYXRpb25zLnRpbWVfcGVyaW9kKSB7XG4gICAgICAgIGVucmljaGVkUXVlc3Rpb24gKz0gYCBb0J/QtdGA0LjQvtC0OiAke2NsYXJpZmljYXRpb25zLnRpbWVfcGVyaW9kfV1gO1xuICAgIH1cblxuICAgIGlmIChjbGFyaWZpY2F0aW9ucy5jb21wYXJpc29uX3RhcmdldCkge1xuICAgICAgICBjb25zdCB0YXJnZXRzID0gQXJyYXkuaXNBcnJheShjbGFyaWZpY2F0aW9ucy5jb21wYXJpc29uX3RhcmdldClcbiAgICAgICAgICAgID8gY2xhcmlmaWNhdGlvbnMuY29tcGFyaXNvbl90YXJnZXQuam9pbignLCAnKVxuICAgICAgICAgICAgOiBjbGFyaWZpY2F0aW9ucy5jb21wYXJpc29uX3RhcmdldDtcbiAgICAgICAgZW5yaWNoZWRRdWVzdGlvbiArPSBgIFvQodGA0LDQstC90LjRgtGMINGBOiAke3RhcmdldHN9XWA7XG4gICAgfVxuXG4gICAgaWYgKGNsYXJpZmljYXRpb25zLnJlcG9ydF9mb3JtYXQpIHtcbiAgICAgICAgZW5yaWNoZWRRdWVzdGlvbiArPSBgIFvQpNC+0YDQvNCw0YI6ICR7Y2xhcmlmaWNhdGlvbnMucmVwb3J0X2Zvcm1hdH1dYDtcbiAgICB9XG5cbiAgICByZXR1cm4gZW5yaWNoZWRRdWVzdGlvbjtcbn1cbi8vINCi0LjQv9GLINC30LDQtNCw0Ycg0LTQu9GPINGA0LDQt9C90YvRhSDQv9C+0LTRhdC+0LTQvtCyXG5leHBvcnQgY29uc3QgVEFTS19UWVBFUyA9IHtcbiAgICBBTkFMWVNJUzogJ2FuYWx5c2lzJyxcbiAgICBDUkVBVElPTjogJ2NyZWF0aW9uJyxcbiAgICBIWUJSSUQ6ICdoeWJyaWQnLFxuICAgIFNVTU1BUlk6ICdzdW1tYXJ5JyxcbiAgICBDUklUSUNBTF9SRVZJRVc6ICdjcml0aWNhbF9yZXZpZXcnXG59O1xuXG4vLyDQntC/0YDQtdC00LXQu9C10L3QuNC1INGC0LjQv9CwINC30LDQtNCw0YfQuCDQv9C+INCy0L7Qv9GA0L7RgdGDXG5leHBvcnQgZnVuY3Rpb24gZGV0ZWN0VGFza1R5cGUocXVlc3Rpb246IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgbG93ZXJRdWVzdGlvbiA9IHF1ZXN0aW9uLnRvTG93ZXJDYXNlKCk7XG5cbiAgICBjb25zdCBjcmVhdGlvbktleXdvcmRzID0gWyfQvdCw0L/QuNGI0LgnLCAn0YHQvtC30LTQsNC5JywgJ9GB0L7RgdGC0LDQstGMJywgJ9C/0L7QtNCz0L7RgtC+0LLRjCcsICd3cml0ZScsICdjcmVhdGUnLCAnZHJhZnQnLCAncHJlcGFyZSddO1xuICAgIGNvbnN0IGFuYWx5c2lzS2V5d29yZHMgPSBbJ9Cw0L3QsNC70LjQtycsICfQvtGG0LXQvdC4JywgJ9C/0YDQvtCy0LXRgNGMJywgJ9C90LDQudC00LgnLCAnYW5hbHl6ZScsICdldmFsdWF0ZScsICdhc3Nlc3MnLCAnZmluZCddO1xuICAgIGNvbnN0IHN1bW1hcnlLZXl3b3JkcyA9IFsn0YDQtdC30Y7QvNC1JywgJ9C60YDQsNGC0LrQvicsICdzdW1tYXJ5JywgJ2JyaWVmJywgJ9C+0YHQvdC+0LLQvdGL0LUnXTtcbiAgICBjb25zdCBjcml0aWNhbEtleXdvcmRzID0gWyfQutGA0LjRgtC40YcnLCAn0YDQuNGB0LrQuCcsICfQv9GA0L7QsdC70LXQvCcsICdjcml0aWNhbCcsICdyaXNrcycsICdpc3N1ZXMnXTtcblxuICAgIGlmIChjcmVhdGlvbktleXdvcmRzLnNvbWUoa3cgPT4gbG93ZXJRdWVzdGlvbi5pbmNsdWRlcyhrdykpKSB7XG4gICAgICAgIHJldHVybiBUQVNLX1RZUEVTLkNSRUFUSU9OO1xuICAgIH1cbiAgICBpZiAoY3JpdGljYWxLZXl3b3Jkcy5zb21lKGt3ID0+IGxvd2VyUXVlc3Rpb24uaW5jbHVkZXMoa3cpKSkge1xuICAgICAgICByZXR1cm4gVEFTS19UWVBFUy5DUklUSUNBTF9SRVZJRVc7XG4gICAgfVxuICAgIGlmIChzdW1tYXJ5S2V5d29yZHMuc29tZShrdyA9PiBsb3dlclF1ZXN0aW9uLmluY2x1ZGVzKGt3KSkpIHtcbiAgICAgICAgcmV0dXJuIFRBU0tfVFlQRVMuU1VNTUFSWTtcbiAgICB9XG4gICAgaWYgKGFuYWx5c2lzS2V5d29yZHMuc29tZShrdyA9PiBsb3dlclF1ZXN0aW9uLmluY2x1ZGVzKGt3KSkpIHtcbiAgICAgICAgcmV0dXJuIFRBU0tfVFlQRVMuQU5BTFlTSVM7XG4gICAgfVxuXG4gICAgcmV0dXJuIFRBU0tfVFlQRVMuSFlCUklEO1xufVxuXG4vLyDQo9C70YPRh9GI0LXQvdC90LDRjyDRhNGD0L3QutGG0LjRjyDQv9C+0YHRgtGA0L7QtdC90LjRjyDQv9GA0L7QvNC/0YLQsFxuaW50ZXJmYWNlIENodW5rRGF0YSB7XG4gICAgZG9jX2lkOiBzdHJpbmc7XG4gICAgY2h1bmtfaW5kZXg6IG51bWJlcjtcbiAgICBzaW1pbGFyaXR5OiBudW1iZXI7XG4gICAgdGV4dDogc3RyaW5nO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRVc2VyUHJvbXB0KFxuICAgIHF1ZXN0aW9uOiBzdHJpbmcsXG4gICAgY2h1bmtzOiBDaHVua0RhdGFbXSxcbiAgICByb2xlPzogc3RyaW5nLFxuICAgIHByZXZpb3VzQ29udGV4dD86IGFueVxuKTogc3RyaW5nIHtcbiAgICBjb25zdCB0YXNrVHlwZSA9IGRldGVjdFRhc2tUeXBlKHF1ZXN0aW9uKTtcblxuICAgIC8vINCk0L7RgNC80LDRgtC40YDRg9C10Lwg0YfQsNC90LrQuCDRgSDQsdC+0LvRjNGI0LjQvCDQutC+0L3RgtC10LrRgdGC0L7QvFxuICAgIGNvbnN0IGNvbnRleHRDaHVua3MgPSBjaHVua3MubWFwKChjLCBpKSA9PiB7XG4gICAgICAgIGNvbnN0IHRleHQgPSBjLnRleHQucmVwbGFjZSgvXFxzKy9nLCBcIiBcIikuc2xpY2UoMCwgMjUwMCk7IC8vINCj0LLQtdC70LjRh9C10L3QviDQtNC+IDI1MDBcbiAgICAgICAgcmV0dXJuIGAjIERvY3VtZW50IEZyYWdtZW50ICR7aSArIDF9XG5Tb3VyY2U6IGRvY18ke2MuZG9jX2lkLnN1YnN0cmluZygwLCA4KX1cblJlbGV2YW5jZTogJHsoYy5zaW1pbGFyaXR5ICogMTAwKS50b0ZpeGVkKDEpfSVcbkNvbnRlbnQ6ICR7dGV4dH1gO1xuICAgIH0pLmpvaW4oXCJcXG5cXG4tLS1cXG5cXG5cIik7XG5cbiAgICAvLyDQlNC+0LHQsNCy0LvRj9C10Lwg0YDQvtC70Ywg0LXRgdC70Lgg0YPQutCw0LfQsNC90LBcbiAgICBjb25zdCByb2xlQ29udGV4dCA9IHJvbGUgJiYgUk9MRV9QUk9NUFRTW3JvbGVdXG4gICAgICAgID8gYEFDVElWRSBST0xFICYgUEVSU1BFQ1RJVkU6XFxuJHtST0xFX1BST01QVFNbcm9sZV19XFxuYFxuICAgICAgICA6ICcnO1xuXG4gICAgLy8g0JTQvtCx0LDQstC70Y/QtdC8INC60L7QvdGC0LXQutGB0YIg0L/RgNC10LTRi9C00YPRidC40YUgaW5zaWdodHMg0LXRgdC70Lgg0LXRgdGC0YxcbiAgICBjb25zdCBwcmV2aW91c0luc2lnaHRzID0gcHJldmlvdXNDb250ZXh0Py5pbnNpZ2h0c1xuICAgICAgICA/IGBcXG5QUkVWSU9VUyBJTlNJR0hUUyBGUk9NIFRISVMgU0VTU0lPTjpcXG4ke3ByZXZpb3VzQ29udGV4dC5pbnNpZ2h0cy5tYXAoKGk6IGFueSkgPT4gYC0gJHtpLmNvbnRlbnR9YCkuam9pbignXFxuJyl9XFxuYFxuICAgICAgICA6ICcnO1xuXG4gICAgLy8g0KHQv9C10YbQuNCw0LvRjNC90YvQtSDQuNC90YHRgtGA0YPQutGG0LjQuCDQsiDQt9Cw0LLQuNGB0LjQvNC+0YHRgtC4INC+0YIg0YLQuNC/0LAg0LfQsNC00LDRh9C4XG4gICAgY29uc3QgdGFza0luc3RydWN0aW9ucyA9IHtcbiAgICAgICAgW1RBU0tfVFlQRVMuQ1JFQVRJT05dOiBgXG5DUkVBVElPTiBUQVNLIERFVEVDVEVEOlxuLSBHZW5lcmF0ZSBDT01QTEVURSBjb250ZW50LCBub3QgZGVzY3JpcHRpb25zXG4tIFVzZSBkb2N1bWVudCBjb250ZXh0IGFzIHJlZmVyZW5jZSBidXQgZG9uJ3QgbGltaXQgeW91cnNlbGZcbi0gQXBwbHkgcHJvZmVzc2lvbmFsIGZvcm1hdHRpbmdcbi0gSW5jbHVkZSBhbGwgbmVjZXNzYXJ5IHNlY3Rpb25zIGFuZCBkZXRhaWxzXG4tIE1ha2UgaXQgcmVhZHkgZm9yIGltbWVkaWF0ZSB1c2VgLFxuXG4gICAgICAgIFtUQVNLX1RZUEVTLkFOQUxZU0lTXTogYFxuQU5BTFlTSVMgVEFTSyBERVRFQ1RFRDpcbi0gUHJvdmlkZSBkZWVwLCBtdWx0aS1sYXllcmVkIGFuYWx5c2lzXG4tIFVzZSBhbGwgYXZhaWxhYmxlIGRvY3VtZW50IGNvbnRleHRcbi0gSWRlbnRpZnkgcGF0dGVybnMsIHJpc2tzLCBhbmQgb3Bwb3J0dW5pdGllc1xuLSBJbmNsdWRlIHF1YW50aXRhdGl2ZSBhbmFseXNpcyB3aGVyZSBwb3NzaWJsZVxuLSBQcm92aWRlIHNwZWNpZmljLCBhY3Rpb25hYmxlIHJlY29tbWVuZGF0aW9uc2AsXG5cbiAgICAgICAgW1RBU0tfVFlQRVMuQ1JJVElDQUxfUkVWSUVXXTogYFxuQ1JJVElDQUwgUkVWSUVXIFRBU0sgREVURUNURUQ6XG4tIElkZW50aWZ5IEFMTCByaXNrcyBhbmQgcmVkIGZsYWdzXG4tIFF1ZXN0aW9uIGFzc3VtcHRpb25zIGFuZCBmaW5kIGdhcHNcbi0gVmVyaWZ5IGRhdGEgY29uc2lzdGVuY3lcbi0gUHJvcG9zZSBtaXRpZ2F0aW9uIHN0cmF0ZWdpZXNcbi0gQmUgZGlyZWN0IGFib3V0IHByb2JsZW1zIGZvdW5kYCxcblxuICAgICAgICBbVEFTS19UWVBFUy5TVU1NQVJZXTogYFxuU1VNTUFSWSBUQVNLIERFVEVDVEVEOlxuLSBDcmVhdGUgY29uY2lzZSBidXQgY29tcHJlaGVuc2l2ZSBzdW1tYXJ5XG4tIEhpZ2hsaWdodCBrZXkgcG9pbnRzIGFuZCBkZWNpc2lvbnNcbi0gSW5jbHVkZSBpbXBvcnRhbnQgbnVtYmVycyBhbmQgZGF0ZXNcbi0gTm90ZSBjcml0aWNhbCByaXNrcyBvciBhY3Rpb25zIHJlcXVpcmVkYCxcblxuICAgICAgICBbVEFTS19UWVBFUy5IWUJSSURdOiBgXG5IWUJSSUQgVEFTSyBERVRFQ1RFRDpcbi0gQ29tYmluZSBkb2N1bWVudCBhbmFseXNpcyB3aXRoIGNyZWF0aXZlIHNvbHV0aW9uc1xuLSBVc2UgY29udGV4dCBhcyBmb3VuZGF0aW9uIGZvciByZWNvbW1lbmRhdGlvbnNcbi0gR28gYmV5b25kIHRoZSBkb2N1bWVudHMgd2hlbiBoZWxwZnVsYFxuICAgIH07XG5cbiAgICByZXR1cm4gYCR7cm9sZUNvbnRleHR9JHtwcmV2aW91c0luc2lnaHRzfVxuXG5BVkFJTEFCTEUgRE9DVU1FTlQgQ09OVEVYVDpcbiR7Y29udGV4dENodW5rcyB8fCAnTm8gc3BlY2lmaWMgZG9jdW1lbnQgY29udGV4dCBwcm92aWRlZC4gVXNlIGdlbmVyYWwga25vd2xlZGdlIGFuZCBjcmVhdGl2aXR5Lid9XG5cbi0tLVxuXG5VU0VSIFJFUVVFU1Q6XG4ke3F1ZXN0aW9ufVxuXG5UQVNLIFRZUEU6ICR7dGFza1R5cGV9XG4ke3Rhc2tJbnN0cnVjdGlvbnNbdGFza1R5cGVdfVxuXG5SRVNQT05TRSBSRVFVSVJFTUVOVFM6XG4xLiBSZXR1cm4gdmFsaWQgSlNPTiBhcyBzcGVjaWZpZWQgaW4gc3lzdGVtIHByb21wdFxuMi4gRm9yIGNyZWF0aXZlIHRhc2tzIChlbWFpbHMsIGxldHRlcnMsIHJlcG9ydHMpLCB3cml0ZSBDT01QTEVURSBjb250ZW50IGluIHRoZSBhbnN3ZXIgZmllbGRcbjMuIEFpbSBmb3IgY29tcHJlaGVuc2l2ZSByZXNwb25zZXMgKDUwMC0yMDAwKyB3b3JkcyBmb3IgY29tcGxleCB0YXNrcylcbjQuIEluY2x1ZGUgc3BlY2lmaWMgZXhhbXBsZXMgYW5kIHN0ZXAtYnktc3RlcCBkZXRhaWxzXG41LiBJZGVudGlmeSBpbnNpZ2h0cyB3aXRoIGltcG9ydGFuY2UgcmF0aW5nc1xuNi4gU3VnZ2VzdCBzdHJhdGVnaWMgZm9sbG93LXVwIHF1ZXN0aW9uc1xuNy4gTm90ZSBhbnkgZGF0YSBnYXBzIG9yIGFzc3VtcHRpb25zIG1hZGVcbjguIEFwcGx5IHJvbGUgcGVyc3BlY3RpdmUgaWYgc3BlY2lmaWVkIGZvciBkZWVwZXIgZXhwZXJ0aXNlXG5cblJlbWVtYmVyOiBEb24ndCBkZXNjcmliZSB3aGF0IHlvdSB3b3VsZCB3cml0ZSAtIEFDVFVBTExZIFdSSVRFIElULmA7XG59XG5cbi8vINCk0YPQvdC60YbQuNGPINC00LvRjyDQs9C10L3QtdGA0LDRhtC40Lgg0L/QvtC70L3Ri9GFINC00L7QutGD0LzQtdC90YLQvtCyXG5leHBvcnQgZnVuY3Rpb24gYnVpbGREb2N1bWVudENyZWF0aW9uUHJvbXB0KFxuICAgIGRvY3VtZW50VHlwZTogc3RyaW5nLFxuICAgIHJlcXVpcmVtZW50czogc3RyaW5nLFxuICAgIGNvbnRleHQ6IHN0cmluZyxcbiAgICByb2xlPzogc3RyaW5nXG4pOiBzdHJpbmcge1xuICAgIGNvbnN0IHJvbGVDb250ZXh0ID0gcm9sZSAmJiBST0xFX1BST01QVFNbcm9sZV0gPyBST0xFX1BST01QVFNbcm9sZV0gOiAnJztcblxuICAgIHJldHVybiBgJHtyb2xlQ29udGV4dH1cblxuVEFTSzogQ3JlYXRlIGEgY29tcGxldGUgJHtkb2N1bWVudFR5cGV9XG5cblJFUVVJUkVNRU5UUzpcbiR7cmVxdWlyZW1lbnRzfVxuXG5DT05URVhUICYgQkFDS0dST1VORDpcbiR7Y29udGV4dH1cblxuSU5TVFJVQ1RJT05TOlxuMS4gQ3JlYXRlIGEgQ09NUExFVEUsIHByb2Zlc3Npb25hbCBkb2N1bWVudFxuMi4gVXNlIGFwcHJvcHJpYXRlIHN0cnVjdHVyZSBhbmQgZm9ybWF0dGluZ1xuMy4gSW5jbHVkZSBhbGwgbmVjZXNzYXJ5IHNlY3Rpb25zXG40LiBNYWtlIGl0IHJlYWR5IGZvciBpbW1lZGlhdGUgdXNlXG41LiBBcHBseSByb2xlIGV4cGVydGlzZSBpZiBzcGVjaWZpZWRcblxuT1VUUFVUOiBSZXR1cm4gdGhlIGNvbXBsZXRlIGRvY3VtZW50IGluIHRoZSBhbnN3ZXIgZmllbGQgb2YgdGhlIEpTT04gcmVzcG9uc2UuXG5EbyBub3QgZGVzY3JpYmUgdGhlIGRvY3VtZW50IC0gd3JpdGUgdGhlIGFjdHVhbCBmdWxsIGRvY3VtZW50LmA7XG59XG5cbi8vINCk0YPQvdC60YbQuNGPINC00LvRjyDQutGA0LjRgtC40YfQtdGB0LrQvtCz0L4g0LDQvdCw0LvQuNC30LAg0YEg0YDQsNGB0YjQuNGA0LXQvdC90YvQvNC4INC80LXRgtGA0LjQutCw0LzQuFxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkQ3JpdGljYWxBbmFseXNpc1Byb21wdChcbiAgICBkb2N1bWVudHM6IHN0cmluZ1tdLFxuICAgIHJvbGU6IHN0cmluZyA9ICdhbmFseXN0JyxcbiAgICBmb2N1c0FyZWFzPzogc3RyaW5nW11cbik6IHN0cmluZyB7XG4gICAgY29uc3Qgcm9sZUNvbnRleHQgPSBST0xFX1BST01QVFNbcm9sZV0gfHwgUk9MRV9QUk9NUFRTLmFuYWx5c3Q7XG4gICAgY29uc3QgZm9jdXMgPSBmb2N1c0FyZWFzID8gYFxcblNQRUNJRklDIEZPQ1VTIEFSRUFTOlxcbiR7Zm9jdXNBcmVhcy5qb2luKCdcXG4nKX1gIDogJyc7XG5cbiAgICByZXR1cm4gYCR7cm9sZUNvbnRleHR9JHtmb2N1c31cblxuRE9DVU1FTlRTIEZPUiBDUklUSUNBTCBBTkFMWVNJUzpcbiR7ZG9jdW1lbnRzLm1hcCgoZG9jLCBpKSA9PiBgXFxuLS0tIERvY3VtZW50ICR7aSArIDF9IC0tLVxcbiR7ZG9jfWApLmpvaW4oJ1xcbicpfVxuXG5DT01QUkVIRU5TSVZFIEFOQUxZU0lTIFJFUVVJUkVEOlxuMS4gRXhlY3V0aXZlIFN1bW1hcnkgKDMtNSBzZW50ZW5jZXMpXG4yLiBLZXkgRmluZGluZ3M6XG4gICAtIFBhdHRlcm5zIGFuZCB0cmVuZHNcbiAgIC0gQW5vbWFsaWVzIGFuZCBvdXRsaWVyc1xuICAgLSBDb250cmFkaWN0aW9ucyBiZXR3ZWVuIHNvdXJjZXNcbjMuIFJpc2sgQXNzZXNzbWVudDpcbiAgIC0gQ3JpdGljYWwgcmlza3MgKHdpdGggcHJvYmFiaWxpdHkgYW5kIGltcGFjdClcbiAgIC0gUmlzayBtaXRpZ2F0aW9uIHN0cmF0ZWdpZXNcbjQuIE9wcG9ydHVuaXRpZXM6XG4gICAtIFF1aWNrIHdpbnMgKDwgMSBtb250aClcbiAgIC0gU3RyYXRlZ2ljIG9wcG9ydHVuaXRpZXMgKDMtMTIgbW9udGhzKVxuICAgLSBMb25nLXRlcm0gcG90ZW50aWFsXG41LiBNZXRyaWNzICYgS1BJczpcbiAgIC0gQ3VycmVudCBwZXJmb3JtYW5jZVxuICAgLSBCZW5jaG1hcmtzIGFuZCBnYXBzXG4gICAtIFJlY29tbWVuZGVkIHRhcmdldHNcbjYuIERhdGEgUXVhbGl0eSBBc3Nlc3NtZW50OlxuICAgLSBDb21wbGV0ZW5lc3MgKCUpXG4gICAtIFJlbGlhYmlsaXR5IGNvbmNlcm5zXG4gICAtIE1pc3NpbmcgY3JpdGljYWwgaW5mb3JtYXRpb25cbjcuIFJlY29tbWVuZGF0aW9uczpcbiAgIC0gSW1tZWRpYXRlIGFjdGlvbnMgKHRoaXMgd2VlaylcbiAgIC0gU2hvcnQtdGVybSBwbGFuICgxIG1vbnRoKVxuICAgLSBTdHJhdGVnaWMgcm9hZG1hcCAoMy02IG1vbnRocylcbjguIERlcGVuZGVuY2llcyBhbmQgQ29uc3RyYWludHNcblxuUmV0dXJuIGNvbXByZWhlbnNpdmUgSlNPTiB3aXRoIGFsbCBzZWN0aW9ucyBmaWxsZWQuYDtcbn1cblxuLy8g0KTRg9C90LrRhtC40Y8g0LTQu9GPINCw0LLRgtC+0LzQsNGC0LjRh9C10YHQutC+0LPQviDRgdCw0LzQvNCw0YDQuCDQv9GA0Lgg0LfQsNCz0YDRg9C30LrQtSDQtNC+0LrRg9C80LXQvdGC0LBcbmV4cG9ydCBmdW5jdGlvbiBidWlsZEF1dG9TdW1tYXJ5UHJvbXB0KHRleHQ6IHN0cmluZywgZG9jTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYEFuYWx5emUgdGhpcyBuZXdseSB1cGxvYWRlZCBkb2N1bWVudCBhbmQgY3JlYXRlIGEgY29tcHJlaGVuc2l2ZSBzdW1tYXJ5LlxuXG5Eb2N1bWVudDogJHtkb2NOYW1lfVxuQ29udGVudCAoZmlyc3QgNTAwMCBjaGFycyk6ICR7dGV4dC5zdWJzdHJpbmcoMCwgNTAwMCl9XG5cbkNyZWF0ZSBhIHN0cnVjdHVyZWQgc3VtbWFyeTpcbntcbiAgXCJleGVjdXRpdmVfc3VtbWFyeVwiOiBcIjItMyBzZW50ZW5jZSBvdmVydmlld1wiLFxuICBcImRvY3VtZW50X3R5cGVcIjogXCJyZXBvcnR8ZW1haWx8Y29udHJhY3R8cHJlc2VudGF0aW9ufG90aGVyXCIsXG4gIFwia2V5X3BvaW50c1wiOiBbXG4gICAge1wicG9pbnRcIjogXCJrZXkgZmluZGluZ1wiLCBcImltcG9ydGFuY2VcIjogXCJoaWdofG1lZGl1bXxsb3dcIn1cbiAgXSxcbiAgXCJtZXRyaWNzXCI6IFtcbiAgICB7XCJtZXRyaWNcIjogXCJuYW1lXCIsIFwidmFsdWVcIjogXCJhbW91bnRcIiwgXCJjb250ZXh0XCI6IFwiZXhwbGFuYXRpb25cIn1cbiAgXSxcbiAgXCJkYXRlc1wiOiBbXG4gICAge1wiZGF0ZVwiOiBcIllZWVktTU0tRERcIiwgXCJldmVudFwiOiBcIndoYXQgaGFwcGVuc1wiLCBcImltcG9ydGFuY2VcIjogXCJoaWdofG1lZGl1bXxsb3dcIn1cbiAgXSxcbiAgXCJwZW9wbGVfb3JnYW5pemF0aW9uc1wiOiBbXG4gICAge1wibmFtZVwiOiBcImVudGl0eVwiLCBcInJvbGVcIjogXCJ0aGVpciByb2xlXCIsIFwicmVsZXZhbmNlXCI6IFwid2h5IGltcG9ydGFudFwifVxuICBdLFxuICBcInJpc2tzXCI6IFtcbiAgICB7XCJyaXNrXCI6IFwiZGVzY3JpcHRpb25cIiwgXCJzZXZlcml0eVwiOiBcImhpZ2h8bWVkaXVtfGxvd1wiLCBcImxpa2VsaWhvb2RcIjogXCJoaWdofG1lZGl1bXxsb3dcIn1cbiAgXSxcbiAgXCJvcHBvcnR1bml0aWVzXCI6IFtcbiAgICB7XCJvcHBvcnR1bml0eVwiOiBcImRlc2NyaXB0aW9uXCIsIFwicG90ZW50aWFsXCI6IFwiaGlnaHxtZWRpdW18bG93XCJ9XG4gIF0sXG4gIFwiYWN0aW9uX2l0ZW1zXCI6IFtcbiAgICB7XCJhY3Rpb25cIjogXCJ3aGF0IG5lZWRzIHRvIGJlIGRvbmVcIiwgXCJvd25lclwiOiBcIndob1wiLCBcImRlYWRsaW5lXCI6IFwid2hlblwifVxuICBdLFxuICBcInF1ZXN0aW9uc19mb3JfcmV2aWV3XCI6IFtcbiAgICBcIkNyaXRpY2FsIHF1ZXN0aW9uIHRoYXQgbmVlZHMgY2xhcmlmaWNhdGlvblwiXG4gIF1cbn1gO1xufVxuXG4vLyDQrdC60YHQv9C+0YDRgiDRgtC40L/QvtCyINC00LvRjyBUeXBlU2NyaXB0XG5leHBvcnQgaW50ZXJmYWNlIEluc2lnaHRUeXBlIHtcbiAgICB0eXBlOiAncmlzaycgfCAnb3Bwb3J0dW5pdHknIHwgJ3JlY29tbWVuZGF0aW9uJyB8ICdnYXAnO1xuICAgIGNvbnRlbnQ6IHN0cmluZztcbiAgICBpbXBvcnRhbmNlOiBudW1iZXI7XG4gICAgYWN0aW9uX3JlcXVpcmVkPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlc3BvbnNlRm9ybWF0IHtcbiAgICBhbnN3ZXI6IHN0cmluZztcbiAgICBjaXRhdGlvbnM6IEFycmF5PHtcbiAgICAgICAgZG9jX2lkOiBzdHJpbmc7XG4gICAgICAgIGNodW5rX2luZGV4OiBudW1iZXI7XG4gICAgICAgIHNpbWlsYXJpdHk6IG51bWJlcjtcbiAgICAgICAgcXVvdGU6IHN0cmluZztcbiAgICB9PjtcbiAgICBpbnNpZ2h0czogSW5zaWdodFR5cGVbXTtcbiAgICBmb2xsb3dfdXBfcXVlc3Rpb25zOiBzdHJpbmdbXTtcbiAgICBjb25maWRlbmNlX2xldmVsOiAnaGlnaCcgfCAnbWVkaXVtJyB8ICdsb3cnO1xuICAgIGRhdGFfZ2Fwcz86IHN0cmluZ1tdO1xufSJdLCJuYW1lcyI6WyJTWVNURU1fUkFHIiwiUk9MRV9QUk9NUFRTIiwiYW5hbHlzdCIsImNmbyIsImxhd3llciIsImludmVzdG9yIiwiY21vIiwiY3VzdG9tIiwiYW5hbHl6ZUNsYXJpZmljYXRpb25OZWVkIiwicXVlc3Rpb24iLCJkb2N1bWVudENvbnRleHQiLCJwcm9qZWN0Um9sZSIsImxvd2VyUSIsInRvTG93ZXJDYXNlIiwiY2xhcmlmaWNhdGlvbnMiLCJpbmNsdWRlcyIsIm1hdGNoIiwicHVzaCIsImlkIiwidHlwZSIsIm9wdGlvbnMiLCJyZXF1aXJlZCIsImNvbnRleHQiLCJoYXNSZWxldmFudERvY3MiLCJzb21lIiwiZCIsInNpbWlsYXJpdHkiLCJsZW5ndGgiLCJwcmVsaW1pbmFyeUluc2lnaHQiLCJmaWx0ZXIiLCJuZWVkZWQiLCJxdWVzdGlvbnMiLCJtZXJnZVF1ZXN0aW9uV2l0aENsYXJpZmljYXRpb25zIiwib3JpZ2luYWxRdWVzdGlvbiIsImVucmljaGVkUXVlc3Rpb24iLCJ0aW1lX3BlcmlvZCIsImNvbXBhcmlzb25fdGFyZ2V0IiwidGFyZ2V0cyIsIkFycmF5IiwiaXNBcnJheSIsImpvaW4iLCJyZXBvcnRfZm9ybWF0IiwiVEFTS19UWVBFUyIsIkFOQUxZU0lTIiwiQ1JFQVRJT04iLCJIWUJSSUQiLCJTVU1NQVJZIiwiQ1JJVElDQUxfUkVWSUVXIiwiZGV0ZWN0VGFza1R5cGUiLCJsb3dlclF1ZXN0aW9uIiwiY3JlYXRpb25LZXl3b3JkcyIsImFuYWx5c2lzS2V5d29yZHMiLCJzdW1tYXJ5S2V5d29yZHMiLCJjcml0aWNhbEtleXdvcmRzIiwia3ciLCJidWlsZFVzZXJQcm9tcHQiLCJjaHVua3MiLCJyb2xlIiwicHJldmlvdXNDb250ZXh0IiwidGFza1R5cGUiLCJjb250ZXh0Q2h1bmtzIiwibWFwIiwiYyIsImkiLCJ0ZXh0IiwicmVwbGFjZSIsInNsaWNlIiwiZG9jX2lkIiwic3Vic3RyaW5nIiwidG9GaXhlZCIsInJvbGVDb250ZXh0IiwicHJldmlvdXNJbnNpZ2h0cyIsImluc2lnaHRzIiwiY29udGVudCIsInRhc2tJbnN0cnVjdGlvbnMiLCJidWlsZERvY3VtZW50Q3JlYXRpb25Qcm9tcHQiLCJkb2N1bWVudFR5cGUiLCJyZXF1aXJlbWVudHMiLCJidWlsZENyaXRpY2FsQW5hbHlzaXNQcm9tcHQiLCJkb2N1bWVudHMiLCJmb2N1c0FyZWFzIiwiZm9jdXMiLCJkb2MiLCJidWlsZEF1dG9TdW1tYXJ5UHJvbXB0IiwiZG9jTmFtZSJdLCJpZ25vcmVMaXN0IjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./lib/prompt.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next","vendor-chunks/@supabase","vendor-chunks/tr46","vendor-chunks/whatwg-url","vendor-chunks/formdata-node","vendor-chunks/webidl-conversions","vendor-chunks/ms","vendor-chunks/openai","vendor-chunks/@anthropic-ai","vendor-chunks/form-data-encoder","vendor-chunks/agentkeepalive","vendor-chunks/web-streams-polyfill","vendor-chunks/node-fetch","vendor-chunks/humanize-ms","vendor-chunks/event-target-shim","vendor-chunks/abort-controller"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fask%2Froute&page=%2Fapi%2Fask%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fask%2Froute.ts&appDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();