/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/ask/route";
exports.ids = ["app/api/ask/route"];
exports.modules = {

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "../app-render/work-async-storage.external":
/*!*****************************************************************************!*\
  !*** external "next/dist/server/app-render/work-async-storage.external.js" ***!
  \*****************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/server/app-render/work-async-storage.external.js");

/***/ }),

/***/ "./work-unit-async-storage.external":
/*!**********************************************************************************!*\
  !*** external "next/dist/server/app-render/work-unit-async-storage.external.js" ***!
  \**********************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/server/app-render/work-unit-async-storage.external.js");

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

"use strict";
module.exports = require("fs");

/***/ }),

/***/ "http":
/*!***********************!*\
  !*** external "http" ***!
  \***********************/
/***/ ((module) => {

"use strict";
module.exports = require("http");

/***/ }),

/***/ "https":
/*!************************!*\
  !*** external "https" ***!
  \************************/
/***/ ((module) => {

"use strict";
module.exports = require("https");

/***/ }),

/***/ "path":
/*!***********************!*\
  !*** external "path" ***!
  \***********************/
/***/ ((module) => {

"use strict";
module.exports = require("path");

/***/ }),

/***/ "punycode":
/*!***************************!*\
  !*** external "punycode" ***!
  \***************************/
/***/ ((module) => {

"use strict";
module.exports = require("punycode");

/***/ }),

/***/ "stream":
/*!*************************!*\
  !*** external "stream" ***!
  \*************************/
/***/ ((module) => {

"use strict";
module.exports = require("stream");

/***/ }),

/***/ "url":
/*!**********************!*\
  !*** external "url" ***!
  \**********************/
/***/ ((module) => {

"use strict";
module.exports = require("url");

/***/ }),

/***/ "util":
/*!***********************!*\
  !*** external "util" ***!
  \***********************/
/***/ ((module) => {

"use strict";
module.exports = require("util");

/***/ }),

/***/ "worker_threads":
/*!*********************************!*\
  !*** external "worker_threads" ***!
  \*********************************/
/***/ ((module) => {

"use strict";
module.exports = require("worker_threads");

/***/ }),

/***/ "zlib":
/*!***********************!*\
  !*** external "zlib" ***!
  \***********************/
/***/ ((module) => {

"use strict";
module.exports = require("zlib");

/***/ }),

/***/ "node:fs":
/*!**************************!*\
  !*** external "node:fs" ***!
  \**************************/
/***/ ((module) => {

"use strict";
module.exports = require("node:fs");

/***/ }),

/***/ "node:stream":
/*!******************************!*\
  !*** external "node:stream" ***!
  \******************************/
/***/ ((module) => {

"use strict";
module.exports = require("node:stream");

/***/ }),

/***/ "node:stream/web":
/*!**********************************!*\
  !*** external "node:stream/web" ***!
  \**********************************/
/***/ ((module) => {

"use strict";
module.exports = require("node:stream/web");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fask%2Froute&page=%2Fapi%2Fask%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fask%2Froute.ts&appDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!*********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fask%2Froute&page=%2Fapi%2Fask%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fask%2Froute.ts&appDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \*********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   workAsyncStorage: () => (/* binding */ workAsyncStorage),\n/* harmony export */   workUnitAsyncStorage: () => (/* binding */ workUnitAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/route-kind */ \"(rsc)/./node_modules/next/dist/server/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var _Users_alex_WebstormProjects_personal_rag_agent_app_api_ask_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./app/api/ask/route.ts */ \"(rsc)/./app/api/ask/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/ask/route\",\n        pathname: \"/api/ask\",\n        filename: \"route\",\n        bundlePath: \"app/api/ask/route\"\n    },\n    resolvedPagePath: \"/Users/alex/WebstormProjects/personal-rag-agent/app/api/ask/route.ts\",\n    nextConfigOutput,\n    userland: _Users_alex_WebstormProjects_personal_rag_agent_app_api_ask_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIvaW5kZXguanM/bmFtZT1hcHAlMkZhcGklMkZhc2slMkZyb3V0ZSZwYWdlPSUyRmFwaSUyRmFzayUyRnJvdXRlJmFwcFBhdGhzPSZwYWdlUGF0aD1wcml2YXRlLW5leHQtYXBwLWRpciUyRmFwaSUyRmFzayUyRnJvdXRlLnRzJmFwcERpcj0lMkZVc2VycyUyRmFsZXglMkZXZWJzdG9ybVByb2plY3RzJTJGcGVyc29uYWwtcmFnLWFnZW50JTJGYXBwJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmcm9vdERpcj0lMkZVc2VycyUyRmFsZXglMkZXZWJzdG9ybVByb2plY3RzJTJGcGVyc29uYWwtcmFnLWFnZW50JmlzRGV2PXRydWUmdHNjb25maWdQYXRoPXRzY29uZmlnLmpzb24mYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEISIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUErRjtBQUN2QztBQUNxQjtBQUNvQjtBQUNqRztBQUNBO0FBQ0E7QUFDQSx3QkFBd0IseUdBQW1CO0FBQzNDO0FBQ0EsY0FBYyxrRUFBUztBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsWUFBWTtBQUNaLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQSxRQUFRLHNEQUFzRDtBQUM5RDtBQUNBLFdBQVcsNEVBQVc7QUFDdEI7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUMwRjs7QUFFMUYiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vPzczN2EiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwUm91dGVSb3V0ZU1vZHVsZSB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL3JvdXRlLW1vZHVsZXMvYXBwLXJvdXRlL21vZHVsZS5jb21waWxlZFwiO1xuaW1wb3J0IHsgUm91dGVLaW5kIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvcm91dGUta2luZFwiO1xuaW1wb3J0IHsgcGF0Y2hGZXRjaCBhcyBfcGF0Y2hGZXRjaCB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2xpYi9wYXRjaC1mZXRjaFwiO1xuaW1wb3J0ICogYXMgdXNlcmxhbmQgZnJvbSBcIi9Vc2Vycy9hbGV4L1dlYnN0b3JtUHJvamVjdHMvcGVyc29uYWwtcmFnLWFnZW50L2FwcC9hcGkvYXNrL3JvdXRlLnRzXCI7XG4vLyBXZSBpbmplY3QgdGhlIG5leHRDb25maWdPdXRwdXQgaGVyZSBzbyB0aGF0IHdlIGNhbiB1c2UgdGhlbSBpbiB0aGUgcm91dGVcbi8vIG1vZHVsZS5cbmNvbnN0IG5leHRDb25maWdPdXRwdXQgPSBcIlwiXG5jb25zdCByb3V0ZU1vZHVsZSA9IG5ldyBBcHBSb3V0ZVJvdXRlTW9kdWxlKHtcbiAgICBkZWZpbml0aW9uOiB7XG4gICAgICAgIGtpbmQ6IFJvdXRlS2luZC5BUFBfUk9VVEUsXG4gICAgICAgIHBhZ2U6IFwiL2FwaS9hc2svcm91dGVcIixcbiAgICAgICAgcGF0aG5hbWU6IFwiL2FwaS9hc2tcIixcbiAgICAgICAgZmlsZW5hbWU6IFwicm91dGVcIixcbiAgICAgICAgYnVuZGxlUGF0aDogXCJhcHAvYXBpL2Fzay9yb3V0ZVwiXG4gICAgfSxcbiAgICByZXNvbHZlZFBhZ2VQYXRoOiBcIi9Vc2Vycy9hbGV4L1dlYnN0b3JtUHJvamVjdHMvcGVyc29uYWwtcmFnLWFnZW50L2FwcC9hcGkvYXNrL3JvdXRlLnRzXCIsXG4gICAgbmV4dENvbmZpZ091dHB1dCxcbiAgICB1c2VybGFuZFxufSk7XG4vLyBQdWxsIG91dCB0aGUgZXhwb3J0cyB0aGF0IHdlIG5lZWQgdG8gZXhwb3NlIGZyb20gdGhlIG1vZHVsZS4gVGhpcyBzaG91bGRcbi8vIGJlIGVsaW1pbmF0ZWQgd2hlbiB3ZSd2ZSBtb3ZlZCB0aGUgb3RoZXIgcm91dGVzIHRvIHRoZSBuZXcgZm9ybWF0LiBUaGVzZVxuLy8gYXJlIHVzZWQgdG8gaG9vayBpbnRvIHRoZSByb3V0ZS5cbmNvbnN0IHsgd29ya0FzeW5jU3RvcmFnZSwgd29ya1VuaXRBc3luY1N0b3JhZ2UsIHNlcnZlckhvb2tzIH0gPSByb3V0ZU1vZHVsZTtcbmZ1bmN0aW9uIHBhdGNoRmV0Y2goKSB7XG4gICAgcmV0dXJuIF9wYXRjaEZldGNoKHtcbiAgICAgICAgd29ya0FzeW5jU3RvcmFnZSxcbiAgICAgICAgd29ya1VuaXRBc3luY1N0b3JhZ2VcbiAgICB9KTtcbn1cbmV4cG9ydCB7IHJvdXRlTW9kdWxlLCB3b3JrQXN5bmNTdG9yYWdlLCB3b3JrVW5pdEFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MsIHBhdGNoRmV0Y2gsICB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1hcHAtcm91dGUuanMubWFwIl0sIm5hbWVzIjpbXSwiaWdub3JlTGlzdCI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fask%2Froute&page=%2Fapi%2Fask%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fask%2Froute.ts&appDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-flight-client-entry-loader.js?server=true!":
/*!******************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-flight-client-entry-loader.js?server=true! ***!
  \******************************************************************************************************/
/***/ (() => {



/***/ }),

/***/ "(ssr)/./node_modules/next/dist/build/webpack/loaders/next-flight-client-entry-loader.js?server=true!":
/*!******************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-flight-client-entry-loader.js?server=true! ***!
  \******************************************************************************************************/
/***/ (() => {



/***/ }),

/***/ "(rsc)/./app/api/ask/route.ts":
/*!******************************!*\
  !*** ./app/api/ask/route.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   POST: () => (/* binding */ POST)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/next/dist/api/server.js\");\n/* harmony import */ var _supabase_supabase_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! @supabase/supabase-js */ \"(rsc)/./node_modules/@supabase/supabase-js/dist/module/index.js\");\n/* harmony import */ var openai__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! openai */ \"(rsc)/./node_modules/openai/index.mjs\");\n/* harmony import */ var _lib_modelProvider__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../../lib/modelProvider */ \"(rsc)/./lib/modelProvider.ts\");\n/* harmony import */ var _lib_prompt__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../../lib/prompt */ \"(rsc)/./lib/prompt.ts\");\n\n\n\n\n\nconst openai = new openai__WEBPACK_IMPORTED_MODULE_3__[\"default\"]({\n    apiKey: process.env.OPENAI_API_KEY\n});\nfunction approxTokenLen(s) {\n    return Math.ceil(s.length / 4);\n}\nfunction dedupeAndMerge(matches) {\n    const seen = new Set();\n    const unique = [];\n    for (const m of matches){\n        const key = `${m.document_id}:${m.chunk_text.slice(0, 100)}`;\n        if (!seen.has(key)) {\n            seen.add(key);\n            unique.push(m);\n        }\n    }\n    return unique;\n}\n// Очистка JSON от markdown\nfunction cleanJSON(raw) {\n    return raw.replace(/```json\\s*/g, '').replace(/```\\s*/g, '').trim();\n}\nasync function POST(request) {\n    const t0 = Date.now();\n    try {\n        const supabase = (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_4__.createClient)(\"https://zqharntcylmxxdcvbtqi.supabase.co\", process.env.SUPABASE_SERVICE_ROLE_KEY);\n        const token = request.headers.get(\"authorization\")?.replace(\"Bearer \", \"\");\n        if (!token) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Не авторизован\"\n        }, {\n            status: 401\n        });\n        const { data: { user }, error: authError } = await supabase.auth.getUser(token);\n        if (authError || !user) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Не авторизован\"\n        }, {\n            status: 401\n        });\n        const body = await request.json();\n        const { question, provider } = body;\n        if (!question?.trim()) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Вопрос не предоставлен\"\n            }, {\n                status: 400\n            });\n        }\n        console.log(`Вопрос: \"${question}\"`);\n        const { count } = await supabase.from(\"doc_chunks\").select(\"*\", {\n            count: \"exact\",\n            head: true\n        }).eq(\"user_id\", user.id);\n        if (!count) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                answer: \"У вас нет загруженных документов. Загрузите документы и повторите вопрос.\",\n                question\n            });\n        }\n        console.log('Генерация эмбеддинга...');\n        const embedRes = await openai.embeddings.create({\n            model: \"text-embedding-3-small\",\n            input: question\n        });\n        const queryEmbedding = embedRes.data[0].embedding;\n        console.log('Поиск релевантных чанков...');\n        const { data: matches, error: matchError } = await supabase.rpc(\"match_doc_chunks\", {\n            query_embedding: queryEmbedding,\n            match_threshold: 0.35,\n            match_count: 8,\n            filter_user_id: user.id\n        });\n        if (matchError) {\n            console.error('Match error:', matchError);\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: matchError.message\n            }, {\n                status: 500\n            });\n        }\n        if (!matches?.length) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                answer: \"Не нашёл релевантной информации в документах. Попробуйте переформулировать вопрос.\",\n                question\n            });\n        }\n        console.log(`Найдено ${matches.length} чанков`);\n        const uniq = dedupeAndMerge(matches).slice(0, 6);\n        const chunks = uniq.map((m)=>({\n                doc_id: m.document_id,\n                chunk_index: m.chunk_index ?? 0,\n                similarity: m.similarity ?? 0,\n                text: (m.chunk_text || \"\").slice(0, 2000)\n            }));\n        const ctxTokens = approxTokenLen(chunks.map((c)=>c.text).join(\" \"));\n        const providerFinal = provider ?? (ctxTokens > 120000 ? \"anthropic\" : \"openai\");\n        console.log(`Используется провайдер: ${providerFinal}, контекст: ${ctxTokens} токенов`);\n        const userPrompt = (0,_lib_prompt__WEBPACK_IMPORTED_MODULE_2__.buildUserPrompt)(question, chunks);\n        console.log('Запрос к модели...');\n        const raw = await (0,_lib_modelProvider__WEBPACK_IMPORTED_MODULE_1__.chatWithProvider)(providerFinal, {\n            system: _lib_prompt__WEBPACK_IMPORTED_MODULE_2__.SYSTEM_RAG,\n            user: userPrompt,\n            maxTokens: 2000 // Увеличено с 1200\n        });\n        console.log(`Raw ответ (${raw.length} символов):`, raw.substring(0, 200));\n        let parsed = null;\n        try {\n            const cleaned = cleanJSON(raw);\n            if (cleaned) {\n                parsed = JSON.parse(cleaned);\n                console.log('JSON успешно распарсен');\n            }\n        } catch (e) {\n            console.error('JSON parse error:', e);\n            console.log('Попытка использовать raw ответ как plain text');\n        }\n        const answer = parsed?.answer || raw || \"Ошибка: пустой ответ от модели\";\n        const citations = parsed?.citations || chunks.slice(0, 3).map((c)=>({\n                doc_id: c.doc_id,\n                chunk_index: c.chunk_index,\n                similarity: c.similarity,\n                quote: c.text.slice(0, 200)\n            }));\n        console.log('Ответ получен');\n        const latency = Date.now() - t0;\n        await supabase.from(\"messages\").insert([\n            {\n                user_id: user.id,\n                role: \"user\",\n                content: question\n            },\n            {\n                user_id: user.id,\n                role: \"assistant\",\n                content: answer,\n                metadata: {\n                    provider: providerFinal,\n                    latency_ms: latency,\n                    sources: citations\n                }\n            }\n        ]);\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            answer,\n            question,\n            sources: citations,\n            provider: providerFinal,\n            latency_ms: latency\n        });\n    } catch (err) {\n        console.error('Error:', err);\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: err?.message || \"Unknown error\"\n        }, {\n            status: 500\n        });\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9hcHAvYXBpL2Fzay9yb3V0ZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBd0Q7QUFDSDtBQUN6QjtBQUNrQztBQUNJO0FBRWxFLE1BQU1NLFNBQVMsSUFBSUosOENBQU1BLENBQUM7SUFBRUssUUFBUUMsUUFBUUMsR0FBRyxDQUFDQyxjQUFjO0FBQUM7QUFFL0QsU0FBU0MsZUFBZUMsQ0FBUztJQUMvQixPQUFPQyxLQUFLQyxJQUFJLENBQUNGLEVBQUVHLE1BQU0sR0FBRztBQUM5QjtBQUVBLFNBQVNDLGVBQWVDLE9BQWM7SUFDcEMsTUFBTUMsT0FBTyxJQUFJQztJQUNqQixNQUFNQyxTQUFTLEVBQUU7SUFDakIsS0FBSyxNQUFNQyxLQUFLSixRQUFTO1FBQ3ZCLE1BQU1LLE1BQU0sR0FBR0QsRUFBRUUsV0FBVyxDQUFDLENBQUMsRUFBRUYsRUFBRUcsVUFBVSxDQUFDQyxLQUFLLENBQUMsR0FBRyxNQUFNO1FBQzVELElBQUksQ0FBQ1AsS0FBS1EsR0FBRyxDQUFDSixNQUFNO1lBQ2xCSixLQUFLUyxHQUFHLENBQUNMO1lBQ1RGLE9BQU9RLElBQUksQ0FBQ1A7UUFDZDtJQUNGO0lBQ0EsT0FBT0Q7QUFDVDtBQUVBLDJCQUEyQjtBQUMzQixTQUFTUyxVQUFVQyxHQUFXO0lBQzVCLE9BQU9BLElBQ0ZDLE9BQU8sQ0FBQyxlQUFlLElBQ3ZCQSxPQUFPLENBQUMsV0FBVyxJQUNuQkMsSUFBSTtBQUNYO0FBRU8sZUFBZUMsS0FBS0MsT0FBb0I7SUFDN0MsTUFBTUMsS0FBS0MsS0FBS0MsR0FBRztJQUVuQixJQUFJO1FBQ0YsTUFBTUMsV0FBV3JDLG1FQUFZQSxDQUN6Qk8sMENBQW9DLEVBQ3BDQSxRQUFRQyxHQUFHLENBQUMrQix5QkFBeUI7UUFHekMsTUFBTUMsUUFBUVAsUUFBUVEsT0FBTyxDQUFDQyxHQUFHLENBQUMsa0JBQWtCWixRQUFRLFdBQVc7UUFDdkUsSUFBSSxDQUFDVSxPQUFPLE9BQU96QyxxREFBWUEsQ0FBQzRDLElBQUksQ0FBQztZQUFFQyxPQUFPO1FBQWlCLEdBQUc7WUFBRUMsUUFBUTtRQUFJO1FBRWhGLE1BQU0sRUFBRUMsTUFBTSxFQUFFQyxJQUFJLEVBQUUsRUFBRUgsT0FBT0ksU0FBUyxFQUFFLEdBQUcsTUFBTVgsU0FBU1ksSUFBSSxDQUFDQyxPQUFPLENBQUNWO1FBQ3pFLElBQUlRLGFBQWEsQ0FBQ0QsTUFBTSxPQUFPaEQscURBQVlBLENBQUM0QyxJQUFJLENBQUM7WUFBRUMsT0FBTztRQUFpQixHQUFHO1lBQUVDLFFBQVE7UUFBSTtRQUU1RixNQUFNTSxPQUFPLE1BQU1sQixRQUFRVSxJQUFJO1FBQy9CLE1BQU0sRUFBRVMsUUFBUSxFQUFFQyxRQUFRLEVBQUUsR0FBR0Y7UUFFL0IsSUFBSSxDQUFDQyxVQUFVckIsUUFBUTtZQUNyQixPQUFPaEMscURBQVlBLENBQUM0QyxJQUFJLENBQUM7Z0JBQUVDLE9BQU87WUFBeUIsR0FBRztnQkFBRUMsUUFBUTtZQUFJO1FBQzlFO1FBRUFTLFFBQVFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsRUFBRUgsU0FBUyxDQUFDLENBQUM7UUFFbkMsTUFBTSxFQUFFSSxLQUFLLEVBQUUsR0FBRyxNQUFNbkIsU0FDbkJvQixJQUFJLENBQUMsY0FDTEMsTUFBTSxDQUFDLEtBQUs7WUFBRUYsT0FBTztZQUFTRyxNQUFNO1FBQUssR0FDekNDLEVBQUUsQ0FBQyxXQUFXYixLQUFLYyxFQUFFO1FBRTFCLElBQUksQ0FBQ0wsT0FBTztZQUNWLE9BQU96RCxxREFBWUEsQ0FBQzRDLElBQUksQ0FBQztnQkFDdkJtQixRQUFRO2dCQUNSVjtZQUNGO1FBQ0Y7UUFFQUUsUUFBUUMsR0FBRyxDQUFDO1FBQ1osTUFBTVEsV0FBVyxNQUFNMUQsT0FBTzJELFVBQVUsQ0FBQ0MsTUFBTSxDQUFDO1lBQzlDQyxPQUFPO1lBQ1BDLE9BQU9mO1FBQ1Q7UUFDQSxNQUFNZ0IsaUJBQWlCTCxTQUFTakIsSUFBSSxDQUFDLEVBQUUsQ0FBQ3VCLFNBQVM7UUFFakRmLFFBQVFDLEdBQUcsQ0FBQztRQUNaLE1BQU0sRUFBRVQsTUFBTTlCLE9BQU8sRUFBRTRCLE9BQU8wQixVQUFVLEVBQUUsR0FBRyxNQUFNakMsU0FBU2tDLEdBQUcsQ0FBQyxvQkFBb0I7WUFDbEZDLGlCQUFpQko7WUFDakJLLGlCQUFpQjtZQUNqQkMsYUFBYTtZQUNiQyxnQkFBZ0I1QixLQUFLYyxFQUFFO1FBQ3pCO1FBRUEsSUFBSVMsWUFBWTtZQUNkaEIsUUFBUVYsS0FBSyxDQUFDLGdCQUFnQjBCO1lBQzlCLE9BQU92RSxxREFBWUEsQ0FBQzRDLElBQUksQ0FBQztnQkFBRUMsT0FBTzBCLFdBQVdNLE9BQU87WUFBQyxHQUFHO2dCQUFFL0IsUUFBUTtZQUFJO1FBQ3hFO1FBRUEsSUFBSSxDQUFDN0IsU0FBU0YsUUFBUTtZQUNwQixPQUFPZixxREFBWUEsQ0FBQzRDLElBQUksQ0FBQztnQkFDdkJtQixRQUFRO2dCQUNSVjtZQUNGO1FBQ0Y7UUFFQUUsUUFBUUMsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFdkMsUUFBUUYsTUFBTSxDQUFDLE9BQU8sQ0FBQztRQUU5QyxNQUFNK0QsT0FBTzlELGVBQWVDLFNBQVNRLEtBQUssQ0FBQyxHQUFHO1FBQzlDLE1BQU1zRCxTQUFTRCxLQUFLRSxHQUFHLENBQUMsQ0FBQzNELElBQVk7Z0JBQ25DNEQsUUFBUTVELEVBQUVFLFdBQVc7Z0JBQ3JCMkQsYUFBYTdELEVBQUU2RCxXQUFXLElBQUk7Z0JBQzlCQyxZQUFZOUQsRUFBRThELFVBQVUsSUFBSTtnQkFDNUJDLE1BQU0sQ0FBQy9ELEVBQUVHLFVBQVUsSUFBSSxFQUFDLEVBQUdDLEtBQUssQ0FBQyxHQUFHO1lBQ3RDO1FBRUEsTUFBTTRELFlBQVkxRSxlQUFlb0UsT0FBT0MsR0FBRyxDQUFDTSxDQUFBQSxJQUFLQSxFQUFFRixJQUFJLEVBQUVHLElBQUksQ0FBQztRQUM5RCxNQUFNQyxnQkFBZ0IsWUFDakJILENBQUFBLFlBQVksU0FBVSxjQUFjLFFBQU87UUFFaEQ5QixRQUFRQyxHQUFHLENBQUMsQ0FBQyx3QkFBd0IsRUFBRWdDLGNBQWMsWUFBWSxFQUFFSCxVQUFVLFFBQVEsQ0FBQztRQUV0RixNQUFNSSxhQUFhcEYsNERBQWVBLENBQUNnRCxVQUFVMEI7UUFFN0N4QixRQUFRQyxHQUFHLENBQUM7UUFDWixNQUFNMUIsTUFBTSxNQUFNM0Isb0VBQWdCQSxDQUFDcUYsZUFBZTtZQUNoREUsUUFBUXRGLG1EQUFVQTtZQUNsQjRDLE1BQU15QztZQUNORSxXQUFXLEtBQU0sbUJBQW1CO1FBQ3RDO1FBRUFwQyxRQUFRQyxHQUFHLENBQUMsQ0FBQyxXQUFXLEVBQUUxQixJQUFJZixNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUVlLElBQUk4RCxTQUFTLENBQUMsR0FBRztRQUVwRSxJQUFJQyxTQVFPO1FBRVgsSUFBSTtZQUNGLE1BQU1DLFVBQVVqRSxVQUFVQztZQUMxQixJQUFJZ0UsU0FBUztnQkFDWEQsU0FBU0UsS0FBS0MsS0FBSyxDQUFDRjtnQkFDcEJ2QyxRQUFRQyxHQUFHLENBQUM7WUFDZDtRQUNGLEVBQUUsT0FBT3lDLEdBQUc7WUFDVjFDLFFBQVFWLEtBQUssQ0FBQyxxQkFBcUJvRDtZQUNuQzFDLFFBQVFDLEdBQUcsQ0FBQztRQUNkO1FBRUEsTUFBTU8sU0FBUzhCLFFBQVE5QixVQUFVakMsT0FBTztRQUN4QyxNQUFNb0UsWUFBWUwsUUFBUUssYUFBYW5CLE9BQU90RCxLQUFLLENBQUMsR0FBRyxHQUFHdUQsR0FBRyxDQUFDTSxDQUFBQSxJQUFNO2dCQUNsRUwsUUFBUUssRUFBRUwsTUFBTTtnQkFDaEJDLGFBQWFJLEVBQUVKLFdBQVc7Z0JBQzFCQyxZQUFZRyxFQUFFSCxVQUFVO2dCQUN4QmdCLE9BQU9iLEVBQUVGLElBQUksQ0FBQzNELEtBQUssQ0FBQyxHQUFHO1lBQ3pCO1FBRUE4QixRQUFRQyxHQUFHLENBQUM7UUFFWixNQUFNNEMsVUFBVWhFLEtBQUtDLEdBQUcsS0FBS0Y7UUFDN0IsTUFBTUcsU0FBU29CLElBQUksQ0FBQyxZQUFZMkMsTUFBTSxDQUFDO1lBQ3JDO2dCQUFFQyxTQUFTdEQsS0FBS2MsRUFBRTtnQkFBRXlDLE1BQU07Z0JBQVFDLFNBQVNuRDtZQUFTO1lBQ3BEO2dCQUNFaUQsU0FBU3RELEtBQUtjLEVBQUU7Z0JBQ2hCeUMsTUFBTTtnQkFDTkMsU0FBU3pDO2dCQUNUMEMsVUFBVTtvQkFDUm5ELFVBQVVrQztvQkFDVmtCLFlBQVlOO29CQUNaTyxTQUFTVDtnQkFDWDtZQUNGO1NBQ0Q7UUFFRCxPQUFPbEcscURBQVlBLENBQUM0QyxJQUFJLENBQUM7WUFDdkJtQjtZQUNBVjtZQUNBc0QsU0FBU1Q7WUFDVDVDLFVBQVVrQztZQUNWa0IsWUFBWU47UUFDZDtJQUVGLEVBQUUsT0FBT1EsS0FBVTtRQUNqQnJELFFBQVFWLEtBQUssQ0FBQyxVQUFVK0Q7UUFDeEIsT0FBTzVHLHFEQUFZQSxDQUFDNEMsSUFBSSxDQUFDO1lBQ3ZCQyxPQUFPK0QsS0FBSy9CLFdBQVc7UUFDekIsR0FBRztZQUFFL0IsUUFBUTtRQUFJO0lBQ25CO0FBQ0YiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi9hcHAvYXBpL2Fzay9yb3V0ZS50cz9iOWVlIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5leHRSZXF1ZXN0LCBOZXh0UmVzcG9uc2UgfSBmcm9tIFwibmV4dC9zZXJ2ZXJcIjtcbmltcG9ydCB7IGNyZWF0ZUNsaWVudCB9IGZyb20gXCJAc3VwYWJhc2Uvc3VwYWJhc2UtanNcIjtcbmltcG9ydCBPcGVuQUkgZnJvbSBcIm9wZW5haVwiO1xuaW1wb3J0IHsgY2hhdFdpdGhQcm92aWRlciB9IGZyb20gXCIuLi8uLi8uLi9saWIvbW9kZWxQcm92aWRlclwiO1xuaW1wb3J0IHsgU1lTVEVNX1JBRywgYnVpbGRVc2VyUHJvbXB0IH0gZnJvbSBcIi4uLy4uLy4uL2xpYi9wcm9tcHRcIjtcblxuY29uc3Qgb3BlbmFpID0gbmV3IE9wZW5BSSh7IGFwaUtleTogcHJvY2Vzcy5lbnYuT1BFTkFJX0FQSV9LRVkgfSk7XG5cbmZ1bmN0aW9uIGFwcHJveFRva2VuTGVuKHM6IHN0cmluZykge1xuICByZXR1cm4gTWF0aC5jZWlsKHMubGVuZ3RoIC8gNCk7XG59XG5cbmZ1bmN0aW9uIGRlZHVwZUFuZE1lcmdlKG1hdGNoZXM6IGFueVtdKSB7XG4gIGNvbnN0IHNlZW4gPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgY29uc3QgdW5pcXVlID0gW107XG4gIGZvciAoY29uc3QgbSBvZiBtYXRjaGVzKSB7XG4gICAgY29uc3Qga2V5ID0gYCR7bS5kb2N1bWVudF9pZH06JHttLmNodW5rX3RleHQuc2xpY2UoMCwgMTAwKX1gO1xuICAgIGlmICghc2Vlbi5oYXMoa2V5KSkge1xuICAgICAgc2Vlbi5hZGQoa2V5KTtcbiAgICAgIHVuaXF1ZS5wdXNoKG0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gdW5pcXVlO1xufVxuXG4vLyDQntGH0LjRgdGC0LrQsCBKU09OINC+0YIgbWFya2Rvd25cbmZ1bmN0aW9uIGNsZWFuSlNPTihyYXc6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiByYXdcbiAgICAgIC5yZXBsYWNlKC9gYGBqc29uXFxzKi9nLCAnJylcbiAgICAgIC5yZXBsYWNlKC9gYGBcXHMqL2csICcnKVxuICAgICAgLnRyaW0oKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFBPU1QocmVxdWVzdDogTmV4dFJlcXVlc3QpIHtcbiAgY29uc3QgdDAgPSBEYXRlLm5vdygpO1xuXG4gIHRyeSB7XG4gICAgY29uc3Qgc3VwYWJhc2UgPSBjcmVhdGVDbGllbnQoXG4gICAgICAgIHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTCEsXG4gICAgICAgIHByb2Nlc3MuZW52LlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVkhXG4gICAgKTtcblxuICAgIGNvbnN0IHRva2VuID0gcmVxdWVzdC5oZWFkZXJzLmdldChcImF1dGhvcml6YXRpb25cIik/LnJlcGxhY2UoXCJCZWFyZXIgXCIsIFwiXCIpO1xuICAgIGlmICghdG9rZW4pIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBcItCd0LUg0LDQstGC0L7RgNC40LfQvtCy0LDQvVwiIH0sIHsgc3RhdHVzOiA0MDEgfSk7XG5cbiAgICBjb25zdCB7IGRhdGE6IHsgdXNlciB9LCBlcnJvcjogYXV0aEVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZS5hdXRoLmdldFVzZXIodG9rZW4pO1xuICAgIGlmIChhdXRoRXJyb3IgfHwgIXVzZXIpIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBcItCd0LUg0LDQstGC0L7RgNC40LfQvtCy0LDQvVwiIH0sIHsgc3RhdHVzOiA0MDEgfSk7XG5cbiAgICBjb25zdCBib2R5ID0gYXdhaXQgcmVxdWVzdC5qc29uKCk7XG4gICAgY29uc3QgeyBxdWVzdGlvbiwgcHJvdmlkZXIgfSA9IGJvZHk7XG5cbiAgICBpZiAoIXF1ZXN0aW9uPy50cmltKCkpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBcItCS0L7Qv9GA0L7RgSDQvdC1INC/0YDQtdC00L7RgdGC0LDQstC70LXQvVwiIH0sIHsgc3RhdHVzOiA0MDAgfSk7XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coYNCS0L7Qv9GA0L7RgTogXCIke3F1ZXN0aW9ufVwiYCk7XG5cbiAgICBjb25zdCB7IGNvdW50IH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgICAuZnJvbShcImRvY19jaHVua3NcIilcbiAgICAgICAgLnNlbGVjdChcIipcIiwgeyBjb3VudDogXCJleGFjdFwiLCBoZWFkOiB0cnVlIH0pXG4gICAgICAgIC5lcShcInVzZXJfaWRcIiwgdXNlci5pZCk7XG5cbiAgICBpZiAoIWNvdW50KSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgICBhbnN3ZXI6IFwi0KMg0LLQsNGBINC90LXRgiDQt9Cw0LPRgNGD0LbQtdC90L3Ri9GFINC00L7QutGD0LzQtdC90YLQvtCyLiDQl9Cw0LPRgNGD0LfQuNGC0LUg0LTQvtC60YPQvNC10L3RgtGLINC4INC/0L7QstGC0L7RgNC40YLQtSDQstC+0L/RgNC+0YEuXCIsXG4gICAgICAgIHF1ZXN0aW9uLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coJ9CT0LXQvdC10YDQsNGG0LjRjyDRjdC80LHQtdC00LTQuNC90LPQsC4uLicpO1xuICAgIGNvbnN0IGVtYmVkUmVzID0gYXdhaXQgb3BlbmFpLmVtYmVkZGluZ3MuY3JlYXRlKHtcbiAgICAgIG1vZGVsOiBcInRleHQtZW1iZWRkaW5nLTMtc21hbGxcIixcbiAgICAgIGlucHV0OiBxdWVzdGlvblxuICAgIH0pO1xuICAgIGNvbnN0IHF1ZXJ5RW1iZWRkaW5nID0gZW1iZWRSZXMuZGF0YVswXS5lbWJlZGRpbmc7XG5cbiAgICBjb25zb2xlLmxvZygn0J/QvtC40YHQuiDRgNC10LvQtdCy0LDQvdGC0L3Ri9GFINGH0LDQvdC60L7Qsi4uLicpO1xuICAgIGNvbnN0IHsgZGF0YTogbWF0Y2hlcywgZXJyb3I6IG1hdGNoRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLnJwYyhcIm1hdGNoX2RvY19jaHVua3NcIiwge1xuICAgICAgcXVlcnlfZW1iZWRkaW5nOiBxdWVyeUVtYmVkZGluZyxcbiAgICAgIG1hdGNoX3RocmVzaG9sZDogMC4zNSxcbiAgICAgIG1hdGNoX2NvdW50OiA4LFxuICAgICAgZmlsdGVyX3VzZXJfaWQ6IHVzZXIuaWRcbiAgICB9KTtcblxuICAgIGlmIChtYXRjaEVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdNYXRjaCBlcnJvcjonLCBtYXRjaEVycm9yKTtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBtYXRjaEVycm9yLm1lc3NhZ2UgfSwgeyBzdGF0dXM6IDUwMCB9KTtcbiAgICB9XG5cbiAgICBpZiAoIW1hdGNoZXM/Lmxlbmd0aCkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHtcbiAgICAgICAgYW5zd2VyOiBcItCd0LUg0L3QsNGI0ZHQuyDRgNC10LvQtdCy0LDQvdGC0L3QvtC5INC40L3RhNC+0YDQvNCw0YbQuNC4INCyINC00L7QutGD0LzQtdC90YLQsNGFLiDQn9C+0L/RgNC+0LHRg9C50YLQtSDQv9C10YDQtdGE0L7RgNC80YPQu9C40YDQvtCy0LDRgtGMINCy0L7Qv9GA0L7RgS5cIixcbiAgICAgICAgcXVlc3Rpb25cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGDQndCw0LnQtNC10L3QviAke21hdGNoZXMubGVuZ3RofSDRh9Cw0L3QutC+0LJgKTtcblxuICAgIGNvbnN0IHVuaXEgPSBkZWR1cGVBbmRNZXJnZShtYXRjaGVzKS5zbGljZSgwLCA2KTtcbiAgICBjb25zdCBjaHVua3MgPSB1bmlxLm1hcCgobTogYW55KSA9PiAoe1xuICAgICAgZG9jX2lkOiBtLmRvY3VtZW50X2lkLFxuICAgICAgY2h1bmtfaW5kZXg6IG0uY2h1bmtfaW5kZXggPz8gMCxcbiAgICAgIHNpbWlsYXJpdHk6IG0uc2ltaWxhcml0eSA/PyAwLFxuICAgICAgdGV4dDogKG0uY2h1bmtfdGV4dCB8fCBcIlwiKS5zbGljZSgwLCAyMDAwKVxuICAgIH0pKTtcblxuICAgIGNvbnN0IGN0eFRva2VucyA9IGFwcHJveFRva2VuTGVuKGNodW5rcy5tYXAoYyA9PiBjLnRleHQpLmpvaW4oXCIgXCIpKTtcbiAgICBjb25zdCBwcm92aWRlckZpbmFsID0gKHByb3ZpZGVyIGFzIFwib3BlbmFpXCIgfCBcImFudGhyb3BpY1wiKSA/P1xuICAgICAgICAoY3R4VG9rZW5zID4gMTIwXzAwMCA/IFwiYW50aHJvcGljXCIgOiBcIm9wZW5haVwiKTtcblxuICAgIGNvbnNvbGUubG9nKGDQmNGB0L/QvtC70YzQt9GD0LXRgtGB0Y8g0L/RgNC+0LLQsNC50LTQtdGAOiAke3Byb3ZpZGVyRmluYWx9LCDQutC+0L3RgtC10LrRgdGCOiAke2N0eFRva2Vuc30g0YLQvtC60LXQvdC+0LJgKTtcblxuICAgIGNvbnN0IHVzZXJQcm9tcHQgPSBidWlsZFVzZXJQcm9tcHQocXVlc3Rpb24sIGNodW5rcyk7XG5cbiAgICBjb25zb2xlLmxvZygn0JfQsNC/0YDQvtGBINC6INC80L7QtNC10LvQuC4uLicpO1xuICAgIGNvbnN0IHJhdyA9IGF3YWl0IGNoYXRXaXRoUHJvdmlkZXIocHJvdmlkZXJGaW5hbCwge1xuICAgICAgc3lzdGVtOiBTWVNURU1fUkFHLFxuICAgICAgdXNlcjogdXNlclByb21wdCxcbiAgICAgIG1heFRva2VuczogMjAwMCAgLy8g0KPQstC10LvQuNGH0LXQvdC+INGBIDEyMDBcbiAgICB9KTtcblxuICAgIGNvbnNvbGUubG9nKGBSYXcg0L7RgtCy0LXRgiAoJHtyYXcubGVuZ3RofSDRgdC40LzQstC+0LvQvtCyKTpgLCByYXcuc3Vic3RyaW5nKDAsIDIwMCkpO1xuXG4gICAgbGV0IHBhcnNlZDoge1xuICAgICAgYW5zd2VyOiBzdHJpbmc7XG4gICAgICBjaXRhdGlvbnM6IEFycmF5PHtcbiAgICAgICAgZG9jX2lkOiBzdHJpbmc7XG4gICAgICAgIGNodW5rX2luZGV4OiBudW1iZXI7XG4gICAgICAgIHNpbWlsYXJpdHk6IG51bWJlcjtcbiAgICAgICAgcXVvdGU6IHN0cmluZ1xuICAgICAgfT5cbiAgICB9IHwgbnVsbCA9IG51bGw7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgY2xlYW5lZCA9IGNsZWFuSlNPTihyYXcpO1xuICAgICAgaWYgKGNsZWFuZWQpIHtcbiAgICAgICAgcGFyc2VkID0gSlNPTi5wYXJzZShjbGVhbmVkKTtcbiAgICAgICAgY29uc29sZS5sb2coJ0pTT04g0YPRgdC/0LXRiNC90L4g0YDQsNGB0L/QsNGA0YHQtdC9Jyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5lcnJvcignSlNPTiBwYXJzZSBlcnJvcjonLCBlKTtcbiAgICAgIGNvbnNvbGUubG9nKCfQn9C+0L/Ri9GC0LrQsCDQuNGB0L/QvtC70YzQt9C+0LLQsNGC0YwgcmF3INC+0YLQstC10YIg0LrQsNC6IHBsYWluIHRleHQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBhbnN3ZXIgPSBwYXJzZWQ/LmFuc3dlciB8fCByYXcgfHwgXCLQntGI0LjQsdC60LA6INC/0YPRgdGC0L7QuSDQvtGC0LLQtdGCINC+0YIg0LzQvtC00LXQu9C4XCI7XG4gICAgY29uc3QgY2l0YXRpb25zID0gcGFyc2VkPy5jaXRhdGlvbnMgfHwgY2h1bmtzLnNsaWNlKDAsIDMpLm1hcChjID0+ICh7XG4gICAgICBkb2NfaWQ6IGMuZG9jX2lkLFxuICAgICAgY2h1bmtfaW5kZXg6IGMuY2h1bmtfaW5kZXgsXG4gICAgICBzaW1pbGFyaXR5OiBjLnNpbWlsYXJpdHksXG4gICAgICBxdW90ZTogYy50ZXh0LnNsaWNlKDAsIDIwMClcbiAgICB9KSk7XG5cbiAgICBjb25zb2xlLmxvZygn0J7RgtCy0LXRgiDQv9C+0LvRg9GH0LXQvScpO1xuXG4gICAgY29uc3QgbGF0ZW5jeSA9IERhdGUubm93KCkgLSB0MDtcbiAgICBhd2FpdCBzdXBhYmFzZS5mcm9tKFwibWVzc2FnZXNcIikuaW5zZXJ0KFtcbiAgICAgIHsgdXNlcl9pZDogdXNlci5pZCwgcm9sZTogXCJ1c2VyXCIsIGNvbnRlbnQ6IHF1ZXN0aW9uIH0sXG4gICAgICB7XG4gICAgICAgIHVzZXJfaWQ6IHVzZXIuaWQsXG4gICAgICAgIHJvbGU6IFwiYXNzaXN0YW50XCIsXG4gICAgICAgIGNvbnRlbnQ6IGFuc3dlcixcbiAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICBwcm92aWRlcjogcHJvdmlkZXJGaW5hbCxcbiAgICAgICAgICBsYXRlbmN5X21zOiBsYXRlbmN5LFxuICAgICAgICAgIHNvdXJjZXM6IGNpdGF0aW9uc1xuICAgICAgICB9XG4gICAgICB9XG4gICAgXSk7XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgYW5zd2VyLFxuICAgICAgcXVlc3Rpb24sXG4gICAgICBzb3VyY2VzOiBjaXRhdGlvbnMsXG4gICAgICBwcm92aWRlcjogcHJvdmlkZXJGaW5hbCxcbiAgICAgIGxhdGVuY3lfbXM6IGxhdGVuY3lcbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yOicsIGVycik7XG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHtcbiAgICAgIGVycm9yOiBlcnI/Lm1lc3NhZ2UgfHwgXCJVbmtub3duIGVycm9yXCJcbiAgICB9LCB7IHN0YXR1czogNTAwIH0pO1xuICB9XG59Il0sIm5hbWVzIjpbIk5leHRSZXNwb25zZSIsImNyZWF0ZUNsaWVudCIsIk9wZW5BSSIsImNoYXRXaXRoUHJvdmlkZXIiLCJTWVNURU1fUkFHIiwiYnVpbGRVc2VyUHJvbXB0Iiwib3BlbmFpIiwiYXBpS2V5IiwicHJvY2VzcyIsImVudiIsIk9QRU5BSV9BUElfS0VZIiwiYXBwcm94VG9rZW5MZW4iLCJzIiwiTWF0aCIsImNlaWwiLCJsZW5ndGgiLCJkZWR1cGVBbmRNZXJnZSIsIm1hdGNoZXMiLCJzZWVuIiwiU2V0IiwidW5pcXVlIiwibSIsImtleSIsImRvY3VtZW50X2lkIiwiY2h1bmtfdGV4dCIsInNsaWNlIiwiaGFzIiwiYWRkIiwicHVzaCIsImNsZWFuSlNPTiIsInJhdyIsInJlcGxhY2UiLCJ0cmltIiwiUE9TVCIsInJlcXVlc3QiLCJ0MCIsIkRhdGUiLCJub3ciLCJzdXBhYmFzZSIsIk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTCIsIlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVkiLCJ0b2tlbiIsImhlYWRlcnMiLCJnZXQiLCJqc29uIiwiZXJyb3IiLCJzdGF0dXMiLCJkYXRhIiwidXNlciIsImF1dGhFcnJvciIsImF1dGgiLCJnZXRVc2VyIiwiYm9keSIsInF1ZXN0aW9uIiwicHJvdmlkZXIiLCJjb25zb2xlIiwibG9nIiwiY291bnQiLCJmcm9tIiwic2VsZWN0IiwiaGVhZCIsImVxIiwiaWQiLCJhbnN3ZXIiLCJlbWJlZFJlcyIsImVtYmVkZGluZ3MiLCJjcmVhdGUiLCJtb2RlbCIsImlucHV0IiwicXVlcnlFbWJlZGRpbmciLCJlbWJlZGRpbmciLCJtYXRjaEVycm9yIiwicnBjIiwicXVlcnlfZW1iZWRkaW5nIiwibWF0Y2hfdGhyZXNob2xkIiwibWF0Y2hfY291bnQiLCJmaWx0ZXJfdXNlcl9pZCIsIm1lc3NhZ2UiLCJ1bmlxIiwiY2h1bmtzIiwibWFwIiwiZG9jX2lkIiwiY2h1bmtfaW5kZXgiLCJzaW1pbGFyaXR5IiwidGV4dCIsImN0eFRva2VucyIsImMiLCJqb2luIiwicHJvdmlkZXJGaW5hbCIsInVzZXJQcm9tcHQiLCJzeXN0ZW0iLCJtYXhUb2tlbnMiLCJzdWJzdHJpbmciLCJwYXJzZWQiLCJjbGVhbmVkIiwiSlNPTiIsInBhcnNlIiwiZSIsImNpdGF0aW9ucyIsInF1b3RlIiwibGF0ZW5jeSIsImluc2VydCIsInVzZXJfaWQiLCJyb2xlIiwiY29udGVudCIsIm1ldGFkYXRhIiwibGF0ZW5jeV9tcyIsInNvdXJjZXMiLCJlcnIiXSwiaWdub3JlTGlzdCI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./app/api/ask/route.ts\n");

/***/ }),

/***/ "(rsc)/./lib/modelProvider.ts":
/*!******************************!*\
  !*** ./lib/modelProvider.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   chatWithAI: () => (/* binding */ chatWithAI),\n/* harmony export */   chatWithProvider: () => (/* binding */ chatWithProvider)\n/* harmony export */ });\n/* harmony import */ var openai__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! openai */ \"(rsc)/./node_modules/openai/index.mjs\");\n/* harmony import */ var _anthropic_ai_sdk__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @anthropic-ai/sdk */ \"(rsc)/./node_modules/@anthropic-ai/sdk/index.mjs\");\n\n\nconst openai = new openai__WEBPACK_IMPORTED_MODULE_0__[\"default\"]({\n    apiKey: process.env.OPENAI_API_KEY\n});\nconst anthropic = new _anthropic_ai_sdk__WEBPACK_IMPORTED_MODULE_1__[\"default\"]({\n    apiKey: process.env.ANTHROPIC_API_KEY || \"\"\n});\n// Основная новая функция\nasync function chatWithAI(args) {\n    const maxTokens = args.maxTokens ?? 4000;\n    if (args.forceProvider === \"openai\") {\n        return await callOpenAI(args.system, args.user, maxTokens);\n    }\n    if (args.forceProvider === \"anthropic\") {\n        return await callAnthropic(args.system, args.user, maxTokens);\n    }\n    // Сначала Claude, затем GPT\n    try {\n        console.log(\"🤖 Trying Claude first...\");\n        const claudeResponse = await callAnthropic(args.system, args.user, maxTokens);\n        if (claudeResponse && claudeResponse.trim().length > 0) {\n            console.log(\"✅ Claude responded successfully\");\n            return claudeResponse;\n        }\n        throw new Error(\"Claude returned empty response\");\n    } catch (claudeError) {\n        console.error(\"⚠️ Claude failed:\", claudeError);\n        console.log(\"🔄 Switching to GPT as fallback...\");\n        try {\n            const gptResponse = await callOpenAI(args.system, args.user, maxTokens);\n            console.log(\"✅ GPT responded successfully\");\n            return gptResponse;\n        } catch (gptError) {\n            console.error(\"❌ Both providers failed\");\n            throw new Error(`Both AI providers failed. Claude: ${claudeError}, GPT: ${gptError}`);\n        }\n    }\n}\n// Обратная совместимость со старым API\nasync function chatWithProvider(provider, args) {\n    console.log(`⚠️ chatWithProvider is deprecated, use chatWithAI instead`);\n    // Игнорируем параметр provider, всегда используем логику Claude → GPT\n    return await chatWithAI(args);\n}\nasync function callAnthropic(system, user, maxTokens) {\n    if (!process.env.ANTHROPIC_API_KEY) {\n        throw new Error(\"Anthropic API key not configured\");\n    }\n    const res = await anthropic.messages.create({\n        model: process.env.ANTHROPIC_MODEL || \"claude-opus-4-1-20250805\",\n        max_tokens: Math.min(maxTokens, 4096),\n        temperature: 0.2,\n        system: system,\n        messages: [\n            {\n                role: \"user\",\n                content: user\n            }\n        ]\n    });\n    const content = res.content?.[0];\n    if (content && content.type === \"text\" && content.text) {\n        return content.text;\n    }\n    throw new Error(\"Invalid response from Anthropic\");\n}\nasync function callOpenAI(system, user, maxTokens) {\n    if (!process.env.OPENAI_API_KEY) {\n        throw new Error(\"OpenAI API key not configured\");\n    }\n    const res = await openai.chat.completions.create({\n        model: process.env.OPENAI_CHAT_MODEL || \"gpt-4-turbo-preview\",\n        messages: [\n            {\n                role: \"system\",\n                content: system\n            },\n            {\n                role: \"user\",\n                content: user\n            }\n        ],\n        max_tokens: maxTokens,\n        temperature: 0.2\n    });\n    const content = res.choices[0]?.message?.content;\n    if (content) {\n        return content;\n    }\n    throw new Error(\"Invalid response from OpenAI\");\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUFDQyxXQUFXLENBQUNaLE1BQU0sQ0FBQztRQUUvQ0MsT0FBTzVCLFFBQVFDLEdBQUcsQ0FBQ3VDLGlCQUFpQixJQUFJO1FBRXhDZCxVQUFVO1lBRVI7Z0JBQUVRLE1BQU07Z0JBQVVDLFNBQVN6QjtZQUFPO1lBRWxDO2dCQUFFd0IsTUFBTTtnQkFBUUMsU0FBU3hCO1lBQUs7U0FFL0I7UUFFRG1CLFlBQVl2QjtRQUVaMEIsYUFBYTtJQUVmO0lBRUEsTUFBTUUsVUFBVVYsSUFBSWdCLE9BQU8sQ0FBQyxFQUFFLEVBQUVDLFNBQVNQO0lBRXpDLElBQUlBLFNBQVM7UUFFWCxPQUFPQTtJQUVUO0lBSUEsTUFBTSxJQUFJakIsTUFBTTtBQUVsQiIsInNvdXJjZXMiOlsid2VicGFjazovLy8uL2xpYi9tb2RlbFByb3ZpZGVyLnRzPzQ4YmMiXSwic291cmNlc0NvbnRlbnQiOlsiXG5cbmltcG9ydCBPcGVuQUkgZnJvbSBcIm9wZW5haVwiO1xuXG5pbXBvcnQgQW50aHJvcGljIGZyb20gXCJAYW50aHJvcGljLWFpL3Nka1wiO1xuXG5leHBvcnQgdHlwZSBDaGF0UHJvdmlkZXIgPSBcIm9wZW5haVwiIHwgXCJhbnRocm9waWNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBDaGF0QXJncyB7XG5cbiAgc3lzdGVtOiBzdHJpbmc7XG5cbiAgdXNlcjogc3RyaW5nO1xuXG4gIG1heFRva2Vucz86IG51bWJlcjtcblxuICBmb3JjZVByb3ZpZGVyPzogQ2hhdFByb3ZpZGVyO1xuXG59XG5cbmNvbnN0IG9wZW5haSA9IG5ldyBPcGVuQUkoe1xuXG4gIGFwaUtleTogcHJvY2Vzcy5lbnYuT1BFTkFJX0FQSV9LRVlcblxufSk7XG5cbmNvbnN0IGFudGhyb3BpYyA9IG5ldyBBbnRocm9waWMoe1xuXG4gIGFwaUtleTogcHJvY2Vzcy5lbnYuQU5USFJPUElDX0FQSV9LRVkgfHwgXCJcIlxuXG59KTtcblxuLy8g0J7RgdC90L7QstC90LDRjyDQvdC+0LLQsNGPINGE0YPQvdC60YbQuNGPXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjaGF0V2l0aEFJKGFyZ3M6IENoYXRBcmdzKTogUHJvbWlzZTxzdHJpbmc+IHtcblxuICBjb25zdCBtYXhUb2tlbnMgPSBhcmdzLm1heFRva2VucyA/PyA0MDAwO1xuXG5cblxuICBpZiAoYXJncy5mb3JjZVByb3ZpZGVyID09PSBcIm9wZW5haVwiKSB7XG5cbiAgICByZXR1cm4gYXdhaXQgY2FsbE9wZW5BSShhcmdzLnN5c3RlbSwgYXJncy51c2VyLCBtYXhUb2tlbnMpO1xuXG4gIH1cblxuICBpZiAoYXJncy5mb3JjZVByb3ZpZGVyID09PSBcImFudGhyb3BpY1wiKSB7XG5cbiAgICByZXR1cm4gYXdhaXQgY2FsbEFudGhyb3BpYyhhcmdzLnN5c3RlbSwgYXJncy51c2VyLCBtYXhUb2tlbnMpO1xuXG4gIH1cblxuICAvLyDQodC90LDRh9Cw0LvQsCBDbGF1ZGUsINC30LDRgtC10LwgR1BUXG5cbiAgdHJ5IHtcblxuICAgIGNvbnNvbGUubG9nKFwi8J+kliBUcnlpbmcgQ2xhdWRlIGZpcnN0Li4uXCIpO1xuXG4gICAgY29uc3QgY2xhdWRlUmVzcG9uc2UgPSBhd2FpdCBjYWxsQW50aHJvcGljKGFyZ3Muc3lzdGVtLCBhcmdzLnVzZXIsIG1heFRva2Vucyk7XG5cbiAgICBpZiAoY2xhdWRlUmVzcG9uc2UgJiYgY2xhdWRlUmVzcG9uc2UudHJpbSgpLmxlbmd0aCA+IDApIHtcblxuICAgICAgY29uc29sZS5sb2coXCLinIUgQ2xhdWRlIHJlc3BvbmRlZCBzdWNjZXNzZnVsbHlcIik7XG5cbiAgICAgIHJldHVybiBjbGF1ZGVSZXNwb25zZTtcblxuICAgIH1cblxuICAgIHRocm93IG5ldyBFcnJvcihcIkNsYXVkZSByZXR1cm5lZCBlbXB0eSByZXNwb25zZVwiKTtcblxuICB9IGNhdGNoIChjbGF1ZGVFcnJvcikge1xuXG4gICAgY29uc29sZS5lcnJvcihcIuKaoO+4jyBDbGF1ZGUgZmFpbGVkOlwiLCBjbGF1ZGVFcnJvcik7XG5cbiAgICBjb25zb2xlLmxvZyhcIvCflIQgU3dpdGNoaW5nIHRvIEdQVCBhcyBmYWxsYmFjay4uLlwiKTtcblxuXG5cbiAgICB0cnkge1xuXG4gICAgICBjb25zdCBncHRSZXNwb25zZSA9IGF3YWl0IGNhbGxPcGVuQUkoYXJncy5zeXN0ZW0sIGFyZ3MudXNlciwgbWF4VG9rZW5zKTtcblxuICAgICAgY29uc29sZS5sb2coXCLinIUgR1BUIHJlc3BvbmRlZCBzdWNjZXNzZnVsbHlcIik7XG5cbiAgICAgIHJldHVybiBncHRSZXNwb25zZTtcblxuICAgIH0gY2F0Y2ggKGdwdEVycm9yKSB7XG5cbiAgICAgIGNvbnNvbGUuZXJyb3IoXCLinYwgQm90aCBwcm92aWRlcnMgZmFpbGVkXCIpO1xuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEJvdGggQUkgcHJvdmlkZXJzIGZhaWxlZC4gQ2xhdWRlOiAke2NsYXVkZUVycm9yfSwgR1BUOiAke2dwdEVycm9yfWApO1xuXG4gICAgfVxuXG4gIH1cblxufVxuXG4vLyDQntCx0YDQsNGC0L3QsNGPINGB0L7QstC80LXRgdGC0LjQvNC+0YHRgtGMINGB0L4g0YHRgtCw0YDRi9C8IEFQSVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2hhdFdpdGhQcm92aWRlcihcblxuICAgIHByb3ZpZGVyOiBDaGF0UHJvdmlkZXIsXG5cbiAgICBhcmdzOiBDaGF0QXJnc1xuXG4pOiBQcm9taXNlPHN0cmluZz4ge1xuXG4gIGNvbnNvbGUubG9nKGDimqDvuI8gY2hhdFdpdGhQcm92aWRlciBpcyBkZXByZWNhdGVkLCB1c2UgY2hhdFdpdGhBSSBpbnN0ZWFkYCk7XG5cblxuXG4gIC8vINCY0LPQvdC+0YDQuNGA0YPQtdC8INC/0LDRgNCw0LzQtdGC0YAgcHJvdmlkZXIsINCy0YHQtdCz0LTQsCDQuNGB0L/QvtC70YzQt9GD0LXQvCDQu9C+0LPQuNC60YMgQ2xhdWRlIOKGkiBHUFRcblxuICByZXR1cm4gYXdhaXQgY2hhdFdpdGhBSShhcmdzKTtcblxufVxuXG5hc3luYyBmdW5jdGlvbiBjYWxsQW50aHJvcGljKHN5c3RlbTogc3RyaW5nLCB1c2VyOiBzdHJpbmcsIG1heFRva2VuczogbnVtYmVyKTogUHJvbWlzZTxzdHJpbmc+IHtcblxuICBpZiAoIXByb2Nlc3MuZW52LkFOVEhST1BJQ19BUElfS0VZKSB7XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJBbnRocm9waWMgQVBJIGtleSBub3QgY29uZmlndXJlZFwiKTtcblxuICB9XG5cbiAgY29uc3QgcmVzID0gYXdhaXQgYW50aHJvcGljLm1lc3NhZ2VzLmNyZWF0ZSh7XG5cbiAgICBtb2RlbDogcHJvY2Vzcy5lbnYuQU5USFJPUElDX01PREVMIHx8IFwiY2xhdWRlLW9wdXMtNC0xLTIwMjUwODA1XCIsXG5cbiAgICBtYXhfdG9rZW5zOiBNYXRoLm1pbihtYXhUb2tlbnMsIDQwOTYpLFxuXG4gICAgdGVtcGVyYXR1cmU6IDAuMixcblxuICAgIHN5c3RlbTogc3lzdGVtLFxuXG4gICAgbWVzc2FnZXM6IFt7IHJvbGU6IFwidXNlclwiLCBjb250ZW50OiB1c2VyIH1dLFxuXG4gIH0pO1xuXG4gIGNvbnN0IGNvbnRlbnQgPSByZXMuY29udGVudD8uWzBdO1xuXG4gIGlmIChjb250ZW50ICYmIGNvbnRlbnQudHlwZSA9PT0gXCJ0ZXh0XCIgJiYgY29udGVudC50ZXh0KSB7XG5cbiAgICByZXR1cm4gY29udGVudC50ZXh0O1xuXG4gIH1cblxuXG5cbiAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCByZXNwb25zZSBmcm9tIEFudGhyb3BpY1wiKTtcblxufVxuXG5hc3luYyBmdW5jdGlvbiBjYWxsT3BlbkFJKHN5c3RlbTogc3RyaW5nLCB1c2VyOiBzdHJpbmcsIG1heFRva2VuczogbnVtYmVyKTogUHJvbWlzZTxzdHJpbmc+IHtcblxuICBpZiAoIXByb2Nlc3MuZW52Lk9QRU5BSV9BUElfS0VZKSB7XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJPcGVuQUkgQVBJIGtleSBub3QgY29uZmlndXJlZFwiKTtcblxuICB9XG5cbiAgY29uc3QgcmVzID0gYXdhaXQgb3BlbmFpLmNoYXQuY29tcGxldGlvbnMuY3JlYXRlKHtcblxuICAgIG1vZGVsOiBwcm9jZXNzLmVudi5PUEVOQUlfQ0hBVF9NT0RFTCB8fCBcImdwdC00LXR1cmJvLXByZXZpZXdcIixcblxuICAgIG1lc3NhZ2VzOiBbXG5cbiAgICAgIHsgcm9sZTogXCJzeXN0ZW1cIiwgY29udGVudDogc3lzdGVtIH0sXG5cbiAgICAgIHsgcm9sZTogXCJ1c2VyXCIsIGNvbnRlbnQ6IHVzZXIgfSxcblxuICAgIF0sXG5cbiAgICBtYXhfdG9rZW5zOiBtYXhUb2tlbnMsXG5cbiAgICB0ZW1wZXJhdHVyZTogMC4yLFxuXG4gIH0pO1xuXG4gIGNvbnN0IGNvbnRlbnQgPSByZXMuY2hvaWNlc1swXT8ubWVzc2FnZT8uY29udGVudDtcblxuICBpZiAoY29udGVudCkge1xuXG4gICAgcmV0dXJuIGNvbnRlbnQ7XG5cbiAgfVxuXG5cblxuICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHJlc3BvbnNlIGZyb20gT3BlbkFJXCIpO1xuXG59Il0sIm5hbWVzIjpbIk9wZW5BSSIsIkFudGhyb3BpYyIsIm9wZW5haSIsImFwaUtleSIsInByb2Nlc3MiLCJlbnYiLCJPUEVOQUlfQVBJX0tFWSIsImFudGhyb3BpYyIsIkFOVEhST1BJQ19BUElfS0VZIiwiY2hhdFdpdGhBSSIsImFyZ3MiLCJtYXhUb2tlbnMiLCJmb3JjZVByb3ZpZGVyIiwiY2FsbE9wZW5BSSIsInN5c3RlbSIsInVzZXIiLCJjYWxsQW50aHJvcGljIiwiY29uc29sZSIsImxvZyIsImNsYXVkZVJlc3BvbnNlIiwidHJpbSIsImxlbmd0aCIsIkVycm9yIiwiY2xhdWRlRXJyb3IiLCJlcnJvciIsImdwdFJlc3BvbnNlIiwiZ3B0RXJyb3IiLCJjaGF0V2l0aFByb3ZpZGVyIiwicHJvdmlkZXIiLCJyZXMiLCJtZXNzYWdlcyIsImNyZWF0ZSIsIm1vZGVsIiwiQU5USFJPUElDX01PREVMIiwibWF4X3Rva2VucyIsIk1hdGgiLCJtaW4iLCJ0ZW1wZXJhdHVyZSIsInJvbGUiLCJjb250ZW50IiwidHlwZSIsInRleHQiLCJjaGF0IiwiY29tcGxldGlvbnMiLCJPUEVOQUlfQ0hBVF9NT0RFTCIsImNob2ljZXMiLCJtZXNzYWdlIl0sImlnbm9yZUxpc3QiOltdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./lib/modelProvider.ts\n");

/***/ }),

/***/ "(rsc)/./lib/prompt.ts":
/*!***********************!*\
  !*** ./lib/prompt.ts ***!
  \***********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   SYSTEM_RAG: () => (/* binding */ SYSTEM_RAG),\n/* harmony export */   buildUserPrompt: () => (/* binding */ buildUserPrompt)\n/* harmony export */ });\nconst SYSTEM_RAG = `You are a helpful AI assistant analyzing documents for the user.\n\nSTRICT RAG MODE:\n- Answer ONLY using the provided context chunks from the user's documents\n- If the answer is not in the context or confidence is low, say: \"I don't have enough information in the provided documents to answer this question\"\n- Provide concise, actionable answers\n- If the user writes in Russian — reply in Russian; otherwise use English\n- Always return valid JSON with this exact structure:\n  {\n    \"answer\": \"your answer here\",\n    \"citations\": [\n      {\n        \"doc_id\": \"document-uuid\",\n        \"chunk_index\": 0,\n        \"similarity\": 0.85,\n        \"quote\": \"short verbatim excerpt from the chunk (max 200 chars)\"\n      }\n    ]\n  }\n\nFormatting rules:\n- No extra prose outside JSON\n- No markdown code fences\n- Just pure JSON object\n- \"quote\" must be actual text from the cited chunk, max 200 characters`;\nfunction buildUserPrompt(question, chunks) {\n    const compact = chunks.map((c, i)=>{\n        const text = c.text.replace(/\\s+/g, \" \").slice(0, 1500);\n        return `# Chunk ${i + 1} | doc:${c.doc_id.substring(0, 8)} | idx:${c.chunk_index} | sim:${c.similarity.toFixed(3)}\n${text}`;\n    }).join(\"\\n\\n\");\n    return `CONTEXT CHUNKS:\n${compact}\n\n---\n\nUSER QUESTION:\n${question}\n\nINSTRUCTIONS:\nReturn JSON as specified in system prompt. Use ONLY the information in the chunks above. If information is insufficient, clearly say so in the answer field.`;\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9saWIvcHJvbXB0LnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQU8sTUFBTUEsYUFBYSxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7c0VBd0IyQyxDQUFDLENBQUM7QUFTakUsU0FBU0MsZ0JBQWdCQyxRQUFnQixFQUFFQyxNQUFtQjtJQUNqRSxNQUFNQyxVQUFVRCxPQUFPRSxHQUFHLENBQUMsQ0FBQ0MsR0FBR0M7UUFDM0IsTUFBTUMsT0FBT0YsRUFBRUUsSUFBSSxDQUFDQyxPQUFPLENBQUMsUUFBUSxLQUFLQyxLQUFLLENBQUMsR0FBRztRQUNsRCxPQUFPLENBQUMsUUFBUSxFQUFFSCxJQUFJLEVBQUUsT0FBTyxFQUFFRCxFQUFFSyxNQUFNLENBQUNDLFNBQVMsQ0FBQyxHQUFHLEdBQUcsT0FBTyxFQUFFTixFQUFFTyxXQUFXLENBQUMsT0FBTyxFQUFFUCxFQUFFUSxVQUFVLENBQUNDLE9BQU8sQ0FBQyxHQUFHO0FBQzFILEVBQUVQLE1BQU07SUFDSixHQUFHUSxJQUFJLENBQUM7SUFFUixPQUFPLENBQUM7QUFDWixFQUFFWixRQUFROzs7OztBQUtWLEVBQUVGLFNBQVM7Ozs0SkFHaUosQ0FBQztBQUM3SiIsInNvdXJjZXMiOlsid2VicGFjazovLy8uL2xpYi9wcm9tcHQudHM/Yzk5OSJdLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgY29uc3QgU1lTVEVNX1JBRyA9IGBZb3UgYXJlIGEgaGVscGZ1bCBBSSBhc3Npc3RhbnQgYW5hbHl6aW5nIGRvY3VtZW50cyBmb3IgdGhlIHVzZXIuXG5cblNUUklDVCBSQUcgTU9ERTpcbi0gQW5zd2VyIE9OTFkgdXNpbmcgdGhlIHByb3ZpZGVkIGNvbnRleHQgY2h1bmtzIGZyb20gdGhlIHVzZXIncyBkb2N1bWVudHNcbi0gSWYgdGhlIGFuc3dlciBpcyBub3QgaW4gdGhlIGNvbnRleHQgb3IgY29uZmlkZW5jZSBpcyBsb3csIHNheTogXCJJIGRvbid0IGhhdmUgZW5vdWdoIGluZm9ybWF0aW9uIGluIHRoZSBwcm92aWRlZCBkb2N1bWVudHMgdG8gYW5zd2VyIHRoaXMgcXVlc3Rpb25cIlxuLSBQcm92aWRlIGNvbmNpc2UsIGFjdGlvbmFibGUgYW5zd2Vyc1xuLSBJZiB0aGUgdXNlciB3cml0ZXMgaW4gUnVzc2lhbiDigJQgcmVwbHkgaW4gUnVzc2lhbjsgb3RoZXJ3aXNlIHVzZSBFbmdsaXNoXG4tIEFsd2F5cyByZXR1cm4gdmFsaWQgSlNPTiB3aXRoIHRoaXMgZXhhY3Qgc3RydWN0dXJlOlxuICB7XG4gICAgXCJhbnN3ZXJcIjogXCJ5b3VyIGFuc3dlciBoZXJlXCIsXG4gICAgXCJjaXRhdGlvbnNcIjogW1xuICAgICAge1xuICAgICAgICBcImRvY19pZFwiOiBcImRvY3VtZW50LXV1aWRcIixcbiAgICAgICAgXCJjaHVua19pbmRleFwiOiAwLFxuICAgICAgICBcInNpbWlsYXJpdHlcIjogMC44NSxcbiAgICAgICAgXCJxdW90ZVwiOiBcInNob3J0IHZlcmJhdGltIGV4Y2VycHQgZnJvbSB0aGUgY2h1bmsgKG1heCAyMDAgY2hhcnMpXCJcbiAgICAgIH1cbiAgICBdXG4gIH1cblxuRm9ybWF0dGluZyBydWxlczpcbi0gTm8gZXh0cmEgcHJvc2Ugb3V0c2lkZSBKU09OXG4tIE5vIG1hcmtkb3duIGNvZGUgZmVuY2VzXG4tIEp1c3QgcHVyZSBKU09OIG9iamVjdFxuLSBcInF1b3RlXCIgbXVzdCBiZSBhY3R1YWwgdGV4dCBmcm9tIHRoZSBjaXRlZCBjaHVuaywgbWF4IDIwMCBjaGFyYWN0ZXJzYDtcblxuaW50ZXJmYWNlIENodW5rRGF0YSB7XG4gICAgZG9jX2lkOiBzdHJpbmc7XG4gICAgY2h1bmtfaW5kZXg6IG51bWJlcjtcbiAgICBzaW1pbGFyaXR5OiBudW1iZXI7XG4gICAgdGV4dDogc3RyaW5nO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRVc2VyUHJvbXB0KHF1ZXN0aW9uOiBzdHJpbmcsIGNodW5rczogQ2h1bmtEYXRhW10pOiBzdHJpbmcge1xuICAgIGNvbnN0IGNvbXBhY3QgPSBjaHVua3MubWFwKChjLCBpKSA9PiB7XG4gICAgICAgIGNvbnN0IHRleHQgPSBjLnRleHQucmVwbGFjZSgvXFxzKy9nLCBcIiBcIikuc2xpY2UoMCwgMTUwMCk7XG4gICAgICAgIHJldHVybiBgIyBDaHVuayAke2kgKyAxfSB8IGRvYzoke2MuZG9jX2lkLnN1YnN0cmluZygwLCA4KX0gfCBpZHg6JHtjLmNodW5rX2luZGV4fSB8IHNpbToke2Muc2ltaWxhcml0eS50b0ZpeGVkKDMpfVxuJHt0ZXh0fWA7XG4gICAgfSkuam9pbihcIlxcblxcblwiKTtcblxuICAgIHJldHVybiBgQ09OVEVYVCBDSFVOS1M6XG4ke2NvbXBhY3R9XG5cbi0tLVxuXG5VU0VSIFFVRVNUSU9OOlxuJHtxdWVzdGlvbn1cblxuSU5TVFJVQ1RJT05TOlxuUmV0dXJuIEpTT04gYXMgc3BlY2lmaWVkIGluIHN5c3RlbSBwcm9tcHQuIFVzZSBPTkxZIHRoZSBpbmZvcm1hdGlvbiBpbiB0aGUgY2h1bmtzIGFib3ZlLiBJZiBpbmZvcm1hdGlvbiBpcyBpbnN1ZmZpY2llbnQsIGNsZWFybHkgc2F5IHNvIGluIHRoZSBhbnN3ZXIgZmllbGQuYDtcbn0iXSwibmFtZXMiOlsiU1lTVEVNX1JBRyIsImJ1aWxkVXNlclByb21wdCIsInF1ZXN0aW9uIiwiY2h1bmtzIiwiY29tcGFjdCIsIm1hcCIsImMiLCJpIiwidGV4dCIsInJlcGxhY2UiLCJzbGljZSIsImRvY19pZCIsInN1YnN0cmluZyIsImNodW5rX2luZGV4Iiwic2ltaWxhcml0eSIsInRvRml4ZWQiLCJqb2luIl0sImlnbm9yZUxpc3QiOltdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./lib/prompt.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next","vendor-chunks/@supabase","vendor-chunks/tr46","vendor-chunks/whatwg-url","vendor-chunks/formdata-node","vendor-chunks/webidl-conversions","vendor-chunks/openai","vendor-chunks/web-streams-polyfill","vendor-chunks/node-fetch","vendor-chunks/event-target-shim","vendor-chunks/agentkeepalive","vendor-chunks/form-data-encoder","vendor-chunks/abort-controller","vendor-chunks/ms","vendor-chunks/humanize-ms","vendor-chunks/@anthropic-ai"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fask%2Froute&page=%2Fapi%2Fask%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fask%2Froute.ts&appDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Falex%2FWebstormProjects%2Fpersonal-rag-agent&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();